// ==UserScript==
// @name          微博增强
// @namespace     http://tampermonkey.net/
// @version       1.0.4
// @description   微博增强功能：自动适应深色/浅色模式，弹出页查看更多评论，页面宽屏显示，UI高斯模糊效果
// @author        xzy-nine
// @match         https://*.weibo.com/*
// @grant         GM_setValue
// @grant         GM_getValue
// @grant         GM_deleteValue
// @grant         GM_registerMenuCommand
// @grant         GM_addStyle
// @grant         GM_xmlhttpRequest
// @grant         GM_getResourceURL
// @grant         GM_openInTab
// @grant         unsafeWindow
// @run_at        document-start
// @updateURL     https://gh-proxy.com/https://raw.githubusercontent.com/xzy-nine/youhou/main/weibo-up/dist/weibo-up.user.js
// @downloadURL   https://gh-proxy.com/https://raw.githubusercontent.com/xzy-nine/youhou/main/weibo-up/dist/weibo-up.user.js
// @supportURL    https://github.com/xzy-nine/youhou/issues
// @homepageURL   https://github.com/xzy-nine/youhou
// ==/UserScript==
(()=>{"use strict";const e={enabled:GM_getValue("widescreen_enabled",!0),loose:GM_getValue("widescreen_loose",!1),notify_enabled:GM_getValue("widescreen_notify_enabled",!1),ui_visible:GM_getValue("widescreen_ui_visible",!0),panel_expanded:GM_getValue("widescreen_panel_expanded",!0),panel_position:GM_getValue("widescreen_panel_position",null)},n={enabled:GM_getValue("blur_enabled",!1),intensity:GM_getValue("blur_intensity",5),notify_enabled:GM_getValue("blur_notify_enabled",!0),background_enabled:GM_getValue("blur_background_enabled",!1),background_type:GM_getValue("blur_background_type","bing"),background_url:GM_getValue("blur_background_url",""),background_opacity:GM_getValue("blur_background_opacity",.2)};function t(){GM_setValue("widescreen_enabled",e.enabled),GM_setValue("widescreen_loose",e.loose),GM_setValue("widescreen_notify_enabled",e.notify_enabled),GM_setValue("widescreen_ui_visible",e.ui_visible),GM_setValue("widescreen_panel_expanded",e.panel_expanded),GM_setValue("widescreen_panel_position",e.panel_position)}function o(){GM_setValue("blur_enabled",n.enabled),GM_setValue("blur_intensity",n.intensity),GM_setValue("blur_notify_enabled",n.notify_enabled),GM_setValue("blur_background_enabled",n.background_enabled),GM_setValue("blur_background_type",n.background_type),GM_setValue("blur_background_url",n.background_url),GM_setValue("blur_background_opacity",n.background_opacity)}let a=GM_getValue("userOverride",!1);function r(e,n=null){a=e,GM_setValue("userOverride",e),null!==n&&GM_setValue("userThemeMode",n)}const i="\n/* 新版微博宽屏样式 */\n@media screen and (min-width: 1340px) {\n    :root {\n        --inject-page-width: min(90vw, 1380px);\n    }\n    \n    .inject-widescreen-loose-js {\n        --inject-page-width: 90vw;\n    }\n    \n    /* 新版微博主要布局 */\n    [class*=Frame_content] {\n        --main-width: var(--inject-page-width);\n        width: var(--inject-page-width);\n    }\n    \n    [class*=Frame_content] > div:nth-of-type(2) {\n        flex: 1;\n    }\n    \n    [class*=Frame_main],\n    [class*=Main_full] {\n        flex-grow: 1;\n    }\n    \n    /* 微博内容区域优化 */\n    .woo-box-wrap[class*=picture_inlineNum3] {\n        max-width: 409px;\n    }\n    \n    .u-col-4.woo-box-wrap {\n        max-width: 546px;\n    }\n    \n    [class*=content_row] [class*=card-video_videoBox] {\n        max-width: 540px;\n    }\n    \n    [class*=content_row] [class*=card-article_pic] {\n        max-width: 540px;\n    }\n    \n    [class*=ProfileHeader_pic] {\n        overflow: hidden;\n    }\n    \n    /* 返回顶部按钮 */\n    [class*=Index_backTop] {\n        left: calc(50% + var(--inject-page-width)/2 + var(--frame-mod-gap-space));\n        margin-left: 0;\n        transform: translateX(0);\n    }\n}\n\n/* 视频详情页宽屏样式 */\n@media screen and (min-width: 1450px) {\n    [class*=Frame_content2] {\n        max-width: none;\n        width: var(--inject-page-width);\n    }\n    \n    [class*=Frame_main2] {\n        flex-grow: 1;\n        padding-right: 20px;\n    }\n}\n\n/* 旧版微博宽屏样式 - 兼容支持 */\n@media screen and (min-width: 1300px) {\n    :root {\n        --inject-page-width-legacy: min(75vw, 1330px);\n    }\n    \n    /* 旧版微博主页 */\n    .WB_frame {\n        display: flex;\n        width: var(--inject-page-width-legacy) !important;\n    }\n    \n    .WB_frame #plc_main {\n        display: flex !important;\n        flex: 1;\n        width: auto !important;\n    }\n    \n    .WB_main_c {\n        flex: 1;\n    }\n    \n    .WB_frame_c {\n        flex: 1;\n    }\n    \n    /* 微博类型标签 */\n    .tab_box {\n        display: flex;\n    }\n    \n    .tab_box::after {\n        content: none;\n    }\n    \n    .tab_box .fr_box {\n        flex: 1;\n    }\n    \n    /* 返回顶部按钮 */\n    .W_gotop {\n        left: calc(50% + (var(--inject-page-width-legacy) / 2));\n        margin-left: 0 !important;\n    }\n    \n    /* 微博时间线 */\n    .WB_timeline {\n        left: calc(50% + (var(--inject-page-width-legacy) / 2) + 10px);\n        margin-left: 0;\n    }\n}\n\n/* 微博文章页宽屏样式 */\n@media screen and (min-width: 1150px) {\n    #articleRoot .WB_frame {\n        width: var(--inject-page-width-legacy);\n    }\n    \n    #articleRoot #plc_main {\n        max-width: 100%;\n        width: auto;\n    }\n    \n    #articleRoot .WB_frame_a,\n    #articleRoot .WB_artical {\n        max-width: 100%;\n        width: auto;\n    }\n    \n    #articleRoot .main_toppic {\n        margin-left: auto;\n        margin-right: auto;\n    }\n    \n    #articleRoot .WB_editor_iframe_new {\n        width: auto;\n    }\n    \n    .B_artical [node-type=sidebar]>.W_gotop {\n        left: calc(50% + var(--inject-page-width-legacy)/2);\n        margin-left: 0;\n    }\n}",c="\n/* 用户自定义宽度设置 - 更宽模式 */\n@media screen and (min-width: 1340px) {\n  :root.inject-widescreen-loose-js {\n    --inject-page-width: 95vw !important;\n  }\n  \n  body.inject-widescreen-loose-js {\n    --inject-page-width: 95vw !important;\n  }\n  \n  /* 更宽模式下的特殊调整 */\n  .inject-widescreen-loose-js [class*=Frame_content],\n  .inject-widescreen-loose-js [class*=Frame_content2] {\n    width: var(--inject-page-width) !important;\n    max-width: var(--inject-page-width) !important;\n  }\n  \n  /* 确保返回顶部按钮位置正确 */\n  .inject-widescreen-loose-js [class*=Index_backTop] {\n    left: calc(50% + var(--inject-page-width)/2 + 10px);\n  }\n}\n\n/* 旧版微博更宽模式 */\n@media screen and (min-width: 1300px) {\n  :root.inject-widescreen-loose-js {\n    --inject-page-width-legacy: 95vw !important;\n  }\n  \n  body.inject-widescreen-loose-js {\n    --inject-page-width-legacy: 95vw !important;\n  }\n  \n  .inject-widescreen-loose-js .WB_frame {\n    width: var(--inject-page-width-legacy) !important;\n  }\n  \n  .inject-widescreen-loose-js .W_gotop {\n    left: calc(50% + var(--inject-page-width-legacy)/2 + 10px);\n  }\n  \n  .inject-widescreen-loose-js .WB_timeline {\n    left: calc(50% + var(--inject-page-width-legacy)/2 + 20px);\n  }\n}\n";function l(n){if(!e.notify_enabled)return;console.log(`%c[微博增强] ${n}`,"color: #1890ff; font-weight: bold;");const t=document.createElement("div");t.style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background-color: rgba(255, 255, 255, 0.95);\n    color: #333;\n    padding: 10px 15px;\n    border-radius: 8px;\n    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);\n    z-index: 9999;\n    font-size: 14px;\n    transition: all 0.3s ease;\n    opacity: 0;\n    transform: translateY(-20px);\n  ";(document.documentElement.classList.contains("woo-theme-dark")||document.body.classList.contains("woo-theme-dark"))&&(t.style.backgroundColor="rgba(40, 40, 40, 0.95)",t.style.color="#ddd"),t.textContent=n,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="1",t.style.transform="translateY(0)"},10),setTimeout(()=>{t.style.opacity="0",t.style.transform="translateY(-20px)",setTimeout(()=>{document.body.removeChild(t)},300)},3e3)}function s(){if(!e.enabled)return;const n=document.getElementById("weibo-widescreen-style");if(!n||!n.textContent.includes("--inject-page-width"))return console.log("[微博宽屏] 检测到样式缺失，重新应用样式"),void d(!0);const t=document.documentElement.classList.contains("inject-widescreen-loose-js");e.loose&&!t?(console.log("[微博宽屏] 检测到宽松模式类缺失，重新应用样式"),document.documentElement.classList.add("inject-widescreen-loose-js"),document.body.classList.add("inject-widescreen-loose-js")):!e.loose&&t&&(console.log("[微博宽屏] 检测到不需要宽松模式类，移除"),document.documentElement.classList.remove("inject-widescreen-loose-js"),document.body.classList.remove("inject-widescreen-loose-js"))}function d(n=!1){if(!e.enabled)return void console.log("[微博宽屏] 宽屏功能未启用");const t="weibo-widescreen-style";let o=document.getElementById(t);if(o||(o=document.createElement("style"),o.id=t,document.head.appendChild(o)),o.textContent=i,e.loose){document.documentElement.classList.add("inject-widescreen-loose-js"),document.body.classList.add("inject-widescreen-loose-js");const e="weibo-widescreen-loose-style";let n=document.getElementById(e);n||(n=document.createElement("style"),n.id=e,document.head.appendChild(n)),n.textContent=c}else{document.documentElement.classList.remove("inject-widescreen-loose-js"),document.body.classList.remove("inject-widescreen-loose-js");const e=document.getElementById("weibo-widescreen-loose-style");e&&e.remove()}if(null!==document.querySelector(".woo-box-flex")||null!==document.querySelector('[class*="Frame_wrap"]')||null!==document.querySelector('[class*="Home_wrap"]')){const e=u();e?g(e):setTimeout(()=>{const e=u();e&&g(e)},1e3)}else!function(){if(!e.enabled)return;console.log("[微博宽屏] 检测到旧版微博，正在配置宽屏样式");let n=null,t=null;const o="inject-ws-",a=e=>`${o}${e}`,r=()=>{const{$CONFIG:e}=window;if(!e||!e.location)return;t&&(t.remove(),t=null),[...document.body.classList.values()].forEach(e=>{e.startsWith(o)&&document.body.classList.remove(e)});const n={mainpage:{test:/^v6.*_content_home$/.test(e.location)||/v6_(fav|likes_outbox|content_friends)/.test(e.location),styles:b},profilepage:{test:/^page_.*_(home|photos|manage|myfollow|service|expert|topic)$/.test(e.location),styles:m},singleweibo:{test:/^page_.*_single_weibo$/.test(e.location),styles:p}},r=Object.entries(n).find(([,{test:e}])=>e);if(r){const[e,{styles:n}]=r,o=a(e);document.body.classList.add(o),t=document.createElement("style"),t.textContent=n(o),document.head.appendChild(t),console.log(`[微博宽屏] 应用旧版微博${e}页面宽屏样式`)}};window.$CONFIG&&!n&&(n=new Proxy(window.$CONFIG,{set(e,n,t,o){const a=e[n],i=Reflect.set(e,n,t,o);return"location"===n&&t!==a&&(console.log("[微博宽屏] 页面位置变化，重新应用样式"),setTimeout(r,100)),i}}),window.$CONFIG=n);r(),document.addEventListener("readystatechange",()=>{window.$CONFIG&&r()}),"loading"!==document.readyState&&window.$CONFIG&&r()}();e.loose&&(document.documentElement.classList.add("inject-widescreen-loose-js"),document.body.classList.add("inject-widescreen-loose-js")),document.addEventListener("load",function(n){if("IFRAME"===n.target.tagName)try{const t=n.target.contentDocument||n.target.contentWindow.document;if(t&&t.head){const n=t.createElement("style");if(n.id="widescreen-style",n.textContent=i,t.head.appendChild(n),e.loose){const e=t.createElement("style");e.id="weibo-widescreen-loose-style",e.textContent=c,t.head.appendChild(e),t.documentElement.classList.add("inject-widescreen-loose-js"),t.body&&t.body.classList.add("inject-widescreen-loose-js")}}}catch(e){console.log("无法访问iframe内容（可能是跨域）")}},!0),setInterval(()=>{document.querySelectorAll("iframe").forEach(n=>{try{const t=n.contentDocument||n.contentWindow.document;if(t&&t.head){if(!t.querySelector("#widescreen-style")){const e=t.createElement("style");e.id="widescreen-style",e.textContent=i,t.head.appendChild(e)}const n=!!t.querySelector("#weibo-widescreen-loose-style"),o=t.documentElement.classList.contains("inject-widescreen-loose-js");if(e.loose&&!n){const e=t.createElement("style");e.id="weibo-widescreen-loose-style",e.textContent=c,t.head.appendChild(e)}else if(!e.loose&&n){const e=t.querySelector("#weibo-widescreen-loose-style");e&&e.remove()}e.loose&&!o?(t.documentElement.classList.add("inject-widescreen-loose-js"),t.body&&t.body.classList.add("inject-widescreen-loose-js")):!e.loose&&o&&(t.documentElement.classList.remove("inject-widescreen-loose-js"),t.body&&t.body.classList.remove("inject-widescreen-loose-js"))}}catch(e){}})},2e3),console.log("[微博宽屏] 宽屏样式已"+(n?"更新":"应用")),setTimeout(s,2e3)}function u(){let e=null;return(e=>{const n=()=>{let t=null;const o=document.querySelectorAll("*");for(const e of o)if(e.__vue__&&e.__vue__.$router){t=e.__vue__;break}t?e(t):setTimeout(n,100)};n()})(n=>{e=n}),e}function b(e){return`\n    .${e} .WB_frame {\n      display: flex;\n      width: var(--inject-page-width-legacy) !important;\n    }\n    .${e} #plc_main {\n      display: flex !important;\n      flex: 1;\n      width: auto !important;\n    }\n    .${e} .WB_main_c {\n      flex: 1;\n    }\n    .${e} .tab_box {\n      display: flex;\n    }\n    .${e} .tab_box::after {\n      content: none;\n    }\n    .${e} .tab_box .fr_box {\n      flex: 1;\n    }\n    .${e} .W_gotop {\n      left: calc(50% + (var(--inject-page-width-legacy) / 2));\n      margin-left: 0 !important;\n    }\n  `}function m(e){return`\n    .${e} .WB_frame {\n      width: var(--inject-page-width-legacy) !important;\n    }\n    .${e} .WB_frame_a, \n    .${e} .WB_frame_a_fix {\n      width: 100%;\n    }\n    .${e} #plc_main {\n      width: 100% !important;\n      display: flex;\n    }\n    .${e} #plc_main > div:last-child {\n      margin-right: 0;\n    }\n    .${e} .WB_frame_c .input_simple_wrap .inputfunc_simple_wrap {\n      width: calc(100% - 80px);\n    }\n    .${e} .WB_frame_c {\n      flex: 1;\n    }\n    .${e} .WB_timeline {\n      left: calc(50% + (var(--inject-page-width-legacy) / 2) + 10px);\n      margin-left: 0;\n    }\n    .${e} .W_gotop {\n      left: calc(50% + (var(--inject-page-width-legacy) / 2));\n      margin-left: 0 !important;\n    }\n  `}function p(e){return`\n    .${e} .WB_frame {\n      width: var(--inject-page-width-legacy) !important;\n    }\n    .${e} #plc_main {\n      display: flex !important;\n      width: auto !important;\n    }\n    .${e} #plc_main .WB_frame_c {\n      flex: 1;\n    }    .${e} .W_gotop {\n      left: calc(50% + (var(--inject-page-width-legacy) / 2) - 19px);\n      margin-left: 0 !important;\n    }\n  `}function g(n){if(console.log("[微博宽屏] 设置新版微博宽屏样式"),!e.enabled||!n)return;const t=new Map([[["home","mygroups","profile","nameProfile","customProfile","bidDetail","atWeibo","cmtInbox","likeInbox","follow","myFollowTab","fav","like","weibo","list","topic","search","searchResult"],"home"],[["Playdetail"],"video"]]),o=n=>{if(!e.enabled)return;const t=document.getElementById("weibo-widescreen-style");if(!t||!t.textContent){const e=document.createElement("style");e.id="weibo-widescreen-style",e.textContent=i,document.head.appendChild(e)}if(e.loose){document.documentElement.classList.add("inject-widescreen-loose-js"),document.body.classList.add("inject-widescreen-loose-js");let e=document.getElementById("weibo-widescreen-loose-style");e||(e=document.createElement("style"),e.id="weibo-widescreen-loose-style",e.textContent=c,document.head.appendChild(e))}console.log(`[微博宽屏] 应用新版微博${n}页面宽屏样式`),e.notify_enabled&&l("微博宽屏模式已启用"),document.dispatchEvent(new CustomEvent("widescreenStyleApplied",{detail:{pageType:n,isLoose:e.loose}}))};if(n.$router){n.$router.afterEach(e=>{console.log("[微博宽屏] 路由变化:",e.name);for(const[n,a]of t.entries())if(n.includes(e.name)){o(a);break}});const e=n.$route;if(e){for(const[n,a]of t.entries())if(n.includes(e.name)){o(a);break}}else o("home")}else o("home")}let f=null,h=null,y=!1,w=!1;function v(){const e=window.matchMedia("(prefers-color-scheme: dark)").matches;GM_setValue("lastSystemMode",e);const n=GM_getValue("userThemeMode",null);setTimeout(()=>{if(a){const e=null!==n?n:x();console.log(`用户手动设置为${e?"深色":"浅色"}模式，保持不变`),_(e,!1),f=e}else{const e=window.matchMedia("(prefers-color-scheme: dark)").matches,n=x();console.log("[微博主题] 跟随系统模式: "+(e?"深色":"浅色")),n!==e&&_(e,!1),f=e}h=a},500),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",n=>{const t=n.matches;GM_getValue("lastSystemMode",e);GM_setValue("lastSystemMode",t),console.log("[微博主题] 系统模式变化: "+(t?"深色":"浅色")),a||(_(t,!1),f!==t&&(l(`已切换到${t?"深色":"浅色"}模式`),f=t))}),function(){const e=localStorage.setItem;localStorage.setItem=function(n,t){const o=e.apply(this,arguments);if(("darkModeHistory"===n||"weiboThemeMode"===n)&&!w)try{let e=!1;if("darkModeHistory"===n)try{const n=JSON.parse(t);n&&n.length>0&&n[0].length>1&&(e=1===n[0][1])}catch(e){console.error("[微博主题] 无法解析主题设置:",e)}else"weiboThemeMode"===n&&(e="dark"===t);x()!==e&&(console.log(`[微博主题] 检测到用户手动切换为${e?"深色":"浅色"}模式`),a=!0,r(!0,e),k(e),!0===h&&f===e&&y||(l(`已手动切换为${e?"深色":"浅色"}模式`),f=e,h=!0,y=!0))}catch(e){console.error(`[微博主题] 解析${n}时出错:`,e)}return o},window.addEventListener("storage",e=>{if(!w&&"darkModeHistory"===e.key)try{const n=e.newValue;if(n){const e=JSON.parse(n);if(e&&e.length>0&&e[0].length>1){const n=1===e[0][1];console.log("[微博主题] 检测到用户通过微博界面切换主题: "+(n?"深色":"浅色")),a=!0,r(!0,n),k(n),f===n&&!0===h||(l(`已切换为${n?"深色":"浅色"}模式`),f=n,h=!0)}}}catch(e){console.error("[微博主题] 处理localStorage事件时出错:",e)}})}()}function x(){try{const e=localStorage.getItem("darkModeHistory");if(e){const n=JSON.parse(e);if(n&&n.length>0&&n[0].length>1)return 1===n[0][1]}}catch(e){}return!!document.body&&document.body.classList.contains("woo-theme-dark")}function _(e,n=!1){try{w=!0;const t=function(){let e=null;try{const n=localStorage.getItem("darkModeHistory");if(n){const t=JSON.parse(n);t&&t.length>0&&t[0].length>0&&(e=t[0][0])}}catch(e){console.error("解析darkModeHistory失败:",e)}if(!e){const n=document.documentElement.outerHTML.match(/uid=(\d+)/);n&&n[1]&&(e=parseInt(n[1],10))}return e||0}(),o=e?1:0;localStorage.setItem("darkModeHistory",`[[${t},${o}]]`);const a=()=>{if(document.body){document.body.classList.remove("woo-theme-dark","woo-theme-light"),e?(document.body.classList.add("woo-theme-dark"),document.documentElement.setAttribute("data-theme","dark")):(document.body.classList.add("woo-theme-light"),document.documentElement.setAttribute("data-theme","light")),console.log(`[微博主题] 已设置为${e?"深色":"浅色"}模式`),k(e);try{const n=new CustomEvent("themechange",{detail:{theme:e?"dark":"light"}});window.dispatchEvent(n)}catch(e){}}else setTimeout(a,100)};return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",a):a(),n||(w=!1),!0}catch(e){return w=!1,console.error("[微博主题] 设置主题模式时出错:",e),!1}}function k(e){document.querySelectorAll(".comment-modal").forEach(n=>{n.setAttribute("data-theme",e?"dark":"light");const t=n.querySelector(".comment-modal-iframe");if(t)try{const n=t.contentDocument||t.contentWindow.document;n&&n.body&&(n.body.classList.remove("woo-theme-dark","woo-theme-light"),n.body.classList.add(e?"woo-theme-dark":"woo-theme-light"))}catch(e){console.log("[微博主题] 无法更新iframe主题（可能是跨域）:",e)}})}const E="\n.comment-modal-overlay {\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.3);\n    z-index: 10000;\n    display: flex;\n    justify-content: flex-start;\n    align-items: center;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n.comment-modal-overlay.show {\n    opacity: 1;\n}\n\n/* 右侧点击区域提示 */\n.comment-modal-overlay::after {\n    content: '';\n    position: absolute;\n    top: 0;\n    right: 0;\n    width: 100px;\n    height: 100%;\n    background: linear-gradient(to left, rgba(0, 0, 0, 0.1), transparent);\n    pointer-events: none;\n    transition: background 0.2s ease;\n}\n\n.comment-modal-overlay:hover::after {\n    background: linear-gradient(to left, rgba(0, 0, 0, 0.2), transparent);\n}\n\n.comment-modal {\n    background: var(--bg-color, #ffffff);\n    border-radius: 0 45px 45px 0;\n    box-shadow: 2px 0 40px rgba(0, 0, 0, 0.15);\n    max-width: calc(100% - 100px);\n    height: calc(100vh - 40px);\n    width: calc(100% - 100px);\n    margin: 20px 100px 20px 0;\n    position: relative;\n    overflow: hidden;\n    transform: translateX(-100%);\n    transition: transform 0.3s ease;\n}\n\n.comment-modal-overlay.show .comment-modal {\n    transform: translateX(0);\n}\n\n.comment-modal-header {\n    padding: 12px 20px;\n    border-bottom: 1px solid var(--border-color, #e1e8ed);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    background: var(--header-bg, #f7f9fa);\n    border-radius: 0 45px 0 0;\n    min-height: 40px;\n}\n\n.comment-modal-title {\n    font-size: 14px;\n    font-weight: bold;\n    color: var(--text-color, #14171a);\n}\n\n.comment-modal-close {\n    width: 28px;\n    height: 28px;\n    border: none;\n    background: none;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 50%;\n    transition: background-color 0.2s;\n}\n\n.comment-modal-close:hover {\n    background-color: var(--hover-bg, #f0f0f0);\n}\n\n.comment-modal-close::before {\n    content: '×';\n    font-size: 20px;\n    color: var(--text-color, #657786);\n}\n\n.comment-modal-content {\n    padding: 0;\n    height: calc(100vh - 100px);\n    overflow: hidden;\n    position: relative;\n}\n\n.comment-modal-iframe {\n    width: 100%;\n    height: 100%;\n    border: none;\n    background: var(--bg-color, #ffffff);\n}\n\n.comment-modal-loading {\n    padding: 40px;\n    text-align: center;\n    color: var(--text-color, #657786);\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: var(--bg-color, #ffffff);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 1;\n}\n\n/* 深色模式样式 */\nbody.woo-theme-dark .comment-modal,\n.comment-modal[data-theme=\"dark\"] {\n    --bg-color: #1d1f23;\n    --border-color: #38444d;\n    --header-bg: #15181c;\n    --text-color: #ffffff;\n    --hover-bg: #273340;\n}\n\n/* 浅色模式样式 */\nbody.woo-theme-light .comment-modal,\n.comment-modal[data-theme=\"light\"] {\n    --bg-color: #ffffff;\n    --border-color: #e1e8ed;\n    --header-bg: #f7f9fa;\n    --text-color: #14171a;\n    --hover-bg: #f0f0f0;\n}\n\n/* 滚动条样式 */\n.comment-modal-content::-webkit-scrollbar {\n    width: 6px;\n}\n\n.comment-modal-content::-webkit-scrollbar-track {\n    background: transparent;\n}\n\n.comment-modal-content::-webkit-scrollbar-thumb {\n    background: var(--border-color, #e1e8ed);\n    border-radius: 3px;\n}\n\n.comment-modal-content::-webkit-scrollbar-thumb:hover {\n    background: var(--text-color, #657786);\n}\n";function L(){!function(){const e=document.createElement("style");e.textContent=E,document.head.appendChild(e)}(),document.addEventListener("click",function(n){const t=n.target.closest("a[href]");if(!t)return;const o=t.textContent||t.innerText||"";let a=t.getAttribute("href");if(a&&"#"!==a&&!a.startsWith("javascript:")&&(console.log("检测到链接点击:",{target:t,linkText:o.trim(),href:a,className:t.className}),o.includes("查看全部")&&o.includes("评论")||/查看全部\s*\d+\s*条?评论/.test(o)||/^\s*\d+\s*条?评论?\s*$/.test(o)&&(a.includes("/status/")||a.includes("/detail/")))){if(console.log("拦截查看全部评论链接:",o.trim()),n.preventDefault(),n.stopPropagation(),!a){const e=t.closest("article");if(e){const n=e.querySelector('a[href*="/status/"], a[href*="/detail/"], a[href*="/u/"]');if(n&&(a=n.getAttribute("href")),!a){const n=e.querySelector("[data-mid], [mid]");if(n){const e=n.getAttribute("data-mid")||n.getAttribute("mid");e&&(a=`/detail/${e}`)}}if(!a){const n=e.querySelector("[data-itemid], [data-id]");if(n){const e=n.getAttribute("data-itemid")||n.getAttribute("data-id");e&&(a=`/detail/${e}`)}}}}if(!a){const e=document.querySelectorAll('a[href*="/status/"], a[href*="/detail/"]');if(e.length>0){const n=Array.from(e).find(e=>{const n=e.getBoundingClientRect(),o=t.getBoundingClientRect();return Math.abs(n.top-o.top)<200});n&&(a=n.getAttribute("href"))}}if(!a){const e=window.location.href;if(e.includes("/status/"))a=e;else if(e.includes("/detail/"))a=e;else if(e.includes("/u/")){const e=document.querySelector('a[href*="/status/"], a[href*="/detail/"]');e&&(a=e.getAttribute("href"))}}if(!a){const e=document.querySelectorAll("script");for(const n of e){const e=n.textContent||n.innerText,t=e.match(/"mid":\s*"([^"]+)"/);if(t&&t[1]){a=`/detail/${t[1]}`;break}const o=e.match(/\/status\/(\w+)/);if(o&&o[1]){a=`/status/${o[1]}`;break}}}if(!a)return console.log("无法确定评论页面URL，尝试的元素:",t),console.log("当前页面URL:",window.location.href),void(e.notify_enabled&&window.simpleNotify&&window.simpleNotify("未找到评论页面链接"));const r=o.match(/(\d+)/);r&&r[1],!function(n){const t=function(){const e=document.createElement("div");e.className="comment-modal-overlay";const n=x();e.innerHTML=`\n      <div class="comment-modal" data-theme="${n?"dark":"light"}">\n          <div class="comment-modal-header">\n              <div class="comment-modal-title">评论</div>\n              <button class="comment-modal-close" aria-label="关闭"></button>\n          </div>\n          <div class="comment-modal-content">\n              <div class="comment-modal-loading">加载中...</div>\n          </div>\n      </div>\n  `,document.body.appendChild(e),e.querySelector(".comment-modal-close").addEventListener("click",()=>{C(e)}),e.addEventListener("click",n=>{(n.clientX>window.innerWidth-100||n.target===e)&&C(e)});const t=n=>{"Escape"===n.key&&(C(e),document.removeEventListener("keydown",t))};return document.addEventListener("keydown",t),e}();t.querySelector(".comment-modal-title").textContent="详情";const o=t.querySelector(".comment-modal"),a=x();o&&o.setAttribute("data-theme",a?"dark":"light"),setTimeout(()=>{t.classList.add("show")},10),function(n,t){const o=n.querySelector(".comment-modal-content"),a=o.querySelector(".comment-modal-loading");try{const n=document.createElement("iframe");n.className="comment-modal-iframe",n.src=t,n.onload=function(){a&&(a.style.display="none");try{const t=n.contentDocument||n.contentWindow.document;if(t&&t.head&&e.enabled){const e=x();e?(t.body.classList.add("woo-theme-dark"),t.body.classList.remove("woo-theme-light")):(t.body.classList.add("woo-theme-light"),t.body.classList.remove("woo-theme-dark"));const o=n.closest(".comment-modal");o&&o.setAttribute("data-theme",e?"dark":"light");const a=t.createElement("style");a.id="widescreen-style",a.textContent=i,t.head.appendChild(a),console.log("已向评论iframe注入宽屏样式")}}catch(e){console.log("无法向iframe注入样式（可能是跨域）:",e)}},n.onerror=function(){a&&(a.textContent="加载评论失败，请稍后重试")},o.appendChild(n)}catch(e){console.error("创建iframe失败:",e),a&&(a.textContent="加载评论失败，请稍后重试")}}(t,n)}(a.startsWith("http")?a:a.startsWith("//")?"https:"+a:a.startsWith("/")?window.location.origin+a:window.location.href.split("?")[0]+"/"+a),e.notify_enabled&&window.simpleNotify&&window.simpleNotify("正在加载评论内容...")}},!0),document.addEventListener("keydown",e=>{e.ctrlKey&&e.shiftKey&&"D"===e.key&&(e.preventDefault(),function(){console.log("=== 微博评论元素分析 ==="),['a[href*="comment"]','div[class*="comment"]','span[class*="comment"]','i[class*="comment"]','div[class*="toolbar"]',"footer",'[class*="Feed_func"]','a:contains("评论")','div:contains("条评论")'].forEach(e=>{try{const n=document.querySelectorAll(e);n.length>0&&(console.log(`找到 ${n.length} 个 "${e}" 元素:`),n.forEach((e,n)=>{n<5&&console.log(`  ${n+1}. 文本: "${e.textContent.trim()}", 类名: "${e.className}", 标签: ${e.tagName}`)}),n.length>5&&console.log(`  ... 还有 ${n.length-5} 个元素未显示`))}catch(e){}});const e=document.querySelectorAll("script");console.log("页面中的微博ID信息:");for(const n of e){const e=n.textContent||n.innerText;if(e.includes("mid")||e.includes("status")){const n=e.match(/"mid":\s*"([^"]+)"/g),t=e.match(/\/status\/(\w+)/g);n&&console.log("  找到MID:",n.slice(0,3)),t&&console.log("  找到Status:",t.slice(0,3));break}}console.log("当前页面URL:",window.location.href),console.log("=== 分析完成 ===")}())})}function C(e){e.classList.remove("show"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}const j="weibo_bing_background";
/**
 * 获取必应每日图片
 * @returns {Promise<string|null>} 图片URL，失败返回null
 */
async function $(){try{console.log("[微博背景] 尝试获取必应每日图片"),l("正在获取必应每日图片...");const e=GM_getValue(j,null),n=Date.now();if(e&&n-e.timestamp<864e5)return console.log("[微博背景] 使用缓存的必应图片"),e.url;let t=null;try{const e="https://cn.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1",n="https://cn.bing.com";console.log(`[微博背景] 尝试从官方API获取必应图片: ${e}`);const o=(await new Promise((n,t)=>{GM_xmlhttpRequest({method:"GET",url:e,responseType:"json",timeout:8e3,onload:e=>{e.status>=200&&e.status<300?n(e):t(new Error(`HTTP error! Status: ${e.status}`))},onerror:e=>t(e),ontimeout:()=>t(new Error("请求超时"))})})).response;if(!o||!o.images||!o.images.length)throw new Error("从官方API响应中未找到图片");if(!o.images[0].url)throw new Error("必应API返回的图片URL为空");t=n+o.images[0].url,console.log("[微博背景] 官方API获取成功:",t)}catch(e){console.error("[微博背景] 官方API获取失败:",e);try{const e="https://api.kdcc.cn";console.log(`[微博背景] 尝试从备用API获取必应图片: ${e}`);const n=await new Promise((n,t)=>{GM_xmlhttpRequest({method:"GET",url:e,timeout:8e3,onload:e=>{e.status>=200&&e.status<300?n(e):t(new Error(`HTTP error! Status: ${e.status}`))},onerror:e=>t(e),ontimeout:()=>t(new Error("请求超时"))})});if(t=n.responseText.trim(),!t||t.length<10)throw new Error("备用API返回的URL无效");if(!(t&&(t.startsWith("http://")||t.startsWith("https://"))&&(t.includes(".jpg")||t.includes(".jpeg")||t.includes(".png")||t.includes(".webp"))))throw console.error("[微博背景] 备用API返回的URL格式无效:",t),new Error("备用API返回的URL格式无效");if(!await new Promise(e=>{const n=new Image;n.onload=()=>{const o=n.width>=800&&n.height>=800;o||console.error(`[微博背景] 备用API图片尺寸过小: ${n.width}x${n.height}`,t),e(o)},n.onerror=()=>{console.error("[微博背景] 检查备用API图片尺寸时加载失败"),e(!1)},n.src=t,setTimeout(()=>{n.complete||(console.error("[微博背景] 检查备用API图片尺寸超时"),e(!1))},3e3)}))throw new Error("备用API返回的图片尺寸过小或无法加载");console.log("[微博背景] 备用API获取成功:",t)}catch(e){throw console.error("[微博背景] 备用API获取也失败:",e),new Error("官方和备用API都获取失败")}}const o=t+(t.includes("?")?"&":"?")+"_t="+n;if(!(o&&(o.startsWith("http://")||o.startsWith("https://"))&&(o.includes(".jpg")||o.includes(".jpeg")||o.includes(".png")||o.includes(".webp"))))throw console.error("[微博背景] 获取到的URL可能无效:",o),new Error("获取到的必应图片URL格式可能无效");if(!await new Promise(e=>{const n=new Image;n.onload=()=>{const t=n.width>=800&&n.height>=800;t||console.error(`[微博背景] 图片尺寸过小: ${n.width}x${n.height}`,o),e(t)},n.onerror=()=>{console.error("[微博背景] 检查图片尺寸时加载失败"),e(!1)},n.src=o,setTimeout(()=>{n.complete||(console.error("[微博背景] 检查图片尺寸超时"),e(!1))},3e3)}))throw new Error("获取到的必应图片尺寸过小或无法加载");return GM_setValue(j,{url:o,timestamp:n}),console.log("[微博背景] 成功获取必应图片：",o),o}catch(e){console.error("[微博背景] 获取必应图片出错:",e);let n="获取必应每日图片失败";e.message&&e.message.includes("尺寸过小")&&(n="获取到的图片尺寸过小，不适合作为背景",console.warn("[微博背景] 图片尺寸不满足要求，需要至少800x800像素")),l(`${n}，将使用淡蓝色背景`);const t=GM_getValue(j,null);if(t&&t.url){console.log("[微博背景] 使用上一个缓存的必应图片");return(new Image).src=t.url,t.url}return console.log("[微博背景] 无有效缓存，将使用淡蓝色背景"),null}}
/**
 * 将File对象转换为Base64 URL
 * @param {File} file 用户上传的文件
 * @returns {Promise<string>} base64编码的URL
 */
/**
 * 创建文件选择器用于用户上传图片
 * @returns {Promise<string|null>} 返回Base64格式的图片数据URL
 */
function M(){return new Promise(e=>{try{console.log("[微博背景] 创建文件选择器");const n=document.createElement("div");n.setAttribute("id","weibo-image-selector-overlay"),n.style.cssText="\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(0,0,0,0.7);\n                z-index: 10000;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            ";const t=document.createElement("div");t.setAttribute("id","weibo-image-uploader"),t.style.cssText="\n                width: 350px;\n                padding: 20px;\n                background: white;\n                border-radius: 8px;\n                box-shadow: 0 4px 16px rgba(0,0,0,0.2);\n                text-align: center;\n            ",t.innerHTML='\n                <h3 style="margin-top:0;color:#333;font-size:16px;">选择背景图片</h3>\n                <p style="color:#666;margin-bottom:15px;font-size:14px;">选择本地图片或输入图片URL</p>\n                <div style="margin:20px 0;display:flex;flex-direction:column;gap:10px;">\n                    <button id="weibo-upload-file-btn" style="width:100%;padding:10px;background:#1890ff;color:white;border:none;border-radius:4px;cursor:pointer;font-size:14px;">选择本地图片</button>\n                    <button id="weibo-url-input-btn" style="width:100%;padding:10px;background:#f0f0f0;color:#333;border:1px solid #d9d9d9;border-radius:4px;cursor:pointer;font-size:14px;">输入图片URL</button>\n                    <button id="weibo-cancel-upload-btn" style="width:100%;padding:10px;background:#fff;color:#999;border:1px solid #d9d9d9;border-radius:4px;cursor:pointer;font-size:14px;margin-top:5px;">取消</button>\n                </div>\n                <div id="weibo-upload-status" style="margin-top:15px;padding:10px;font-size:13px;color:#ff8800;display:none;background:#fffbe6;border-radius:4px;"></div>\n            ',n.appendChild(t),document.body.appendChild(n);const o=document.createElement("input");o.setAttribute("id","weibo-file-input"),o.type="file",o.accept="image/*",o.style.cssText="position:absolute;top:-9999px;left:-9999px;",document.body.appendChild(o);const a=t.querySelector("#weibo-upload-status"),r=(e,n=!1)=>{a.textContent=e,a.style.display="block",a.style.color=n?"#ff4d4f":"#ff8800",a.style.background=n?"#fff2f0":"#fffbe6",a.style.border=n?"1px solid #ffccc7":"1px solid #ffe58f"};t.querySelector("#weibo-cancel-upload-btn").addEventListener("click",()=>{n.remove(),o.remove(),e(null)}),t.querySelector("#weibo-upload-file-btn").addEventListener("click",()=>{try{o.click()}catch(t){console.error("[微博背景] 点击文件输入失败:",t),r("无法打开文件选择器，请尝试输入URL",!0),setTimeout(async()=>{n.remove(),o.remove();const t=await B();e(t)},2e3)}}),t.querySelector("#weibo-url-input-btn").addEventListener("click",async()=>{n.remove(),o.remove();const t=await B();e(t)}),o.addEventListener("change",async()=>{try{const t=o.files&&o.files[0];if(!t)return void r("未选择文件",!0);if(t.size>10485760)return void r("文件太大，请选择小于10MB的图片",!0);if(!t.type.match("image.*"))return void r("请选择图片文件",!0);console.log("[微博背景] 文件已选择:",t.name,t.type,Math.round(t.size/1024),"KB"),r("正在处理图片，请稍候...");try{const a=await function(e){return new Promise((n,t)=>{const o=new FileReader;o.onload=()=>n(o.result),o.onerror=t,o.readAsDataURL(e)})}(t);if(!a||!a.startsWith("data:image/"))return void r("图片处理失败，请重试",!0);n.remove(),o.remove(),e(a)}catch(e){console.error("[微博背景] 读取文件失败:",e),r("读取图片失败，请重试或选择其他图片",!0)}}catch(e){console.error("[微博背景] 处理文件选择时出错:",e),r("处理文件失败",!0)}});const i=t=>{"Escape"===t.key&&(n.remove(),o.remove(),document.removeEventListener("keydown",i),e(null))};document.addEventListener("keydown",i),setTimeout(()=>{document.body.contains(n)&&(console.log("[微博背景] 文件选择器超时，自动关闭"),n.remove(),o.remove(),e(null))},12e4)}catch(n){console.error("[微博背景] 创建文件选择器失败:",n),l("无法打开文件选择对话框，将使用URL输入方式"),setTimeout(async()=>{const n=await B();e(n)},500)}})}
/**
 * 根据当前设置获取背景图片URL
 * @returns {Promise<string|null>} 背景图片URL或null
 */
/**
 * 设置背景类型
 * @param {'bing'|'custom'} type 背景类型
 */
function S(e){console.log("[微博背景] 设置背景类型为:",e),"bing"!==e&&"custom"!==e&&(console.error("[微博背景] 无效的背景类型:",e),l("无效的背景类型，使用默认值"),e="bing"),"custom"!==e||n.background_url&&""!==n.background_url.trim()||(console.log("[微博背景] 切换到自定义模式但缺少URL，将触发上传流程"),setTimeout(()=>{q().then(e=>{e||(console.log("[微博背景] 用户取消上传，回退到必应图片"),n.background_type="bing",o(),G())})},100)),l(`正在切换到${"bing"===e?"必应每日图片":"自定义图片"}...`),n.background_type=e,o(),n.background_enabled||(console.log("[微博背景] 背景功能未启用，自动启用"),n.background_enabled=!0,o());let t=document.getElementById("weibo-background-loading");t||(t=document.createElement("div"),t.id="weibo-background-loading",t.textContent="加载中...",t.style.position="fixed",t.style.top="10px",t.style.right="10px",t.style.padding="5px 10px",t.style.backgroundColor="rgba(0,0,0,0.5)",t.style.color="white",t.style.borderRadius="4px",t.style.zIndex="9999",t.style.fontSize="12px",document.body.appendChild(t));const a=document.getElementById("weibo-blur-background");a&&a.remove(),setTimeout(()=>{G().then(()=>{t&&t.parentNode&&t.remove()})},50)}
/**
 * 设置背景不透明度
 * @param {number} opacity 不透明度 (0-1)
 */function I(e){const t=Math.max(0,Math.min(1,e)),a=n.background_opacity;n.background_opacity=t,o(),console.log(`[微博背景] 设置透明度: ${a} -> ${t}`);const r=document.getElementById("weibo-blur-background");if(r){console.log("[微博背景] 直接更新背景不透明度:",t);try{r.style.setProperty("opacity",String(t),"important");const e="weibo-bg-opacity-styles";let n=document.getElementById(e);n||(n=document.createElement("style"),n.id=e,document.head.appendChild(n));const o=`weibo-bg-opacity-${Date.now()}`;r.classList.add(o),r.className.split(" ").forEach(e=>{e!==o&&e.startsWith("weibo-bg-opacity-")&&r.classList.remove(e)}),n.textContent=`\n                #weibo-blur-background.${o} {\n                    opacity: ${t} !important;\n                    filter: opacity(${100*t}%) !important;\n                }\n            `,requestAnimationFrame(()=>{r.style.opacity=String(t),r.style.filter=`opacity(${100*t}%)`,r.offsetHeight}),setTimeout(()=>{const e=window.getComputedStyle(r).opacity;console.log(`[微博背景] 透明度设置后的计算样式: ${e}`),Math.abs(parseFloat(e)-t)>.01&&(console.log("[微博背景] 检测到透明度未正确应用，尝试强制重绘"),r.style.display="none",r.offsetHeight,r.style.display="block",r.style.setProperty("opacity",String(t),"important"))},50),Math.round(100*t)%10==0&&l(`背景不透明度: ${Math.round(100*t)}%`)}catch(e){console.error("[微博背景] 设置透明度失败:",e),G()}}else console.log("[微博背景] 未找到背景元素，重新应用背景"),G()}
/**
 * 切换背景启用状态
 * @returns {boolean} 新的启用状态
 */
/**
 * 清除必应图片缓存
 * 用于强制刷新背景图片，解决图片过期或加载问题
 * @returns {boolean} 是否成功清除缓存
 */
function T(){try{return console.log("[微博背景] 正在清除必应图片缓存"),GM_setValue(j,null),l("已清除背景图片缓存，将重新获取最新图片"),setTimeout(()=>{"bing"===n.background_type&&G()},500),!0}catch(e){return console.error("[微博背景] 清除缓存失败:",e),l("清除缓存失败，请尝试刷新页面"),!1}}
/**
 * 获取用户输入的图片URL
 * @returns {Promise<string|null>} 用户输入的URL或null
 */function B(){return new Promise(async e=>{let n="";try{const e=GM_getValue(j,null);if(e&&e.url)n=e.url;else{const e=await $();e&&(n=e)}}catch(e){console.error("[微博背景] 获取示例URL失败:",e)}const t=prompt("请输入图片URL或粘贴图片链接:",n);if(!t||""===t.trim())return void e(null);if(!/\.(jpg|jpeg|png|gif|bmp|webp)(\?.*)?$/i.test(t)){if(!confirm("输入的URL可能不是有效的图片链接，是否仍然使用？"))return void e(null)}e(t.trim())})}
/**
 * 上传自定义背景图片
 * @returns {Promise<boolean>}
 */async function q(){try{l("正在打开图片选择器...");const e=await new Promise(async e=>{const n=await M();if(n)return console.log("[微博背景] 已获取图片数据，应用为背景"),void e({type:"dataUrl",url:n});console.log("[微博背景] 文件选择器未返回图片，尝试URL输入");const t=await B();e(t?{type:"url",url:t}:null)});return e?(l("图片已选择，正在应用..."),n.background_url=e.url,n.background_type="custom",o(),new Promise(t=>{const a=new Image;a.onload=()=>{console.log("[微博背景] 图片加载成功，尺寸:",a.width,"x",a.height),G(),l("自定义背景图片应用成功"),t(!0)},a.onerror=()=>{console.error("[微博背景] 自定义图片加载失败:",e.url.substring(0,50)+"..."),l("图片加载失败，请尝试其他图片"),n.background_type="bing",o(),G(),t(!1)};const r=setTimeout(()=>{a.complete||(console.error("[微博背景] 图片加载超时"),a.src="",l("图片加载超时，请尝试其他图片"),n.background_type="bing",o(),G(),t(!1))},1e4);a.onload=()=>{clearTimeout(r),console.log("[微博背景] 图片加载成功"),G(),l("自定义背景图片应用成功"),t(!0)},a.src=e.url})):(console.log("[微博背景] 用户取消了图片选择"),!1)}catch(e){console.error("[微博背景] 上传图片失败:",e),l("上传图片失败，请尝试直接输入图片URL");const t=await B();if(t){n.background_url=t,n.background_type="custom",o();const e=new Image;return e.onload=()=>G(),e.onerror=()=>{n.background_type="bing",o(),G(),l("图片URL无法访问，已切换到必应每日图片")},e.src=t,!0}return!1}}async function G(){console.log("[微博背景] 开始应用背景图片...");try{let e=document.getElementById("weibo-blur-background");if(e&&(e.remove(),console.log("[微博背景] 已移除旧背景元素")),!n.enabled)return void console.log("[微博背景] 高斯模糊功能未启用，不应用背景");if(!n.background_enabled)return void console.log("[微博背景] 背景功能未启用，不应用背景");"custom"!==n.background_type||n.background_url&&""!==n.background_url.trim()||(console.log("[微博背景] 自定义背景URL为空，自动切换到必应背景"),n.background_type="bing",o()),console.log("[微博背景] 当前背景设置:",{enabled:n.background_enabled,type:n.background_type,opacity:n.background_opacity,hasCustomUrl:!!n.background_url}),e=document.createElement("div"),e.id="weibo-blur-background";const t=`\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            width: 100vw;\n            height: 100vh;\n            background-size: cover;\n            background-position: center;\n            background-repeat: no-repeat;\n            opacity: ${n.background_opacity}; /* 使用配置的透明度 */\n            z-index: -1; /* 改为-1，确保在最底层但仍然可见 */\n            pointer-events: none;\n            will-change: opacity; /* 优化性能 */\n            transition: opacity 0.5s ease;\n            background-color: rgba(173, 216, 230, 0.5); /* 提高初始背景色透明度便于调试 */\n        `;e.style.cssText=t,document.body.firstChild?document.body.insertBefore(e,document.body.firstChild):document.body.appendChild(e),W();const a=await async function(){return n.background_enabled?"bing"===n.background_type?await $():"custom"===n.background_type?n.background_url&&""!==n.background_url.trim()?(console.log("[微博背景] 使用自定义背景图片"),n.background_url):(console.log("[微博背景] 自定义背景URL无效，尝试切换到必应图片"),n.background_type="bing",o(),await $()):null:null}();if(!a)return console.error("[微博背景] 无法应用背景，URL为空"),void l("无法加载背景图片，请尝试切换背景类型或刷新页面");console.log("[微博背景] 获取到背景URL:",a.substring(0,100)+"...");const r=new Image;let i=!1;r.onload=()=>{i=!0,clearTimeout(c),console.log("[微博背景] 背景图片加载成功"),e.style.backgroundImage=`url("${a}")`,setTimeout(()=>{e&&(e.style.backgroundColor="transparent",l("背景图片应用成功"))},300)},r.onerror=()=>{i=!1,console.error("[微博背景] 背景图片加载失败:",a),l("背景图片加载失败，使用纯色背景"),e.style.backgroundImage="none",e.style.backgroundColor="rgba(173, 216, 230, 0.3)",GM_setValue(j,null),console.log("[微博背景] 使用淡蓝色背景作为回退")};const c=setTimeout(()=>{i||(console.error("[微博背景] 背景图片加载超时:",a),r.onerror())},8e3);r.src=a,console.log("[微博背景] 已将背景元素添加到页面，正在加载图片"),function(){window.__weiboBackgroundObserver=null,window.__weiboBackgroundObserver&&window.__weiboBackgroundObserver.disconnect();const e=setInterval(()=>{const e=document.getElementById("weibo-blur-background");if(!e&&n.background_enabled&&n.enabled)console.log("[微博背景] 定期检查: 背景元素丢失，重新应用背景"),G();else if(e){const t=window.getComputedStyle(e);"none"!==t.display&&0!==parseFloat(t.opacity)&&"hidden"!==t.visibility||(console.log("[微博背景] 定期检查: 背景元素不可见，重置样式"),e.style.display="block",e.style.opacity=n.background_opacity,e.style.visibility="visible")}},5e3);window.__weiboBackgroundCheckInterval=e;const t=new MutationObserver(e=>{window.__weiboBackgroundDebounce&&clearTimeout(window.__weiboBackgroundDebounce),window.__weiboBackgroundDebounce=setTimeout(()=>{if(!n.enabled){const e=document.getElementById("weibo-blur-background");return void(e&&(console.log("[微博背景] 检测到高斯模糊已关闭，移除背景元素"),e.remove()))}const e=document.getElementById("weibo-blur-background");if(!e&&n.background_enabled&&n.enabled)return console.log("[微博背景] 检测到背景元素丢失，重新应用背景"),void G();if(e){const t=window.getComputedStyle(e);(parseInt(t.zIndex)<-1||0===parseFloat(t.opacity))&&(console.log("[微博背景] 检测到背景元素样式异常，正在修复 z-index:",t.zIndex,"opacity:",t.opacity),e.style.zIndex="-1",e.style.opacity=n.background_opacity,e.style.display="block",e.style.visibility="visible"),W()}},300)});t.observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class","id"]}),window.__weiboBackgroundObserver=t,console.log("[微博背景] 已设置背景持久性监视")}()}catch(e){console.error("[微博背景] 应用背景时出错:",e),l("应用背景图片时出错，请查看控制台获取详细信息")}}function W(){[document.querySelector("#app > div.woo-box-flex.woo-box-column.Frame_wrap_3g67Q"),document.querySelector("#app"),document.querySelector("#homeWrap"),document.querySelector("#react-root"),document.querySelector(".Frame_content_3XrxZ"),document.querySelector(".Frame_side_2mgLd"),document.querySelector(".wbpro-side-main")].forEach(e=>{if(e){const n=window.getComputedStyle(e);e.dataset.origPosition||(e.dataset.origPosition=n.position),e.dataset.origZIndex||(e.dataset.origZIndex=n.zIndex),e.dataset.origBgColor||(e.dataset.origBgColor=n.backgroundColor),e.style.position="relative",e.style.zIndex="1";const t=n.backgroundColor;if(t&&"transparent"!==t&&!t.includes("rgba")){const n=t.match(/\d+/g);n&&n.length>=3&&(e.style.backgroundColor=`rgba(${n[0]}, ${n[1]}, ${n[2]}, 0.5)`,console.log(`[微博背景] 调整了容器背景色: ${t} -> rgba(${n[0]}, ${n[1]}, ${n[2]}, 0.5)`))}console.log("[微博背景] 已应用样式到容器:",e)}});document.querySelectorAll("body > div").forEach(e=>{if("weibo-blur-background"!==e.id){const n=window.getComputedStyle(e);"fixed"===n.position&&("auto"===n.zIndex||parseInt(n.zIndex)<0)&&(console.log("[微博背景] 发现可能阻止背景显示的元素:",e),e.style.backgroundColor="transparent")}}),document.body.style.position="relative",document.body.style.minHeight="100vh",document.documentElement.style.minHeight="100vh";const e=window.getComputedStyle(document.body).backgroundColor;"transparent"===e||e.includes("rgba")||(document.body.style.backgroundColor="transparent",console.log("[微博背景] 已将body背景设置为透明"))}function A(){const e=document.getElementById("weibo-gaussian-blur-style");if(e&&e.remove(),!n.enabled)return void console.log("[微博高斯模糊] 功能未启用，不应用模糊效果");const t=document.createElement("style");t.id="weibo-gaussian-blur-style",document.documentElement.style.setProperty("--wb-blur-intensity",`${n.intensity}px`),t.textContent='\n/* 全局CSS变量 */\n:root {\n  --wb-blur-intensity: 5px;\n}\n\n/* 博文卡片模糊效果 - 主要元素 */\n#scroller > div.vue-recycle-scroller__item-wrapper > div > div > article,\narticle.woo-panel-main,\n.woo-box-wrap,\n.Feed_wrap_K5pCu,\n.Card_wrap_2ibWe,\n.woo-panel-main,\n.wbpro-feed-content,\n.wbpro-feed-item,\n.Main_full_2ntle article,\n.wbpro-side-main-wrap,\n.Main_side_oiMEU div,\n.woo-panel-main article {\n  background-color: rgba(255, 255, 255, 0.3) !important;  /* 更透明 */\n  backdrop-filter: blur(var(--wb-blur-intensity)) !important;\n  -webkit-backdrop-filter: blur(var(--wb-blur-intensity)) !important;\n  border-radius: 8px;\n  transition: backdrop-filter 0.3s ease, background-color 0.3s ease;\n}\n\n/* 深色模式下博文卡片模糊效果 */\n.woo-theme-dark #scroller > div.vue-recycle-scroller__item-wrapper > div > div > article,\n.woo-theme-dark article.woo-panel-main,\n.woo-theme-dark .woo-box-wrap,\n.woo-theme-dark .Feed_wrap_K5pCu,\n.woo-theme-dark .Card_wrap_2ibWe,\n.woo-theme-dark .woo-panel-main,\n.woo-theme-dark .wbpro-feed-content,\n.woo-theme-dark .wbpro-feed-item,\n.woo-theme-dark .Main_full_2ntle article,\n.woo-theme-dark .wbpro-side-main-wrap,\n.woo-theme-dark .Main_side_oiMEU div,\n.woo-theme-dark .woo-panel-main article {\n  background-color: rgba(30, 30, 30, 0.3) !important;  /* 更透明 */\n}\n\n/* \n * 高斯模糊应用模板\n * 请使用F12开发者工具选择需要应用模糊效果的元素，然后添加对应的选择器\n * \n * 示例:\n * .your-element-class {\n *   background-color: rgba(255, 255, 255, 0.4) !important;\n *   backdrop-filter: blur(var(--wb-blur-intensity)) !important;\n *   -webkit-backdrop-filter: blur(var(--wb-blur-intensity)) !important;\n *   border-radius: 8px;\n *   transition: backdrop-filter 0.3s ease;\n * }\n * \n * 深色模式示例:\n * .woo-theme-dark .your-element-class {\n *   background-color: rgba(30, 30, 30, 0.4) !important;\n * }\n */\n\n/* 背景图片样式 */\nhtml, body {\n  position: relative;\n  min-height: 100vh;\n}\n\n/* 为页面添加一个相对定位容器，确保内容正常显示 */\n.woo-box-flex, #homeWrap, #app, #react-root,\nhtml[data-react-helmet="true"] > body > div[id]:first-child {\n  position: relative;\n  z-index: 1;\n}\n\n/* 背景元素的基础样式 */\n#weibo-blur-background {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  width: 100vw;\n  height: 100vh;\n  background-size: cover;\n  background-position: center;\n  background-repeat: no-repeat;\n  z-index: -9999;\n  pointer-events: none;\n  will-change: opacity;\n  transition: opacity 0.5s ease, background-color 0.3s ease;\n  background-color: rgba(173, 216, 230, 0.3); /* 淡蓝色调试背景，加载图片前可见 */\n}\n\n/* 确保模糊不影响交互元素 */\nbutton, \ninput, \nselect, \ntextarea,\na[href],\n[role="button"],\n[tabindex]:not([tabindex="-1"]) {\n  backdrop-filter: none !important;\n  -webkit-backdrop-filter: none !important;\n  z-index: auto;\n}\n',document.head.appendChild(t),G(),console.log(`[微博高斯模糊] 已应用模糊效果，强度: ${n.intensity}px`),n.notify_enabled&&l(`已应用微博高斯模糊效果，强度: ${n.intensity}px`)}function N(){if(n.enabled=!n.enabled,o(),A(),!n.enabled){const e=document.getElementById("weibo-blur-background");e&&(console.log("[微博高斯模糊] 功能已禁用，移除背景元素"),e.remove())}return document.dispatchEvent(new CustomEvent("blurChange",{detail:{enabled:n.enabled,intensity:n.intensity}})),console.log(`[微博高斯模糊] 状态: ${n.enabled?"已启用":"已禁用"}, 强度: ${n.intensity}px`),n.enabled}function z(e){const t=parseInt(e,10)||5;n.intensity=Math.max(1,Math.min(15,t)),o();try{document.documentElement.style.setProperty("--wb-blur-intensity",`${n.intensity}px`);document.querySelectorAll('[style*="backdrop-filter"]').forEach(e=>{e.style.backdropFilter=`blur(${n.intensity}px)`,e.style.webkitBackdropFilter=`blur(${n.intensity}px)`}),console.log(`[微博高斯模糊] 已更新模糊强度: ${n.intensity}px`)}catch(e){console.error("[微博高斯模糊] 更新模糊强度失败:",e)}const a=t>=10||t<=2;return n.enabled&&a&&(console.log("[微博高斯模糊] 检测到极端值，完全重新应用样式"),A()),n.intensity}function R(){const a=document.querySelector(".weibo-enhance-panel");if(a)return a.style.display=e.ui_visible?"":"none",a;if(!document.querySelector("#weibo-enhance-panel-style")){const e=document.createElement("style");e.id="weibo-enhance-panel-style",e.textContent='\n.weibo-enhance-panel {\n    position: fixed;\n    top: 50%;\n    right: 20px;\n    transform: translateY(-50%);\n    background: var(--panel-bg, #ffffff);\n    border: 1px solid var(--panel-border, #e1e8ed);\n    border-radius: 12px;\n    box-shadow: 0 4px 20px rgba(0,0,0,0.1);\n    padding: 16px;\n    min-width: 240px; /* 增加宽度以确保所有控件有足够空间显示 */\n    /* 添加过渡效果，使方向变化平滑 */\n    transition: transform 0.3s ease, left 0.3s ease, right 0.3s ease;\n    opacity: 0.9;\n    transition: opacity 0.3s ease, transform 0.3s ease, background 0.3s ease;\n    z-index: 999;\n    font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n    cursor: move; /* 表明面板可拖动 */\n    user-select: none; /* 防止拖动时选中文字 */\n}\n\n.weibo-enhance-panel:hover {\n    opacity: 1;\n}\n\n/* 缩小的齿轮图标状态 */\n.weibo-enhance-panel.collapsed {\n    min-width: unset;\n    width: 42px;\n    height: 42px;\n    border-radius: 50%;\n    padding: 0;\n    background: #1890ff;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    box-shadow: 0 4px 10px rgba(0,0,0,0.2);\n    opacity: 0.8;\n    border: none;\n    transform: translateY(-50%) scale(1);\n    transition: all 0.3s ease;\n}\n\n.weibo-enhance-panel.collapsed:hover {\n    transform: translateY(-50%) scale(1.1);\n    opacity: 1;\n}\n\n/* 面板内容容器 */\n.panel-content {\n    width: 100%;\n    opacity: 1;\n    transition: opacity 0.3s ease;\n}\n\n.weibo-enhance-panel.collapsed .panel-content {\n    display: none;\n}\n\n/* 齿轮图标 */\n.panel-gear-icon {\n    display: none; /* 默认隐藏 */\n    color: white;\n    font-size: 22px;\n    animation: spin 10s linear infinite;\n}\n\n@keyframes spin {\n    0% { transform: rotate(0deg); }\n    100% { transform: rotate(360deg); }\n}\n\n.weibo-enhance-panel.collapsed .panel-gear-icon {\n    display: block;\n}\n\n/* 关闭按钮 */\n.panel-close-btn {\n    background: none;\n    border: none;\n    color: var(--panel-text-secondary, #666);\n    cursor: pointer;\n    font-size: 14px;\n    line-height: 1;\n    padding: 8px 12px;\n    opacity: 0.8;\n    transition: opacity 0.2s ease, transform 0.2s ease;\n    border-radius: 6px;\n}\n\n.panel-close-btn:hover {\n    opacity: 1;\n    background: var(--button-hover-bg, #f5f5f5);\n    color: var(--button-text, #333);\n}\n\n/* 折叠/展开按钮 */\n.panel-toggle-btn {\n    background: var(--button-bg, #fff);\n    border: 1px solid var(--button-border, #ddd);\n    border-radius: 6px;\n    color: var(--button-text, #333);\n    cursor: pointer;\n    font-size: 12px;\n    padding: 8px 12px;\n    opacity: 0.8;\n    transition: opacity 0.2s ease;\n}\n\n.panel-toggle-btn:hover {\n    opacity: 1;\n    background: var(--button-hover-bg, #f5f5f5);\n}\n\n.weibo-enhance-panel h3 {\n    margin: 0 0 12px 0;\n    font-size: 14px;\n    font-weight: 600;\n    color: var(--panel-text, #333);\n    text-align: center;\n    border-bottom: 1px solid var(--panel-border, #e1e8ed);\n    padding-bottom: 8px;\n}\n\n.weibo-enhance-panel .control-group {\n    margin-bottom: 16px;\n    width: 100%;\n    overflow: visible; /* 确保子元素溢出不会被裁剪 */\n    display: block; /* 保证显示为块级元素 */\n}\n\n.weibo-enhance-panel .control-group:last-child {\n    margin-bottom: 0;\n}\n\n.weibo-enhance-panel .control-title {\n    font-size: 12px;\n    color: var(--panel-text-secondary, #666);\n    margin-bottom: 6px;\n    font-weight: 500;\n}\n\n.weibo-enhance-panel button {\n    width: 100%;\n    padding: 8px 12px;\n    border: 1px solid var(--button-border, #ddd);\n    border-radius: 6px;\n    background: var(--button-bg, #fff);\n    color: var(--button-text, #333);\n    cursor: pointer;\n    font-size: 12px;\n    transition: all 0.2s ease;\n    margin-bottom: 4px;\n}\n\n.weibo-enhance-panel button:hover {\n    background: var(--button-hover-bg, #f5f5f5);\n    border-color: var(--button-hover-border, #bbb);\n}\n\n.weibo-enhance-panel button.active {\n    background: var(--button-active-bg, #1890ff);\n    color: white;\n    border-color: var(--button-active-bg, #1890ff);\n}\n\n.weibo-enhance-panel .checkbox-control {\n    display: flex;\n    align-items: center;\n    padding: 6px;\n    margin-bottom: 4px;\n    border-radius: 4px;\n    cursor: pointer;\n    transition: background 0.2s ease;\n}\n\n.weibo-enhance-panel .checkbox-control:hover {\n    background: var(--checkbox-hover-bg, #f5f5f5);\n}\n\n.weibo-enhance-panel .checkbox-control input {\n    margin-right: 8px;\n}\n\n.weibo-enhance-panel .checkbox-control label {\n    font-size: 12px;\n    color: var(--panel-text, #333);\n    cursor: pointer;\n    margin: 0;\n}\n\n/* 滑块控件样式 */\n.weibo-enhance-panel .range-control {\n    margin-top: 8px;\n    width: 100%;\n}\n\n.weibo-enhance-panel .range-control label {\n    display: block;\n    font-size: 12px;\n    color: var(--panel-text, #333);\n    margin-bottom: 6px;\n}\n\n.weibo-enhance-panel .range-control input[type="range"] {\n    width: 100%;\n    height: 5px;\n    border-radius: 5px;\n    background: var(--panel-border, #e1e8ed);\n    outline: none;\n    opacity: 0.7;\n    -webkit-transition: opacity .2s;\n    transition: opacity .2s;\n}\n\n.weibo-enhance-panel .range-control input[type="range"]:hover {\n    opacity: 1;\n}\n\n.weibo-enhance-panel .range-control input[type="range"]::-webkit-slider-thumb {\n    -webkit-appearance: none;\n    appearance: none;\n    width: 15px;\n    height: 15px;\n    border-radius: 50%;\n    background: var(--button-active-bg, #1890ff);\n    cursor: pointer;\n}\n\n.weibo-enhance-panel .range-control input[type="range"]::-moz-range-thumb {\n    width: 15px;\n    height: 15px;\n    border-radius: 50%;\n    background: var(--button-active-bg, #1890ff);\n    cursor: pointer;\n}\n\n/* 深色模式样式 */\nbody.woo-theme-dark .weibo-enhance-panel {\n    --panel-bg: #2f3349;\n    --panel-border: #484b6a;\n    --panel-text: #ffffff;\n    --panel-text-secondary: #b3b3b3;\n    --button-bg: #404466;\n    --button-text: #ffffff;\n    --button-border: #484b6a;\n    --button-hover-bg: #4a4f73;\n    --button-hover-border: #5a5f83;\n    --button-active-bg: #1890ff;\n    --checkbox-hover-bg: #404466;\n}\n\n/* 浅色模式样式 */\nbody.woo-theme-light .weibo-enhance-panel {\n    --panel-bg: #ffffff;\n    --panel-border: #e1e8ed;\n    --panel-text: #333333;\n    --panel-text-secondary: #666666;\n    --button-bg: #ffffff;\n    --button-text: #333333;\n    --button-border: #dddddd;\n    --button-hover-bg: #f5f5f5;\n    --button-hover-border: #bbbbbb;\n    --button-active-bg: #1890ff;\n    --checkbox-hover-bg: #f5f5f5;\n}\n\n.weibo-enhance-panel .status-indicator {\n    display: inline-block;\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n    margin-right: 6px;\n}\n\n.weibo-enhance-panel .status-indicator.on {\n    background: #52c41a;\n}\n\n.weibo-enhance-panel .status-indicator.off {\n    background: #f5222d;\n}\n\n/* 拖动结束后暂时禁用点击 */\n.weibo-enhance-panel.dragging-ended {\n    pointer-events: none;\n}\n\n/* 边缘展开方向控制 */\n.weibo-enhance-panel.expand-left {\n    right: auto;\n    left: 20px;\n}\n\n.weibo-enhance-panel.expand-right {\n    left: auto;\n    right: 20px;\n}\n\n/* 确保模糊控制组正确显示 */\n#blur-control-group {\n    display: block !important;\n    visibility: visible !important;\n    opacity: 1 !important;\n    height: auto !important;\n}\n\n/* 子控制组样式 */\n.weibo-enhance-panel .sub-control-group {\n    margin-top: 12px;\n    padding: 8px;\n    border: 1px solid var(--panel-border, #e1e8ed);\n    border-radius: 6px;\n    background-color: var(--panel-secondary-bg, rgba(245, 245, 245, 0.5));\n}\n\n.weibo-enhance-panel .sub-control-title {\n    font-size: 11px;\n    color: var(--panel-text-secondary, #666);\n    margin-bottom: 8px;\n    font-weight: 500;\n}\n\n/* 单选框样式 */\n.weibo-enhance-panel .radio-control {\n    display: flex;\n    flex-wrap: wrap;\n    margin-bottom: 8px;\n}\n\n.weibo-enhance-panel .radio-control input[type="radio"] {\n    margin-right: 5px;\n}\n\n.weibo-enhance-panel .radio-control label {\n    margin-right: 12px;\n    font-size: 12px;\n    color: var(--panel-text, #333);\n    cursor: pointer;\n    flex: 0 0 auto;\n}\n\n/* 小按钮样式 */\n.weibo-enhance-panel .small-button {\n    font-size: 12px;\n    padding: 5px 10px;\n    margin: 5px 0;\n    background: var(--button-secondary-bg, #f0f7ff);\n    border: 1px solid var(--button-secondary-border, #95bfff);\n    color: var(--button-secondary-text, #1890ff);\n    border-radius: 4px;\n    cursor: pointer;\n    transition: all 0.2s;\n}\n\n.weibo-enhance-panel .small-button:hover {\n    background: var(--button-secondary-hover-bg, #e6f2ff);\n    border-color: var(--button-secondary-hover-border, #69a2ff);\n}\n',document.head.appendChild(e)}if(!e.ui_visible)return null;const i=document.createElement("div");i.className="weibo-enhance-panel"+(e.panel_expanded?"":" collapsed"),e.panel_position&&(i.style.top=e.panel_position.top,i.style.right=e.panel_position.right,i.style.transform="none");let c=`\n    <div class="panel-content">\n      <h3>微博增强</h3>\n      \n      <div class="control-group">\n        <div class="control-title">宽屏功能</div>\n        <button id="widescreen-toggle" class="${e.enabled?"active":""}">\n          <span class="status-indicator ${e.enabled?"on":"off"}"></span>\n          ${e.enabled?"已开启":"已关闭"}\n        </button>\n        ${e.enabled?`\n          <div class="checkbox-control">\n            <input type="checkbox" id="loose-mode" ${e.loose?"checked":""}>\n            <label for="loose-mode">更宽模式</label>\n          </div>\n        `:""}\n      </div>\n        <div class="control-group">\n        <div class="control-title">主题切换</div>\n        <button id="theme-toggle">\n          <span class="status-indicator ${x()?"on":"off"}"></span>\n          切换主题\n        </button>\n        <button id="theme-reset">重置跟随</button>\n      </div>      <div class="control-group" id="blur-control-group">\n        <div class="control-title">高斯模糊效果</div>\n        <button id="blur-toggle" class="${n.enabled?"active":""}">\n          <span class="status-indicator ${n.enabled?"on":"off"}"></span>\n          ${n.enabled?"已开启":"已关闭"}\n        </button>\n        ${n.enabled?`\n          <div class="range-control">\n            <label for="blur-intensity">模糊强度: ${n.intensity}px</label>\n            <input type="range" id="blur-intensity" min="1" max="15" value="${n.intensity}">\n          </div>\n          \n          <div class="sub-control-group">\n            <div class="sub-control-title">背景设置</div>\n            <div class="checkbox-control">\n              <input type="checkbox" id="background-toggle" ${n.background_enabled?"checked":""}>\n              <label for="background-toggle">启用背景图</label>\n            </div>\n            \n            ${n.background_enabled?`\n              <div class="radio-control">\n                <input type="radio" id="bing-background" name="background-type" ${"bing"===n.background_type?"checked":""}>\n                <label for="bing-background">必应每日图片</label>\n                \n                <input type="radio" id="custom-background" name="background-type" ${"custom"===n.background_type?"checked":""}>\n                <label for="custom-background">自定义图片</label>\n              </div>\n              \n              ${"custom"===n.background_type?'\n                <button id="upload-background" class="small-button">上传图片</button>\n              ':""}\n              \n              <div class="range-control">\n                <label for="background-opacity">背景不透明度: ${Math.round(100*n.background_opacity)}%</label>\n                <input type="range" id="background-opacity" min="1" max="100" value="${Math.round(100*n.background_opacity)}">\n              </div>\n            `:""}\n          </div>\n        `:""}\n      </div>\n      \n      <div class="control-group">\n        <div class="control-title">其他功能</div>\n        <div class="checkbox-control">\n          <input type="checkbox" id="notification-toggle" ${e.notify_enabled?"checked":""}>\n          <label for="notification-toggle">启用通知</label>\n        </div>\n      </div>\n      \n      <div class="control-group">\n        <div class="control-title">面板控制</div>\n        <button class="panel-toggle-btn">收起面板</button>\n        <button class="panel-close-btn">关闭面板</button>\n      </div>\n    </div>\n  `;return i.innerHTML='<div class="panel-gear-icon">⚙️</div>'+c,function(a){const i=a.querySelector("#widescreen-toggle");i&&i.addEventListener("click",()=>{e.enabled=!e.enabled,t(),i.className=e.enabled?"active":"";const n=i.querySelector(".status-indicator");n&&(n.className="status-indicator "+(e.enabled?"on":"off"));const o=document.createTextNode(e.enabled?"已开启":"已关闭");i.innerHTML="",n&&i.appendChild(n.cloneNode(!0)),i.appendChild(o),l(e.enabled?"宽屏模式已启用，即将刷新页面":"宽屏模式已关闭，即将刷新页面"),setTimeout(()=>{window.location.reload()},500)});const c=a.querySelector("#blur-toggle");c&&c.addEventListener("click",()=>{const e=N();console.log("[微博增强] 高斯模糊状态切换为:",e?"开启":"关闭"),c.className=e?"active":"";const t=c.querySelector(".status-indicator");t&&(t.className="status-indicator "+(e?"on":"off"));const a=document.createTextNode(e?"已开启":"已关闭");c.innerHTML="",t&&c.appendChild(t.cloneNode(!0)),c.appendChild(a);const r=c.closest(".control-group");if(r){if(r.querySelectorAll(".range-control, .sub-control-group").forEach(e=>e.remove()),e){const e=document.createElement("div");e.className="range-control",e.innerHTML=`\n            <label for="blur-intensity">模糊强度: ${n.intensity}px</label>\n            <input type="range" id="blur-intensity" min="1" max="15" value="${n.intensity}">\n          `,r.appendChild(e);const t=e.querySelector("#blur-intensity");t&&t.addEventListener("input",n=>{const t=parseInt(n.target.value,10);z(t);const o=e.querySelector("label");o&&(o.textContent=`模糊强度: ${t}px`)});const a=document.createElement("div");a.className="sub-control-group",a.innerHTML=`\n            <div class="sub-control-title">背景设置</div>\n            <div class="checkbox-control">\n              <input type="checkbox" id="background-toggle" ${n.background_enabled?"checked":""}>\n              <label for="background-toggle">启用背景图</label>\n            </div>\n            \n            ${n.background_enabled?`\n              <div class="radio-control">\n                <input type="radio" id="bing-background" name="background-type" ${"bing"===n.background_type?"checked":""}>\n                <label for="bing-background">必应每日图片</label>\n                \n                <input type="radio" id="custom-background" name="background-type" ${"custom"===n.background_type?"checked":""}>\n                <label for="custom-background">自定义图片</label>\n              </div>\n              \n              ${"bing"===n.background_type?'\n                <button id="clear-bing-cache" class="small-button">清除图片缓存</button>\n              ':""}\n              \n              ${"custom"===n.background_type?'\n                <button id="upload-background" class="small-button">上传图片</button>\n              ':""}\n              \n              <div class="range-control">\n                <label for="background-opacity">背景不透明度: ${Math.round(100*n.background_opacity)}%</label>\n                <input type="range" id="background-opacity" min="1" max="100" value="${Math.round(100*n.background_opacity)}">\n              </div>\n            `:""}\n          `,r.appendChild(a),function(e){const t=e.querySelector("#background-toggle");t&&t.addEventListener("change",e=>{const a=e.target.checked;n.background_enabled=a,o();t.closest(".control-group");if(n.enabled)try{A(),G()}catch(e){console.error("[微博背景] 切换背景状态出错:",e)}l(a?"背景图片已启用":"背景图片已禁用")});const a=e.querySelector("#bing-background"),r=e.querySelector("#custom-background");a&&a.addEventListener("change",e=>{if(e.target.checked)try{console.log("[微博增强] 切换到必应每日图片背景");const e=document.createElement("span");e.id="bing-loading-msg",e.textContent=" (加载中...)",e.style.fontSize="12px",e.style.color="#ff8200";const n=a.nextElementSibling;n&&n.appendChild(e),a.disabled=!0,r&&(r.disabled=!0),S("bing"),G();const t=a.closest(".sub-control-group"),o=t.querySelector("#upload-background");if(o&&o.remove(),!t.querySelector("#clear-bing-cache")){const e=document.createElement("button");e.id="clear-bing-cache",e.className="small-button",e.textContent="清除图片缓存";const n=a.closest(".radio-control");n&&n.nextElementSibling?t.insertBefore(e,n.nextElementSibling):t.appendChild(e),e.addEventListener("click",()=>{try{T()?(e.textContent="缓存已清除",e.disabled=!0,setTimeout(()=>{e.disabled=!1,e.textContent="清除图片缓存"},1500)):l("清除缓存失败，请重试")}catch(e){console.error("[微博背景] 清除缓存出错:",e),l("清除缓存时发生错误")}})}setTimeout(()=>{const e=document.getElementById("bing-loading-msg");e&&e.remove(),a.disabled=!1,r&&(r.disabled=!1),l("已切换到必应每日图片背景")},1500)}catch(e){console.error("[微博增强] 切换背景类型出错:",e),l("切换背景类型出错，请重试"),a.disabled=!1,r&&(r.disabled=!1);const n=document.getElementById("bing-loading-msg");n&&n.remove()}});r&&r.addEventListener("change",e=>{if(e.target.checked)try{console.log("[微博增强] 切换到自定义图片背景");const e=document.createElement("span");e.id="custom-loading-msg",e.textContent=" (准备中...)",e.style.fontSize="12px",e.style.color="#ff8200";const t=r.nextElementSibling;t&&t.appendChild(e),r.disabled=!0,a&&(a.disabled=!0),n.background_url&&""!==n.background_url.trim()&&n.background_url.match(/^(data:|https?:\/\/)/i)?S("custom"):q().then(e=>{if(!e){console.log("[微博背景] 用户取消上传，恢复UI"),a&&(a.checked=!0,a.disabled=!1),r.disabled=!1;const e=document.getElementById("custom-loading-msg");return void(e&&e.remove())}console.log("[微博背景] 上传成功，设置为自定义类型"),S("custom")});const i=r.closest(".sub-control-group"),c=i.querySelector("#clear-bing-cache");if(c&&c.remove(),!i.querySelector("#upload-background")){const e=document.createElement("button");e.id="upload-background",e.className="small-button",e.textContent="上传图片";const t=r.closest(".radio-control");t&&t.nextElementSibling?i.insertBefore(e,t.nextElementSibling):i.appendChild(e),e.addEventListener("click",async()=>{e.disabled=!0,e.textContent="上传中...";try{r.checked||(r.checked=!0);await q()?(e.textContent="上传成功","custom"!==n.background_type&&(n.background_type="custom",o()),G(),setTimeout(()=>{e.disabled=!1,e.textContent="重新上传"},1500)):(e.textContent="上传取消","custom"!==n.background_type||n.background_url&&""!==n.background_url.trim()||(n.background_type="bing",o(),a&&(a.checked=!0),G()),setTimeout(()=>{e.disabled=!1,e.textContent="上传图片"},1e3))}catch(n){console.error("[微博增强] 上传图片出错:",n),e.textContent="上传失败",setTimeout(()=>{e.disabled=!1,e.textContent="重试上传"},1e3)}})}setTimeout(()=>{const e=document.getElementById("custom-loading-msg");e&&e.remove(),r.disabled=!1,a&&(a.disabled=!1),l("已切换到自定义图片背景")},1e3)}catch(e){console.error("[微博增强] 切换背景类型出错:",e),l("切换背景类型出错，请重试"),r.disabled=!1,a&&(a.disabled=!1);const n=document.getElementById("custom-loading-msg");n&&n.remove()}});const i=e.querySelector("#clear-bing-cache");i&&i.addEventListener("click",()=>{try{T()?(i.textContent="缓存已清除",i.disabled=!0,setTimeout(()=>{i.disabled=!1,i.textContent="清除图片缓存"},1500)):l("清除缓存失败，请重试")}catch(e){console.error("[微博背景] 清除缓存出错:",e),l("清除缓存时发生错误")}});const c=e.querySelector("#upload-background");c&&c.addEventListener("click",async()=>{c.disabled=!0,c.textContent="上传中...";try{const t=e.querySelector("#custom-background");t&&!t.checked&&(t.checked=!0);await q()?(c.textContent="上传成功","custom"!==n.background_type&&(n.background_type="custom",o()),l("图片上传成功，已应用为背景"),setTimeout(()=>{c.disabled=!1,c.textContent="重新上传"},1500)):(c.textContent="上传取消",l("图片上传已取消"),setTimeout(()=>{c.disabled=!1,c.textContent="上传图片"},1e3))}catch(e){console.error("[微博增强] 上传图片出错:",e),c.textContent="上传失败",l("图片上传失败，请重试"),setTimeout(()=>{c.disabled=!1,c.textContent="重试上传"},1e3)}});const s=e.querySelector("#background-opacity");if(s){s.value=Math.round(100*n.background_opacity);const e=s.previousElementSibling;e&&"LABEL"===e.tagName&&(e.textContent=`背景不透明度: ${Math.round(100*n.background_opacity)}%`);let t=null;const o=100;s.addEventListener("input",e=>{const n=parseInt(e.target.value,10)/100,a=s.previousElementSibling;a&&"LABEL"===a.tagName&&(a.textContent=`背景不透明度: ${Math.round(100*n)}%`);const r=document.getElementById("weibo-blur-background");r&&r.style.setProperty("opacity",n,"important"),clearTimeout(t),t=setTimeout(()=>{console.log("[微博背景] 应用新不透明度:",n),I(n)},o)}),s.addEventListener("change",e=>{const n=parseInt(e.target.value,10)/100;console.log("[微博背景] 不透明度调整完成:",n),I(n),l(`背景不透明度已设置为 ${Math.round(100*n)}%`)})}}(a)}}l(e?"高斯模糊效果已启用":"高斯模糊效果已关闭")});const s=a.querySelector("#blur-intensity");s&&s.addEventListener("input",e=>{const n=parseInt(e.target.value,10);z(n);const t=e.target.parentElement.querySelector("label");t&&(t.textContent=`模糊强度: ${n}px`)});const d=a.querySelector("#loose-mode");d&&d.addEventListener("change",n=>{e.loose=n.target.checked,t(),document.documentElement.classList.toggle("inject-widescreen-loose-js",e.loose),document.body.classList.toggle("inject-widescreen-loose-js",e.loose);let o=document.getElementById("weibo-widescreen-loose-style");e.loose?o||(o=document.createElement("style"),o.id="weibo-widescreen-loose-style",document.head.appendChild(o),o.textContent="\n/* 用户自定义宽度设置 - 更宽模式 */\n:root.inject-widescreen-loose-js {\n  --inject-page-width: 95vw !important;\n  --inject-page-width-legacy: 95vw !important;\n}\n\nbody.inject-widescreen-loose-js {\n  --inject-page-width: 95vw !important;\n  --inject-page-width-legacy: 95vw !important;\n}\n\n/* 更宽模式下的特殊调整 */\n.inject-widescreen-loose-js [class*=Frame_content],\n.inject-widescreen-loose-js [class*=Frame_content2] {\n  width: var(--inject-page-width) !important;\n  max-width: var(--inject-page-width) !important;\n}\n\n.inject-widescreen-loose-js .WB_frame {\n  width: var(--inject-page-width-legacy) !important;\n}\n\n/* 确保返回顶部按钮位置正确 */\n.inject-widescreen-loose-js [class*=Index_backTop] {\n  left: calc(50% + var(--inject-page-width)/2 + 10px);\n}\n\n.inject-widescreen-loose-js .W_gotop {\n  left: calc(50% + var(--inject-page-width-legacy)/2 + 10px);\n}"):o&&o.remove(),document.querySelectorAll("iframe").forEach(n=>{try{const t=n.contentDocument||n.contentWindow.document;if(t){t.documentElement.classList.toggle("inject-widescreen-loose-js",e.loose),t.body&&t.body.classList.toggle("inject-widescreen-loose-js",e.loose);let n=t.getElementById("weibo-widescreen-loose-style");e.loose?(n||(n=t.createElement("style"),n.id="weibo-widescreen-loose-style",t.head.appendChild(n)),n.textContent=o?o.textContent:""):n&&n.remove()}}catch(e){}});const a=new CustomEvent("widescreenChange",{detail:{enabled:!0,loose:e.loose}});document.dispatchEvent(a),l(`已切换为${e.loose?"更宽":"标准"}宽屏模式`)});const u=a.querySelector("#theme-toggle");u&&u.addEventListener("click",()=>{const e=!x();r(!0,e),_(e,!0),l(e?"已切换到深色模式":"已切换到浅色模式");const n=u.querySelector(".status-indicator");n&&setTimeout(()=>{const e=x();n.className="status-indicator "+(e?"on":"off")},300)});const b=a.querySelector("#theme-reset");b&&b.addEventListener("click",()=>{r(!1,null);_(window.matchMedia("(prefers-color-scheme: dark)").matches,!0),l("已恢复跟随系统主题");const e=a.querySelector("#theme-toggle");e&&setTimeout(()=>{const n=x(),t=e.querySelector(".status-indicator");t&&(t.className="status-indicator "+(n?"on":"off"))},300)});const m=a.querySelector("#notification-toggle");m&&m.addEventListener("change",n=>{e.notify_enabled=n.target.checked,t(),e.notify_enabled?l("通知已启用"):console.log("[微博增强] 通知已禁用")});a.addEventListener("click",e=>{a.classList.contains("collapsed")&&V(a,!1)});const p=a.querySelector(".panel-toggle-btn");p&&p.addEventListener("click",e=>{e.stopPropagation(),V(a,!0),l("面板已收起，点击齿轮图标可重新展开")});const g=a.querySelector(".panel-close-btn");g&&g.addEventListener("click",()=>{e.ui_visible=!1,t(),a.style.display="none",l("控制面板已关闭，可通过Tampermonkey菜单重新打开")})}(i),function(n){let o=0,a=0,r=!1,i=!1,c=0,l=0;n.addEventListener("mousedown",function(e){"BUTTON"!==e.target.tagName&&"INPUT"!==e.target.tagName&&"LABEL"!==e.target.tagName&&(r=!0,c=e.clientX,l=e.clientY,i=!1,o=e.clientX-n.getBoundingClientRect().left,a=e.clientY-n.getBoundingClientRect().top,n.style.transition="none",n.style.cursor="grabbing")}),document.addEventListener("mousemove",function(e){if(!r)return;const t=Math.abs(e.clientX-c),s=Math.abs(e.clientY-l);(t>3||s>3)&&(i=!0);const d=e.clientX-o,u=e.clientY-a,b=window.innerWidth-n.offsetWidth,m=window.innerHeight-n.offsetHeight,p=Math.min(Math.max(0,d),b),g=Math.min(Math.max(0,u),m);n.style.left=p+"px",n.style.top=g+"px",n.style.right="auto",n.style.transform="none",e.preventDefault()}),document.addEventListener("mouseup",function(o){if(!r)return;r=!1,n.style.cursor="move",n.style.transition="opacity 0.3s ease, transform 0.3s ease, background 0.3s ease";const a=Math.abs(o.clientX-c),s=Math.abs(o.clientY-l);i=a>5||s>5;const d=n.getBoundingClientRect();e.panel_position={top:d.top+"px",right:window.innerWidth-d.right+"px"},t(),i&&(n.classList.add("dragging-ended"),setTimeout(()=>{n.classList.remove("dragging-ended")},100))}),n.addEventListener("mouseleave",function(){r&&(r=!1)})}(i),function(e){let n;e.addEventListener("mouseenter",()=>{clearTimeout(n)}),e.addEventListener("mouseleave",()=>{e.classList.contains("collapsed")||(n=setTimeout(()=>{V(e,!0)},5e3))})}(i),document.body.appendChild(i),i}function V(n,o){if(console.log("切换面板状态: "+(o?"收起":"展开")),o)n.classList.add("collapsed"),e.panel_expanded=!1,console.log("面板已收起");else{const t=n.getBoundingClientRect(),o=window.innerWidth;window.innerHeight,n.offsetWidth,n.offsetHeight;n.classList.remove("expand-left","expand-right"),t.right>o-100?n.classList.add("expand-left"):n.classList.add("expand-right"),n.classList.remove("collapsed"),e.panel_expanded=!0,console.log("面板已展开")}t()}function P(){v(),A(),console.log("[微博增强] 高斯模糊功能初始化完成"),L(),function(){d(),document.addEventListener("widescreenChange",e=>{e.detail&&(console.log("[微博宽屏] 宽屏模式变化:",e.detail),d(!0))});const n=new MutationObserver(t=>{e.enabled&&t.some(n=>"childList"===n.type||"attributes"===n.type&&"class"===n.attributeName&&n.target.classList.contains("inject-widescreen-loose-js")!==e.loose)&&(n.reapplyDebounceTimer||(n.reapplyDebounceTimer=setTimeout(()=>{s(),n.reapplyDebounceTimer=null},1e3)))});n.observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}),setInterval(s,3e4),console.log("[微博宽屏] 宽屏功能初始化完成")}(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(R,300)}):setTimeout(R,500),window.addEventListener("load",()=>{setTimeout(()=>{A()},1e3),e.notify_enabled&&l("微博增强功能已激活")}),console.log("%c[微博增强] 功能已激活","color: #28a745; font-weight: bold;")}P(),GM_registerMenuCommand("显示/隐藏控制面板",function(){e.ui_visible=!e.ui_visible,t();const n=document.querySelector(".weibo-enhance-panel");n?n.style.display=e.ui_visible?"":"none":e.ui_visible&&R(),l(e.ui_visible?"控制面板已显示":"控制面板已隐藏")}),GM_registerMenuCommand("高斯模糊效果",function(){N();const e=document.querySelector(".weibo-enhance-panel");e&&(e.remove(),R()),l(n.enabled?"高斯模糊效果已启用":"高斯模糊效果已关闭")}),GM_registerMenuCommand("重置所有设置",function(){if(confirm("确定要重置所有设置吗？页面将会刷新。"))try{if(["widescreen_enabled","widescreen_loose","widescreen_notify_enabled","widescreen_ui_visible","widescreen_panel_expanded","widescreen_panel_position","blur_enabled","blur_intensity","blur_notify_enabled","blur_background_enabled","blur_background_type","blur_background_url","blur_background_opacity","userOverride","userThemeMode","weibo_bing_background"].forEach(e=>{console.log(`[微博增强] 正在删除配置项: ${e}`),GM_deleteValue(e)}),"function"==typeof GM_listValues)try{GM_listValues().forEach(e=>{(e.includes("weibo")||e.includes("widescreen")||e.includes("blur"))&&(console.log(`[微博增强] 删除其他相关配置: ${e}`),GM_deleteValue(e))})}catch(e){console.warn("[微博增强] GM_listValues不可用，跳过未知键清理",e)}l("所有设置已完全重置，配置已删除"),setTimeout(()=>{window.location.reload()},1e3)}catch(e){console.error("[微博增强] 重置设置失败:",e),l("重置设置时发生错误，请查看控制台")}})})();