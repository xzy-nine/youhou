// ==UserScript==
// @name          微博增强
// @namespace     http://tampermonkey.net/
// @version       1.0.3
// @description   微博增强功能：自动适应深色/浅色模式，弹出页查看更多评论，页面宽屏显示
// @author        xzy-nine
// @match         https://*.weibo.com/*
// @grant         GM_setValue
// @grant         GM_getValue
// @grant         GM_deleteValue
// @grant         GM_registerMenuCommand
// @grant         GM_addStyle
// @run_at        document-start
// @updateURL     https://gh-proxy.com/https://raw.githubusercontent.com/xzy-nine/youhou/main/weibo-up/dist/weibo-up.user.js
// @downloadURL   https://gh-proxy.com/https://raw.githubusercontent.com/xzy-nine/youhou/main/weibo-up/dist/weibo-up.user.js
// @supportURL    https://github.com/xzy-nine/youhou/issues
// @homepageURL   https://github.com/xzy-nine/youhou
// ==/UserScript==
(()=>{"use strict";const e={enabled:GM_getValue("widescreen_enabled",!0),loose:GM_getValue("widescreen_loose",!1),notify_enabled:GM_getValue("widescreen_notify_enabled",!1),ui_visible:GM_getValue("widescreen_ui_visible",!0),panel_expanded:GM_getValue("widescreen_panel_expanded",!0),panel_position:GM_getValue("widescreen_panel_position",null)};function n(){GM_setValue("widescreen_enabled",e.enabled),GM_setValue("widescreen_loose",e.loose),GM_setValue("widescreen_notify_enabled",e.notify_enabled),GM_setValue("widescreen_ui_visible",e.ui_visible),GM_setValue("widescreen_panel_expanded",e.panel_expanded),GM_setValue("widescreen_panel_position",e.panel_position)}let t=GM_getValue("userOverride",!1);function o(e){t=e,GM_setValue("userOverride",e)}const a="\n/* 新版微博宽屏样式 */\n@media screen and (min-width: 1340px) {\n    :root {\n        --inject-page-width: min(90vw, 1380px);\n    }\n    \n    .inject-widescreen-loose-js {\n        --inject-page-width: 90vw;\n    }\n    \n    /* 新版微博主要布局 */\n    [class*=Frame_content] {\n        --main-width: var(--inject-page-width);\n        width: var(--inject-page-width);\n    }\n    \n    [class*=Frame_content] > div:nth-of-type(2) {\n        flex: 1;\n    }\n    \n    [class*=Frame_main],\n    [class*=Main_full] {\n        flex-grow: 1;\n    }\n    \n    /* 微博内容区域优化 */\n    .woo-box-wrap[class*=picture_inlineNum3] {\n        max-width: 409px;\n    }\n    \n    .u-col-4.woo-box-wrap {\n        max-width: 546px;\n    }\n    \n    [class*=content_row] [class*=card-video_videoBox] {\n        max-width: 540px;\n    }\n    \n    [class*=content_row] [class*=card-article_pic] {\n        max-width: 540px;\n    }\n    \n    [class*=ProfileHeader_pic] {\n        overflow: hidden;\n    }\n    \n    /* 返回顶部按钮 */\n    [class*=Index_backTop] {\n        left: calc(50% + var(--inject-page-width)/2 + var(--frame-mod-gap-space));\n        margin-left: 0;\n        transform: translateX(0);\n    }\n}\n\n/* 视频详情页宽屏样式 */\n@media screen and (min-width: 1450px) {\n    [class*=Frame_content2] {\n        max-width: none;\n        width: var(--inject-page-width);\n    }\n    \n    [class*=Frame_main2] {\n        flex-grow: 1;\n        padding-right: 20px;\n    }\n}\n\n/* 旧版微博宽屏样式 - 兼容支持 */\n@media screen and (min-width: 1300px) {\n    :root {\n        --inject-page-width-legacy: min(75vw, 1330px);\n    }\n    \n    /* 旧版微博主页 */\n    .WB_frame {\n        display: flex;\n        width: var(--inject-page-width-legacy) !important;\n    }\n    \n    .WB_frame #plc_main {\n        display: flex !important;\n        flex: 1;\n        width: auto !important;\n    }\n    \n    .WB_main_c {\n        flex: 1;\n    }\n    \n    .WB_frame_c {\n        flex: 1;\n    }\n    \n    /* 微博类型标签 */\n    .tab_box {\n        display: flex;\n    }\n    \n    .tab_box::after {\n        content: none;\n    }\n    \n    .tab_box .fr_box {\n        flex: 1;\n    }\n    \n    /* 返回顶部按钮 */\n    .W_gotop {\n        left: calc(50% + (var(--inject-page-width-legacy) / 2));\n        margin-left: 0 !important;\n    }\n    \n    /* 微博时间线 */\n    .WB_timeline {\n        left: calc(50% + (var(--inject-page-width-legacy) / 2) + 10px);\n        margin-left: 0;\n    }\n}\n\n/* 微博文章页宽屏样式 */\n@media screen and (min-width: 1150px) {\n    #articleRoot .WB_frame {\n        width: var(--inject-page-width-legacy);\n    }\n    \n    #articleRoot #plc_main {\n        max-width: 100%;\n        width: auto;\n    }\n    \n    #articleRoot .WB_frame_a,\n    #articleRoot .WB_artical {\n        max-width: 100%;\n        width: auto;\n    }\n    \n    #articleRoot .main_toppic {\n        margin-left: auto;\n        margin-right: auto;\n    }\n    \n    #articleRoot .WB_editor_iframe_new {\n        width: auto;\n    }\n    \n    .B_artical [node-type=sidebar]>.W_gotop {\n        left: calc(50% + var(--inject-page-width-legacy)/2);\n        margin-left: 0;\n    }\n}",i="\n/* 用户自定义宽度设置 - 更宽模式 */\n@media screen and (min-width: 1340px) {\n  :root.inject-widescreen-loose-js {\n    --inject-page-width: 95vw !important;\n  }\n  \n  body.inject-widescreen-loose-js {\n    --inject-page-width: 95vw !important;\n  }\n  \n  /* 更宽模式下的特殊调整 */\n  .inject-widescreen-loose-js [class*=Frame_content],\n  .inject-widescreen-loose-js [class*=Frame_content2] {\n    width: var(--inject-page-width) !important;\n    max-width: var(--inject-page-width) !important;\n  }\n  \n  /* 确保返回顶部按钮位置正确 */\n  .inject-widescreen-loose-js [class*=Index_backTop] {\n    left: calc(50% + var(--inject-page-width)/2 + 10px);\n  }\n}\n\n/* 旧版微博更宽模式 */\n@media screen and (min-width: 1300px) {\n  :root.inject-widescreen-loose-js {\n    --inject-page-width-legacy: 95vw !important;\n  }\n  \n  body.inject-widescreen-loose-js {\n    --inject-page-width-legacy: 95vw !important;\n  }\n  \n  .inject-widescreen-loose-js .WB_frame {\n    width: var(--inject-page-width-legacy) !important;\n  }\n  \n  .inject-widescreen-loose-js .W_gotop {\n    left: calc(50% + var(--inject-page-width-legacy)/2 + 10px);\n  }\n  \n  .inject-widescreen-loose-js .WB_timeline {\n    left: calc(50% + var(--inject-page-width-legacy)/2 + 20px);\n  }\n}\n";function c(n){if(!e.notify_enabled)return;console.log(`%c[微博增强] ${n}`,"color: #1890ff; font-weight: bold;");const t=document.createElement("div");t.style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background-color: rgba(255, 255, 255, 0.95);\n    color: #333;\n    padding: 10px 15px;\n    border-radius: 8px;\n    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);\n    z-index: 9999;\n    font-size: 14px;\n    transition: all 0.3s ease;\n    opacity: 0;\n    transform: translateY(-20px);\n  ";(document.documentElement.classList.contains("woo-theme-dark")||document.body.classList.contains("woo-theme-dark"))&&(t.style.backgroundColor="rgba(40, 40, 40, 0.95)",t.style.color="#ddd"),t.textContent=n,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="1",t.style.transform="translateY(0)"},10),setTimeout(()=>{t.style.opacity="0",t.style.transform="translateY(-20px)",setTimeout(()=>{document.body.removeChild(t)},300)},3e3)}function s(){if(!e.enabled)return;const n=document.getElementById("weibo-widescreen-style");if(!n||!n.textContent.includes("--inject-page-width"))return console.log("[微博宽屏] 检测到样式缺失，重新应用样式"),void l(!0);const t=document.documentElement.classList.contains("inject-widescreen-loose-js");e.loose&&!t?(console.log("[微博宽屏] 检测到宽松模式类缺失，重新应用样式"),document.documentElement.classList.add("inject-widescreen-loose-js"),document.body.classList.add("inject-widescreen-loose-js")):!e.loose&&t&&(console.log("[微博宽屏] 检测到不需要宽松模式类，移除"),document.documentElement.classList.remove("inject-widescreen-loose-js"),document.body.classList.remove("inject-widescreen-loose-js"))}function l(n=!1){if(!e.enabled)return void console.log("[微博宽屏] 宽屏功能未启用");const t="weibo-widescreen-style";let o=document.getElementById(t);if(o||(o=document.createElement("style"),o.id=t,document.head.appendChild(o)),o.textContent=a,e.loose){document.documentElement.classList.add("inject-widescreen-loose-js"),document.body.classList.add("inject-widescreen-loose-js");const e="weibo-widescreen-loose-style";let n=document.getElementById(e);n||(n=document.createElement("style"),n.id=e,document.head.appendChild(n)),n.textContent=i}else{document.documentElement.classList.remove("inject-widescreen-loose-js"),document.body.classList.remove("inject-widescreen-loose-js");const e=document.getElementById("weibo-widescreen-loose-style");e&&e.remove()}if(null!==document.querySelector(".woo-box-flex")||null!==document.querySelector('[class*="Frame_wrap"]')||null!==document.querySelector('[class*="Home_wrap"]')){const e=r();e?p(e):setTimeout(()=>{const e=r();e&&p(e)},1e3)}else!function(){if(!e.enabled)return;console.log("[微博宽屏] 检测到旧版微博，正在配置宽屏样式");let n=null,t=null;const o="inject-ws-",a=e=>`${o}${e}`,i=()=>{const{$CONFIG:e}=window;if(!e||!e.location)return;t&&(t.remove(),t=null),[...document.body.classList.values()].forEach(e=>{e.startsWith(o)&&document.body.classList.remove(e)});const n={mainpage:{test:/^v6.*_content_home$/.test(e.location)||/v6_(fav|likes_outbox|content_friends)/.test(e.location),styles:d},profilepage:{test:/^page_.*_(home|photos|manage|myfollow|service|expert|topic)$/.test(e.location),styles:m},singleweibo:{test:/^page_.*_single_weibo$/.test(e.location),styles:u}},i=Object.entries(n).find(([,{test:e}])=>e);if(i){const[e,{styles:n}]=i,o=a(e);document.body.classList.add(o),t=document.createElement("style"),t.textContent=n(o),document.head.appendChild(t),console.log(`[微博宽屏] 应用旧版微博${e}页面宽屏样式`)}};window.$CONFIG&&!n&&(n=new Proxy(window.$CONFIG,{set(e,n,t,o){const a=e[n],c=Reflect.set(e,n,t,o);return"location"===n&&t!==a&&(console.log("[微博宽屏] 页面位置变化，重新应用样式"),setTimeout(i,100)),c}}),window.$CONFIG=n);i(),document.addEventListener("readystatechange",()=>{window.$CONFIG&&i()}),"loading"!==document.readyState&&window.$CONFIG&&i()}();e.loose&&(document.documentElement.classList.add("inject-widescreen-loose-js"),document.body.classList.add("inject-widescreen-loose-js")),document.addEventListener("load",function(n){if("IFRAME"===n.target.tagName)try{const t=n.target.contentDocument||n.target.contentWindow.document;if(t&&t.head){const n=t.createElement("style");if(n.id="widescreen-style",n.textContent=a,t.head.appendChild(n),e.loose){const e=t.createElement("style");e.id="weibo-widescreen-loose-style",e.textContent=i,t.head.appendChild(e),t.documentElement.classList.add("inject-widescreen-loose-js"),t.body&&t.body.classList.add("inject-widescreen-loose-js")}}}catch(e){console.log("无法访问iframe内容（可能是跨域）")}},!0),setInterval(()=>{document.querySelectorAll("iframe").forEach(n=>{try{const t=n.contentDocument||n.contentWindow.document;if(t&&t.head){if(!t.querySelector("#widescreen-style")){const e=t.createElement("style");e.id="widescreen-style",e.textContent=a,t.head.appendChild(e)}const n=!!t.querySelector("#weibo-widescreen-loose-style"),o=t.documentElement.classList.contains("inject-widescreen-loose-js");if(e.loose&&!n){const e=t.createElement("style");e.id="weibo-widescreen-loose-style",e.textContent=i,t.head.appendChild(e)}else if(!e.loose&&n){const e=t.querySelector("#weibo-widescreen-loose-style");e&&e.remove()}e.loose&&!o?(t.documentElement.classList.add("inject-widescreen-loose-js"),t.body&&t.body.classList.add("inject-widescreen-loose-js")):!e.loose&&o&&(t.documentElement.classList.remove("inject-widescreen-loose-js"),t.body&&t.body.classList.remove("inject-widescreen-loose-js"))}}catch(e){}})},2e3),console.log("[微博宽屏] 宽屏样式已"+(n?"更新":"应用")),setTimeout(s,2e3)}function r(){let e=null;return(e=>{const n=()=>{let t=null;const o=document.querySelectorAll("*");for(const e of o)if(e.__vue__&&e.__vue__.$router){t=e.__vue__;break}t?e(t):setTimeout(n,100)};n()})(n=>{e=n}),e}function d(e){return`\n    .${e} .WB_frame {\n      display: flex;\n      width: var(--inject-page-width-legacy) !important;\n    }\n    .${e} #plc_main {\n      display: flex !important;\n      flex: 1;\n      width: auto !important;\n    }\n    .${e} .WB_main_c {\n      flex: 1;\n    }\n    .${e} .tab_box {\n      display: flex;\n    }\n    .${e} .tab_box::after {\n      content: none;\n    }\n    .${e} .tab_box .fr_box {\n      flex: 1;\n    }\n    .${e} .W_gotop {\n      left: calc(50% + (var(--inject-page-width-legacy) / 2));\n      margin-left: 0 !important;\n    }\n  `}function m(e){return`\n    .${e} .WB_frame {\n      width: var(--inject-page-width-legacy) !important;\n    }\n    .${e} .WB_frame_a, \n    .${e} .WB_frame_a_fix {\n      width: 100%;\n    }\n    .${e} #plc_main {\n      width: 100% !important;\n      display: flex;\n    }\n    .${e} #plc_main > div:last-child {\n      margin-right: 0;\n    }\n    .${e} .WB_frame_c .input_simple_wrap .inputfunc_simple_wrap {\n      width: calc(100% - 80px);\n    }\n    .${e} .WB_frame_c {\n      flex: 1;\n    }\n    .${e} .WB_timeline {\n      left: calc(50% + (var(--inject-page-width-legacy) / 2) + 10px);\n      margin-left: 0;\n    }\n    .${e} .W_gotop {\n      left: calc(50% + (var(--inject-page-width-legacy) / 2));\n      margin-left: 0 !important;\n    }\n  `}function u(e){return`\n    .${e} .WB_frame {\n      width: var(--inject-page-width-legacy) !important;\n    }\n    .${e} #plc_main {\n      display: flex !important;\n      width: auto !important;\n    }\n    .${e} #plc_main .WB_frame_c {\n      flex: 1;\n    }    .${e} .W_gotop {\n      left: calc(50% + (var(--inject-page-width-legacy) / 2) - 19px);\n      margin-left: 0 !important;\n    }\n  `}function p(n){if(console.log("[微博宽屏] 设置新版微博宽屏样式"),!e.enabled||!n)return;const t=new Map([[["home","mygroups","profile","nameProfile","customProfile","bidDetail","atWeibo","cmtInbox","likeInbox","follow","myFollowTab","fav","like","weibo","list","topic","search","searchResult"],"home"],[["Playdetail"],"video"]]),o=n=>{if(!e.enabled)return;const t=document.getElementById("weibo-widescreen-style");if(!t||!t.textContent){const e=document.createElement("style");e.id="weibo-widescreen-style",e.textContent=a,document.head.appendChild(e)}if(e.loose){document.documentElement.classList.add("inject-widescreen-loose-js"),document.body.classList.add("inject-widescreen-loose-js");let e=document.getElementById("weibo-widescreen-loose-style");e||(e=document.createElement("style"),e.id="weibo-widescreen-loose-style",e.textContent=i,document.head.appendChild(e))}console.log(`[微博宽屏] 应用新版微博${n}页面宽屏样式`),e.notify_enabled&&c("微博宽屏模式已启用"),document.dispatchEvent(new CustomEvent("widescreenStyleApplied",{detail:{pageType:n,isLoose:e.loose}}))};if(n.$router){n.$router.afterEach(e=>{console.log("[微博宽屏] 路由变化:",e.name);for(const[n,a]of t.entries())if(n.includes(e.name)){o(a);break}});const e=n.$route;if(e){for(const[n,a]of t.entries())if(n.includes(e.name)){o(a);break}}else o("home")}else o("home")}let f=null,h=null,g=!1,b=!1,w=null;function y(){const e=window.matchMedia("(prefers-color-scheme: dark)").matches;GM_setValue("lastSystemMode",e),setTimeout(()=>{if(t){const e=v();console.log(`用户手动设置为${e?"深色":"浅色"}模式，保持不变`),x(e,!1),f=e}else{v()!==e&&x(e,!1),f=e}h=t},500),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",n=>{const o=n.matches,a=GM_getValue("lastSystemMode",e);GM_setValue("lastSystemMode",o),a===o||t||(x(o,!1),f!==o&&(c(`已切换到${o?"深色":"浅色"}模式`),f=o))}),function(){const e=localStorage.setItem;localStorage.setItem=function(n,a){const i=e.apply(this,arguments);if(("darkModeHistory"===n||"weiboThemeMode"===n)&&!b)try{let e=!1;if("darkModeHistory"===n)try{const n=JSON.parse(a);n&&n.length>0&&n[0].length>1&&(e=1===n[0][1])}catch(e){console.error("[微博主题] 无法解析主题设置:",e)}else"weiboThemeMode"===n&&(e="dark"===a);if(v()!==e){if(console.log(`[微博主题] 检测到用户手动切换为${e?"深色":"浅色"}模式`),t=!0,o(!0),b){if("weiboThemeMode"===n&&!b){b=!0;const n=_();localStorage.setItem("darkModeHistory",`[[${n},${e?1:0}]]`),b=!1}}else b=!0,localStorage.setItem("weiboThemeMode",e?"dark":"light"),b=!1;!0===h&&f===e&&g||(c(`已手动切换为${e?"深色":"浅色"}模式`),f=e,h=!0,g=!0),document.body&&k(e)}}catch(e){console.error(`[微博主题] 解析${n}时出错:`,e)}return i}}(),document.addEventListener("keydown",e=>{if(e.ctrlKey&&e.shiftKey&&"R"===e.key){e.preventDefault();const n=t;t=!1,o(!1);const a=GM_getValue("lastSystemMode",window.matchMedia("(prefers-color-scheme: dark)").matches),i=v();(n||i!==a)&&(x(a,!0),c&&c("恢复自动跟随系统模式"),f=a,h=!1)}})}function v(){try{const e=localStorage.getItem("darkModeHistory");if(e){const n=JSON.parse(e);if(n&&n.length>0&&n[0].length>1)return 1===n[0][1]}}catch(e){}return!!document.body&&document.body.classList.contains("woo-theme-dark")}function x(e,n=!1){try{n||(b=!0);const t=_(),o=e?1:0;try{localStorage.setItem("darkModeHistory",`[[${t},${o}]]`),console.log("[微博主题] 设置localStorage: darkModeHistory="+(e?"深色":"浅色"))}catch(e){console.error("[微博主题] 设置localStorage失败:",e)}const a=()=>{if(document.body){document.body.classList.remove("woo-theme-dark","woo-theme-light"),e?(document.body.classList.add("woo-theme-dark"),document.documentElement.setAttribute("data-theme","dark")):(document.body.classList.add("woo-theme-light"),document.documentElement.setAttribute("data-theme","light")),console.log(`[微博主题] 已设置为${e?"深色":"浅色"}模式`),function(e){document.querySelectorAll(".comment-modal").forEach(n=>{n.setAttribute("data-theme",e?"dark":"light");const t=n.querySelector(".comment-modal-iframe");if(t)try{const n=t.contentDocument||t.contentWindow.document;n&&n.body&&(n.body.classList.remove("woo-theme-dark","woo-theme-light"),n.body.classList.add(e?"woo-theme-dark":"woo-theme-light"))}catch(e){console.log("[微博主题] 无法更新iframe主题（可能是跨域）:",e)}})}(e),function(e){w&&w.disconnect();w=new MutationObserver(n=>{let t=!1,o=!1;n.forEach(n=>{if("class"===n.attributeName){o=!0;const a=n.target,i=a.classList.contains("woo-theme-dark"),c=a.classList.contains("woo-theme-light");e&&!i?t=!0:e||c||(t=!0)}}),t&&o&&k(e)}),document.body&&w.observe(document.body,{attributes:!0,attributeFilter:["class"]});w.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),k(e)}(e);try{["themeChange","theme-change","darkModeChange"].forEach(n=>{const t=new CustomEvent(n,{bubbles:!0,detail:{isDark:e,theme:e?"dark":"light"}});document.dispatchEvent(t),window.dispatchEvent(t)})}catch(e){console.error("[微博主题] 无法触发主题变更事件:",e)}!function(e){try{let n=!1;const t=e?'[class*="nav_item_dark"]:not([class*="nav_item_active"])':'[class*="nav_item_light"]:not([class*="nav_item_active"])',o=document.querySelector(t);if(o&&(console.log("[微博主题] 找到原生主题按钮，触发点击事件"),o.click(),n=!0),window.app){let t=window.app;if(!t&&window.__VUE_APP__&&(t=window.__VUE_APP__),!t){const e=document.querySelector("#app");e&&e.__vue__&&(t=e.__vue__)}if(t&&t.$store){console.log("[微博主题] 尝试通过Vue实例切换主题");const o=e?"toggleDarkMode":"toggleLightMode";t.$store.commit&&"function"==typeof t.$store.commit&&(t.$store.commit(o),n=!0)}}if(window.$CONFIG&&void 0!==window.$CONFIG.theme){console.log("[微博主题] 尝试通过$CONFIG设置主题"),window.$CONFIG.theme=e?"dark":"light";const t=new Event("storage");t.key="weiboThemeMode",t.newValue=e?"dark":"light",window.dispatchEvent(t),n=!0}try{const t=`[[${_()},${e?1:0}]]`;localStorage.setItem("darkModeHistory",t);const o=new Event("storage");o.key="darkModeHistory",o.newValue=t,window.dispatchEvent(o),n=!0}catch(e){console.error("[微博主题] 通过localStorage切换主题失败:",e)}return n||console.log("[微博主题] 未找到微博原生主题切换机制，仅应用CSS样式"),n}catch(e){return console.error("[微博主题] 触发原生主题切换失败:",e),!1}}(e);try{const e=new StorageEvent("storage",{key:"darkModeHistory",newValue:`[[${t},${o}]]`,url:window.location.href,storageArea:localStorage});window.dispatchEvent(e)}catch(e){const n=new Event("storage");n.key="darkModeHistory",n.newValue=`[[${t},${o}]]`,window.dispatchEvent(n)}}else document.addEventListener("DOMContentLoaded",a)};return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",a):a(),n||(b=!1),e}catch(e){return n||(b=!1),console.error("[微博主题] 设置主题模式时出错:",e),c("主题设置失败"),null}}function _(){let e=null;try{const n=localStorage.getItem("darkModeHistory");if(n){const t=JSON.parse(n);t&&t.length>0&&t[0].length>0&&(e=t[0][0])}}catch(e){console.error("解析darkModeHistory失败:",e)}if(!e){const n=document.documentElement.outerHTML.match(/uid=(\d+)/);n&&n[1]&&(e=parseInt(n[1],10))}return e||0}function k(e){if(!document.body)return;document.body.classList.remove(e?"woo-theme-light":"woo-theme-dark"),document.body.classList.add(e?"woo-theme-dark":"woo-theme-light");document.querySelectorAll('[class*="theme-switch"]').length>0&&console.log("[微博主题] 找到主题切换器元素，尝试修正"),document.querySelectorAll("iframe").forEach(n=>{try{const t=n.contentDocument||n.contentWindow.document;t&&t.body&&(t.body.classList.remove("woo-theme-dark","woo-theme-light"),t.body.classList.add(e?"woo-theme-dark":"woo-theme-light"))}catch(e){}})}const j="\n.comment-modal-overlay {\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.3);\n    z-index: 10000;\n    display: flex;\n    justify-content: flex-start;\n    align-items: center;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n.comment-modal-overlay.show {\n    opacity: 1;\n}\n\n/* 右侧点击区域提示 */\n.comment-modal-overlay::after {\n    content: '';\n    position: absolute;\n    top: 0;\n    right: 0;\n    width: 100px;\n    height: 100%;\n    background: linear-gradient(to left, rgba(0, 0, 0, 0.1), transparent);\n    pointer-events: none;\n    transition: background 0.2s ease;\n}\n\n.comment-modal-overlay:hover::after {\n    background: linear-gradient(to left, rgba(0, 0, 0, 0.2), transparent);\n}\n\n.comment-modal {\n    background: var(--bg-color, #ffffff);\n    border-radius: 0 45px 45px 0;\n    box-shadow: 2px 0 40px rgba(0, 0, 0, 0.15);\n    max-width: calc(100% - 100px);\n    height: calc(100vh - 40px);\n    width: calc(100% - 100px);\n    margin: 20px 100px 20px 0;\n    position: relative;\n    overflow: hidden;\n    transform: translateX(-100%);\n    transition: transform 0.3s ease;\n}\n\n.comment-modal-overlay.show .comment-modal {\n    transform: translateX(0);\n}\n\n.comment-modal-header {\n    padding: 12px 20px;\n    border-bottom: 1px solid var(--border-color, #e1e8ed);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    background: var(--header-bg, #f7f9fa);\n    border-radius: 0 45px 0 0;\n    min-height: 40px;\n}\n\n.comment-modal-title {\n    font-size: 14px;\n    font-weight: bold;\n    color: var(--text-color, #14171a);\n}\n\n.comment-modal-close {\n    width: 28px;\n    height: 28px;\n    border: none;\n    background: none;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 50%;\n    transition: background-color 0.2s;\n}\n\n.comment-modal-close:hover {\n    background-color: var(--hover-bg, #f0f0f0);\n}\n\n.comment-modal-close::before {\n    content: '×';\n    font-size: 20px;\n    color: var(--text-color, #657786);\n}\n\n.comment-modal-content {\n    padding: 0;\n    height: calc(100vh - 100px);\n    overflow: hidden;\n    position: relative;\n}\n\n.comment-modal-iframe {\n    width: 100%;\n    height: 100%;\n    border: none;\n    background: var(--bg-color, #ffffff);\n}\n\n.comment-modal-loading {\n    padding: 40px;\n    text-align: center;\n    color: var(--text-color, #657786);\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: var(--bg-color, #ffffff);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 1;\n}\n\n/* 深色模式样式 */\nbody.woo-theme-dark .comment-modal,\n.comment-modal[data-theme=\"dark\"] {\n    --bg-color: #1d1f23;\n    --border-color: #38444d;\n    --header-bg: #15181c;\n    --text-color: #ffffff;\n    --hover-bg: #273340;\n}\n\n/* 浅色模式样式 */\nbody.woo-theme-light .comment-modal,\n.comment-modal[data-theme=\"light\"] {\n    --bg-color: #ffffff;\n    --border-color: #e1e8ed;\n    --header-bg: #f7f9fa;\n    --text-color: #14171a;\n    --hover-bg: #f0f0f0;\n}\n\n/* 滚动条样式 */\n.comment-modal-content::-webkit-scrollbar {\n    width: 6px;\n}\n\n.comment-modal-content::-webkit-scrollbar-track {\n    background: transparent;\n}\n\n.comment-modal-content::-webkit-scrollbar-thumb {\n    background: var(--border-color, #e1e8ed);\n    border-radius: 3px;\n}\n\n.comment-modal-content::-webkit-scrollbar-thumb:hover {\n    background: var(--text-color, #657786);\n}\n";function E(){!function(){const e=document.createElement("style");e.textContent=j,document.head.appendChild(e)}(),document.addEventListener("click",function(n){const t=n.target.closest("a[href]");if(!t)return;const o=t.textContent||t.innerText||"";let i=t.getAttribute("href");if(i&&"#"!==i&&!i.startsWith("javascript:")&&(console.log("检测到链接点击:",{target:t,linkText:o.trim(),href:i,className:t.className}),o.includes("查看全部")&&o.includes("评论")||/查看全部\s*\d+\s*条?评论/.test(o)||/^\s*\d+\s*条?评论?\s*$/.test(o)&&(i.includes("/status/")||i.includes("/detail/")))){if(console.log("拦截查看全部评论链接:",o.trim()),n.preventDefault(),n.stopPropagation(),!i){const e=t.closest("article");if(e){const n=e.querySelector('a[href*="/status/"], a[href*="/detail/"], a[href*="/u/"]');if(n&&(i=n.getAttribute("href")),!i){const n=e.querySelector("[data-mid], [mid]");if(n){const e=n.getAttribute("data-mid")||n.getAttribute("mid");e&&(i=`/detail/${e}`)}}if(!i){const n=e.querySelector("[data-itemid], [data-id]");if(n){const e=n.getAttribute("data-itemid")||n.getAttribute("data-id");e&&(i=`/detail/${e}`)}}}}if(!i){const e=document.querySelectorAll('a[href*="/status/"], a[href*="/detail/"]');if(e.length>0){const n=Array.from(e).find(e=>{const n=e.getBoundingClientRect(),o=t.getBoundingClientRect();return Math.abs(n.top-o.top)<200});n&&(i=n.getAttribute("href"))}}if(!i){const e=window.location.href;if(e.includes("/status/"))i=e;else if(e.includes("/detail/"))i=e;else if(e.includes("/u/")){const e=document.querySelector('a[href*="/status/"], a[href*="/detail/"]');e&&(i=e.getAttribute("href"))}}if(!i){const e=document.querySelectorAll("script");for(const n of e){const e=n.textContent||n.innerText,t=e.match(/"mid":\s*"([^"]+)"/);if(t&&t[1]){i=`/detail/${t[1]}`;break}const o=e.match(/\/status\/(\w+)/);if(o&&o[1]){i=`/status/${o[1]}`;break}}}if(!i)return console.log("无法确定评论页面URL，尝试的元素:",t),console.log("当前页面URL:",window.location.href),void(e.notify_enabled&&window.simpleNotify&&window.simpleNotify("未找到评论页面链接"));const c=o.match(/(\d+)/);c&&c[1],!function(n){const t=function(){const e=document.createElement("div");e.className="comment-modal-overlay";const n=v();e.innerHTML=`\n      <div class="comment-modal" data-theme="${n?"dark":"light"}">\n          <div class="comment-modal-header">\n              <div class="comment-modal-title">评论</div>\n              <button class="comment-modal-close" aria-label="关闭"></button>\n          </div>\n          <div class="comment-modal-content">\n              <div class="comment-modal-loading">加载中...</div>\n          </div>\n      </div>\n  `,document.body.appendChild(e),e.querySelector(".comment-modal-close").addEventListener("click",()=>{L(e)}),e.addEventListener("click",n=>{(n.clientX>window.innerWidth-100||n.target===e)&&L(e)});const t=n=>{"Escape"===n.key&&(L(e),document.removeEventListener("keydown",t))};return document.addEventListener("keydown",t),e}();t.querySelector(".comment-modal-title").textContent="详情";const o=t.querySelector(".comment-modal"),i=v();o&&o.setAttribute("data-theme",i?"dark":"light"),setTimeout(()=>{t.classList.add("show")},10),function(n,t){const o=n.querySelector(".comment-modal-content"),i=o.querySelector(".comment-modal-loading");try{const n=document.createElement("iframe");n.className="comment-modal-iframe",n.src=t,n.onload=function(){i&&(i.style.display="none");try{const t=n.contentDocument||n.contentWindow.document;if(t&&t.head&&e.enabled){const e=v();e?(t.body.classList.add("woo-theme-dark"),t.body.classList.remove("woo-theme-light")):(t.body.classList.add("woo-theme-light"),t.body.classList.remove("woo-theme-dark"));const o=n.closest(".comment-modal");o&&o.setAttribute("data-theme",e?"dark":"light");const i=t.createElement("style");i.id="widescreen-style",i.textContent=a,t.head.appendChild(i),console.log("已向评论iframe注入宽屏样式")}}catch(e){console.log("无法向iframe注入样式（可能是跨域）:",e)}},n.onerror=function(){i&&(i.textContent="加载评论失败，请稍后重试")},o.appendChild(n)}catch(e){console.error("创建iframe失败:",e),i&&(i.textContent="加载评论失败，请稍后重试")}}(t,n)}(i.startsWith("http")?i:i.startsWith("//")?"https:"+i:i.startsWith("/")?window.location.origin+i:window.location.href.split("?")[0]+"/"+i),e.notify_enabled&&window.simpleNotify&&window.simpleNotify("正在加载评论内容...")}},!0),document.addEventListener("keydown",e=>{e.ctrlKey&&e.shiftKey&&"D"===e.key&&(e.preventDefault(),function(){console.log("=== 微博评论元素分析 ==="),['a[href*="comment"]','div[class*="comment"]','span[class*="comment"]','i[class*="comment"]','div[class*="toolbar"]',"footer",'[class*="Feed_func"]','a:contains("评论")','div:contains("条评论")'].forEach(e=>{try{const n=document.querySelectorAll(e);n.length>0&&(console.log(`找到 ${n.length} 个 "${e}" 元素:`),n.forEach((e,n)=>{n<5&&console.log(`  ${n+1}. 文本: "${e.textContent.trim()}", 类名: "${e.className}", 标签: ${e.tagName}`)}),n.length>5&&console.log(`  ... 还有 ${n.length-5} 个元素未显示`))}catch(e){}});const e=document.querySelectorAll("script");console.log("页面中的微博ID信息:");for(const n of e){const e=n.textContent||n.innerText;if(e.includes("mid")||e.includes("status")){const n=e.match(/"mid":\s*"([^"]+)"/g),t=e.match(/\/status\/(\w+)/g);n&&console.log("  找到MID:",n.slice(0,3)),t&&console.log("  找到Status:",t.slice(0,3));break}}console.log("当前页面URL:",window.location.href),console.log("=== 分析完成 ===")}())})}function L(e){e.classList.remove("show"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}function M(){const t=document.querySelector(".weibo-enhance-panel");if(t)return t.style.display=e.ui_visible?"":"none",t;if(!document.querySelector("#weibo-enhance-panel-style")){const e=document.createElement("style");e.id="weibo-enhance-panel-style",e.textContent="\n.weibo-enhance-panel {\n    position: fixed;\n    top: 50%;\n    right: 20px;\n    transform: translateY(-50%);\n    background: var(--panel-bg, #ffffff);\n    border: 1px solid var(--panel-border, #e1e8ed);\n    border-radius: 12px;\n    box-shadow: 0 4px 20px rgba(0,0,0,0.1);\n    padding: 16px;\n    min-width: 200px;\n    /* 添加过渡效果，使方向变化平滑 */\n    transition: transform 0.3s ease, left 0.3s ease, right 0.3s ease;\n    opacity: 0.9;\n    transition: opacity 0.3s ease, transform 0.3s ease, background 0.3s ease;\n    z-index: 999;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    cursor: move; /* 表明面板可拖动 */\n    user-select: none; /* 防止拖动时选中文字 */\n}\n\n.weibo-enhance-panel:hover {\n    opacity: 1;\n}\n\n/* 缩小的齿轮图标状态 */\n.weibo-enhance-panel.collapsed {\n    min-width: unset;\n    width: 42px;\n    height: 42px;\n    border-radius: 50%;\n    padding: 0;\n    background: #1890ff;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    box-shadow: 0 4px 10px rgba(0,0,0,0.2);\n    opacity: 0.8;\n    border: none;\n    transform: translateY(-50%) scale(1);\n    transition: all 0.3s ease;\n}\n\n.weibo-enhance-panel.collapsed:hover {\n    transform: translateY(-50%) scale(1.1);\n    opacity: 1;\n}\n\n/* 面板内容容器 */\n.panel-content {\n    width: 100%;\n    opacity: 1;\n    transition: opacity 0.3s ease;\n}\n\n.weibo-enhance-panel.collapsed .panel-content {\n    display: none;\n}\n\n/* 齿轮图标 */\n.panel-gear-icon {\n    display: none; /* 默认隐藏 */\n    color: white;\n    font-size: 22px;\n    animation: spin 10s linear infinite;\n}\n\n@keyframes spin {\n    0% { transform: rotate(0deg); }\n    100% { transform: rotate(360deg); }\n}\n\n.weibo-enhance-panel.collapsed .panel-gear-icon {\n    display: block;\n}\n\n/* 关闭按钮 */\n.panel-close-btn {\n    background: none;\n    border: none;\n    color: var(--panel-text-secondary, #666);\n    cursor: pointer;\n    font-size: 14px;\n    line-height: 1;\n    padding: 8px 12px;\n    opacity: 0.8;\n    transition: opacity 0.2s ease, transform 0.2s ease;\n    border-radius: 6px;\n}\n\n.panel-close-btn:hover {\n    opacity: 1;\n    background: var(--button-hover-bg, #f5f5f5);\n    color: var(--button-text, #333);\n}\n\n/* 折叠/展开按钮 */\n.panel-toggle-btn {\n    background: var(--button-bg, #fff);\n    border: 1px solid var(--button-border, #ddd);\n    border-radius: 6px;\n    color: var(--button-text, #333);\n    cursor: pointer;\n    font-size: 12px;\n    padding: 8px 12px;\n    opacity: 0.8;\n    transition: opacity 0.2s ease;\n}\n\n.panel-toggle-btn:hover {\n    opacity: 1;\n    background: var(--button-hover-bg, #f5f5f5);\n}\n\n.weibo-enhance-panel h3 {\n    margin: 0 0 12px 0;\n    font-size: 14px;\n    font-weight: 600;\n    color: var(--panel-text, #333);\n    text-align: center;\n    border-bottom: 1px solid var(--panel-border, #e1e8ed);\n    padding-bottom: 8px;\n}\n\n.weibo-enhance-panel .control-group {\n    margin-bottom: 12px;\n}\n\n.weibo-enhance-panel .control-group:last-child {\n    margin-bottom: 0;\n}\n\n.weibo-enhance-panel .control-title {\n    font-size: 12px;\n    color: var(--panel-text-secondary, #666);\n    margin-bottom: 6px;\n    font-weight: 500;\n}\n\n.weibo-enhance-panel button {\n    width: 100%;\n    padding: 8px 12px;\n    border: 1px solid var(--button-border, #ddd);\n    border-radius: 6px;\n    background: var(--button-bg, #fff);\n    color: var(--button-text, #333);\n    cursor: pointer;\n    font-size: 12px;\n    transition: all 0.2s ease;\n    margin-bottom: 4px;\n}\n\n.weibo-enhance-panel button:hover {\n    background: var(--button-hover-bg, #f5f5f5);\n    border-color: var(--button-hover-border, #bbb);\n}\n\n.weibo-enhance-panel button.active {\n    background: var(--button-active-bg, #1890ff);\n    color: white;\n    border-color: var(--button-active-bg, #1890ff);\n}\n\n.weibo-enhance-panel .checkbox-control {\n    display: flex;\n    align-items: center;\n    padding: 6px;\n    margin-bottom: 4px;\n    border-radius: 4px;\n    cursor: pointer;\n    transition: background 0.2s ease;\n}\n\n.weibo-enhance-panel .checkbox-control:hover {\n    background: var(--checkbox-hover-bg, #f5f5f5);\n}\n\n.weibo-enhance-panel .checkbox-control input {\n    margin-right: 8px;\n}\n\n.weibo-enhance-panel .checkbox-control label {\n    font-size: 12px;\n    color: var(--panel-text, #333);\n    cursor: pointer;\n    margin: 0;\n}\n\n/* 深色模式样式 */\nbody.woo-theme-dark .weibo-enhance-panel {\n    --panel-bg: #2f3349;\n    --panel-border: #484b6a;\n    --panel-text: #ffffff;\n    --panel-text-secondary: #b3b3b3;\n    --button-bg: #404466;\n    --button-text: #ffffff;\n    --button-border: #484b6a;\n    --button-hover-bg: #4a4f73;\n    --button-hover-border: #5a5f83;\n    --button-active-bg: #1890ff;\n    --checkbox-hover-bg: #404466;\n}\n\n/* 浅色模式样式 */\nbody.woo-theme-light .weibo-enhance-panel {\n    --panel-bg: #ffffff;\n    --panel-border: #e1e8ed;\n    --panel-text: #333333;\n    --panel-text-secondary: #666666;\n    --button-bg: #ffffff;\n    --button-text: #333333;\n    --button-border: #dddddd;\n    --button-hover-bg: #f5f5f5;\n    --button-hover-border: #bbbbbb;\n    --button-active-bg: #1890ff;\n    --checkbox-hover-bg: #f5f5f5;\n}\n\n.weibo-enhance-panel .status-indicator {\n    display: inline-block;\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n    margin-right: 6px;\n}\n\n.weibo-enhance-panel .status-indicator.on {\n    background: #52c41a;\n}\n\n.weibo-enhance-panel .status-indicator.off {\n    background: #f5222d;\n}\n\n/* 拖动结束后暂时禁用点击 */\n.weibo-enhance-panel.dragging-ended {\n    pointer-events: none;\n}\n\n/* 边缘展开方向控制 */\n.weibo-enhance-panel.expand-left {\n    right: auto;\n    left: 20px;\n}\n\n.weibo-enhance-panel.expand-right {\n    left: auto;\n    right: 20px;\n}\n",document.head.appendChild(e)}if(!e.ui_visible)return null;const a=document.createElement("div");a.className="weibo-enhance-panel"+(e.panel_expanded?"":" collapsed"),e.panel_position&&(a.style.top=e.panel_position.top,a.style.right=e.panel_position.right,a.style.transform="none");let i=`\n    <div class="panel-content">\n      <h3>微博增强</h3>\n      \n      <div class="control-group">\n        <div class="control-title">宽屏功能</div>\n        <button id="widescreen-toggle" class="${e.enabled?"active":""}">\n          <span class="status-indicator ${e.enabled?"on":"off"}"></span>\n          ${e.enabled?"已开启":"已关闭"}\n        </button>\n        ${e.enabled?`\n          <div class="checkbox-control">\n            <input type="checkbox" id="loose-mode" ${e.loose?"checked":""}>\n            <label for="loose-mode">更宽模式</label>\n          </div>\n        `:""}\n      </div>\n      \n      <div class="control-group">\n        <div class="control-title">主题切换</div>\n        <button id="theme-toggle">\n          <span class="status-indicator ${v()?"on":"off"}"></span>\n          切换主题\n        </button>\n        <button id="theme-reset">重置跟随</button>\n      </div>\n      \n      <div class="control-group">\n        <div class="control-title">其他功能</div>\n        <div class="checkbox-control">\n          <input type="checkbox" id="notification-toggle" ${e.notify_enabled?"checked":""}>\n          <label for="notification-toggle">启用通知</label>\n        </div>\n      </div>\n      \n      <div class="control-group">\n        <div class="control-title">面板控制</div>\n        <button class="panel-toggle-btn">收起面板</button>\n        <button class="panel-close-btn">关闭面板</button>\n      </div>\n    </div>\n  `;return a.innerHTML='<div class="panel-gear-icon">⚙️</div>'+i,function(t){const a=t.querySelector("#widescreen-toggle");a&&a.addEventListener("click",()=>{e.enabled=!e.enabled,n(),a.className=e.enabled?"active":"";const t=a.querySelector(".status-indicator");t&&(t.className="status-indicator "+(e.enabled?"on":"off"));const o=document.createTextNode(e.enabled?"已开启":"已关闭");a.innerHTML="",t&&a.appendChild(t.cloneNode(!0)),a.appendChild(o),c(e.enabled?"宽屏模式已启用，即将刷新页面":"宽屏模式已关闭，即将刷新页面"),setTimeout(()=>{window.location.reload()},500)});const i=t.querySelector("#loose-mode");i&&i.addEventListener("change",t=>{e.loose=t.target.checked,n(),document.documentElement.classList.toggle("inject-widescreen-loose-js",e.loose),document.body.classList.toggle("inject-widescreen-loose-js",e.loose);let o=document.getElementById("weibo-widescreen-loose-style");e.loose?o||(o=document.createElement("style"),o.id="weibo-widescreen-loose-style",document.head.appendChild(o),o.textContent="\n/* 用户自定义宽度设置 - 更宽模式 */\n:root.inject-widescreen-loose-js {\n  --inject-page-width: 95vw !important;\n  --inject-page-width-legacy: 95vw !important;\n}\n\nbody.inject-widescreen-loose-js {\n  --inject-page-width: 95vw !important;\n  --inject-page-width-legacy: 95vw !important;\n}\n\n/* 更宽模式下的特殊调整 */\n.inject-widescreen-loose-js [class*=Frame_content],\n.inject-widescreen-loose-js [class*=Frame_content2] {\n  width: var(--inject-page-width) !important;\n  max-width: var(--inject-page-width) !important;\n}\n\n.inject-widescreen-loose-js .WB_frame {\n  width: var(--inject-page-width-legacy) !important;\n}\n\n/* 确保返回顶部按钮位置正确 */\n.inject-widescreen-loose-js [class*=Index_backTop] {\n  left: calc(50% + var(--inject-page-width)/2 + 10px);\n}\n\n.inject-widescreen-loose-js .W_gotop {\n  left: calc(50% + var(--inject-page-width-legacy)/2 + 10px);\n}"):o&&o.remove(),document.querySelectorAll("iframe").forEach(n=>{try{const t=n.contentDocument||n.contentWindow.document;if(t){t.documentElement.classList.toggle("inject-widescreen-loose-js",e.loose),t.body&&t.body.classList.toggle("inject-widescreen-loose-js",e.loose);let n=t.getElementById("weibo-widescreen-loose-style");e.loose?(n||(n=t.createElement("style"),n.id="weibo-widescreen-loose-style",t.head.appendChild(n)),n.textContent=o?o.textContent:""):n&&n.remove()}}catch(e){}});const a=new CustomEvent("widescreenChange",{detail:{enabled:!0,loose:e.loose}});document.dispatchEvent(a),c(`已切换为${e.loose?"更宽":"标准"}宽屏模式`)});const s=t.querySelector("#theme-toggle");s&&s.addEventListener("click",()=>{const e=!v();o(!0);if(null!==x(e,!0)){const n=s.querySelector(".status-indicator");n&&(n.className="status-indicator "+(e?"on":"off"),setTimeout(()=>{const e=v();n.className="status-indicator "+(e?"on":"off")},500)),c(e?"已切换到深色模式":"已切换到浅色模式"),$(e)}});const l=t.querySelector("#theme-reset");l&&l.addEventListener("click",()=>{o(!1);const e=GM_getValue("lastSystemMode",window.matchMedia("(prefers-color-scheme: dark)").matches);if(null!==x(e,!0)){c("已恢复跟随系统主题");const n=t.querySelector("#theme-toggle");if(n){const t=n.querySelector(".status-indicator");t?t.className="status-indicator "+(e?"on":"off"):n.innerHTML=`\n              <span class="status-indicator ${e?"on":"off"}"></span>\n              切换主题\n            `,setTimeout(()=>{const e=v(),t=n.querySelector(".status-indicator");t?t.className="status-indicator "+(e?"on":"off"):n.innerHTML=`\n                <span class="status-indicator ${e?"on":"off"}"></span>\n                切换主题\n              `},500)}$(e)}});const r=t.querySelector("#notification-toggle");r&&r.addEventListener("change",t=>{e.notify_enabled=t.target.checked,n(),e.notify_enabled?c("通知已启用"):console.log("[微博增强] 通知已禁用")});t.addEventListener("click",e=>{t.classList.contains("collapsed")&&C(t,!1)});const d=t.querySelector(".panel-toggle-btn");d&&d.addEventListener("click",e=>{e.stopPropagation(),C(t,!0),c("面板已收起，点击齿轮图标可重新展开")});const m=t.querySelector(".panel-close-btn");m&&m.addEventListener("click",()=>{e.ui_visible=!1,n(),t.style.display="none",c("控制面板已关闭，可通过Tampermonkey菜单重新打开")})}(a),function(t){let o=0,a=0,i=!1,c=!1,s=0,l=0;t.addEventListener("mousedown",function(e){"BUTTON"!==e.target.tagName&&"INPUT"!==e.target.tagName&&"LABEL"!==e.target.tagName&&(i=!0,s=e.clientX,l=e.clientY,c=!1,o=e.clientX-t.getBoundingClientRect().left,a=e.clientY-t.getBoundingClientRect().top,t.style.transition="none",t.style.cursor="grabbing")}),document.addEventListener("mousemove",function(e){if(!i)return;const n=Math.abs(e.clientX-s),r=Math.abs(e.clientY-l);(n>3||r>3)&&(c=!0);const d=e.clientX-o,m=e.clientY-a,u=window.innerWidth-t.offsetWidth,p=window.innerHeight-t.offsetHeight,f=Math.min(Math.max(0,d),u),h=Math.min(Math.max(0,m),p);t.style.left=f+"px",t.style.top=h+"px",t.style.right="auto",t.style.transform="none",e.preventDefault()}),document.addEventListener("mouseup",function(o){if(!i)return;i=!1,t.style.cursor="move",t.style.transition="opacity 0.3s ease, transform 0.3s ease, background 0.3s ease";const a=Math.abs(o.clientX-s),r=Math.abs(o.clientY-l);c=a>5||r>5;const d=t.getBoundingClientRect();e.panel_position={top:d.top+"px",right:window.innerWidth-d.right+"px"},n(),c&&(t.classList.add("dragging-ended"),setTimeout(()=>{t.classList.remove("dragging-ended")},100))}),t.addEventListener("mouseleave",function(){i&&(i=!1)})}(a),function(e){let n;e.addEventListener("mouseenter",()=>{clearTimeout(n)}),e.addEventListener("mouseleave",()=>{e.classList.contains("collapsed")||(n=setTimeout(()=>{C(e,!0)},5e3))})}(a),document.body.appendChild(a),a}function $(e){document.body.classList.remove("woo-theme-dark","woo-theme-light"),document.body.classList.add(e?"woo-theme-dark":"woo-theme-light");const n=document.querySelector(".weibo-enhance-panel");n&&n.setAttribute("data-theme",e?"dark":"light"),document.querySelectorAll("iframe").forEach(n=>{try{const t=n.contentDocument||n.contentWindow.document;t&&t.body&&(t.body.classList.remove("woo-theme-dark","woo-theme-light"),t.body.classList.add(e?"woo-theme-dark":"woo-theme-light"))}catch(e){}});document.querySelectorAll(".comment-modal").forEach(n=>{n.setAttribute("data-theme",e?"dark":"light")});const t=new CustomEvent("themeRefresh",{detail:{isDark:e}});document.dispatchEvent(t)}function C(t,o){if(console.log("切换面板状态: "+(o?"收起":"展开")),o)t.classList.add("collapsed"),e.panel_expanded=!1,console.log("面板已收起");else{const n=t.getBoundingClientRect(),o=window.innerWidth;window.innerHeight,t.offsetWidth,t.offsetHeight;t.classList.remove("expand-left","expand-right"),n.right>o-100?t.classList.add("expand-left"):t.classList.add("expand-right"),t.classList.remove("collapsed"),e.panel_expanded=!0,console.log("面板已展开")}n()}function S(){y(),E(),function(){l(),document.addEventListener("widescreenChange",e=>{e.detail&&(console.log("[微博宽屏] 宽屏模式变化:",e.detail),l(!0))});const n=new MutationObserver(t=>{e.enabled&&t.some(n=>"childList"===n.type||"attributes"===n.type&&"class"===n.attributeName&&n.target.classList.contains("inject-widescreen-loose-js")!==e.loose)&&(n.reapplyDebounceTimer||(n.reapplyDebounceTimer=setTimeout(()=>{s(),n.reapplyDebounceTimer=null},1e3)))});n.observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}),setInterval(s,3e4),console.log("[微博宽屏] 宽屏功能初始化完成")}(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",M):setTimeout(M,300),console.log("%c[微博增强] 功能已激活","color: #28a745; font-weight: bold;"),window.addEventListener("load",()=>{e.notify_enabled&&c("微博增强功能已激活")})}S(),GM_registerMenuCommand("显示/隐藏控制面板",function(){e.ui_visible=!e.ui_visible,n();const t=document.querySelector(".weibo-enhance-panel");t?t.style.display=e.ui_visible?"":"none":e.ui_visible&&M(),c(e.ui_visible?"控制面板已显示":"控制面板已隐藏")}),GM_registerMenuCommand("重置所有设置",function(){confirm("确定要重置所有设置吗？页面将会刷新。")&&(GM_deleteValue("widescreen_enabled"),GM_deleteValue("widescreen_loose"),GM_deleteValue("widescreen_notify_enabled"),GM_deleteValue("widescreen_ui_visible"),GM_deleteValue("widescreen_panel_expanded"),GM_deleteValue("widescreen_panel_position"),GM_deleteValue("userOverride"),GM_deleteValue("lastSystemMode"),window.location.reload())})})();