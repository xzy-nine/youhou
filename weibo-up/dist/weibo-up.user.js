// ==UserScript==
// @name          微博增强
// @namespace     http://tampermonkey.net/
// @version       1.0.4
// @description   微博增强功能：自动适应深色/浅色模式，弹出页查看更多评论，页面宽屏显示，自定义背景图片
// @author        xzy-nine
// @match         https://*.weibo.com/*
// @grant         GM_setValue
// @grant         GM_getValue
// @grant         GM_deleteValue
// @grant         GM_registerMenuCommand
// @grant         GM_addStyle
// @grant         GM_xmlhttpRequest
// @grant         GM_getResourceURL
// @grant         GM_openInTab
// @grant         unsafeWindow
// @run_at        document-start
// @updateURL     https://gh-proxy.com/https://raw.githubusercontent.com/xzy-nine/youhou/main/weibo-up/dist/weibo-up.user.js
// @downloadURL   https://gh-proxy.com/https://raw.githubusercontent.com/xzy-nine/youhou/main/weibo-up/dist/weibo-up.user.js
// @supportURL    https://github.com/xzy-nine/youhou/issues
// @homepageURL   https://github.com/xzy-nine/youhou
// ==/UserScript==
(()=>{"use strict";const e={enabled:GM_getValue("widescreen_enabled",!0),loose:GM_getValue("widescreen_loose",!1),notify_enabled:GM_getValue("widescreen_notify_enabled",!1),ui_visible:GM_getValue("widescreen_ui_visible",!0),panel_expanded:GM_getValue("widescreen_panel_expanded",!0),panel_position:GM_getValue("widescreen_panel_position",null)},n={enabled:GM_getValue("background_enabled",!1),type:GM_getValue("background_type","bing"),url:GM_getValue("background_url",""),opacity:GM_getValue("background_opacity",.2),content_transparency:GM_getValue("background_content_transparency",!0),content_opacity:GM_getValue("background_content_opacity",.7),content_blur:GM_getValue("background_content_blur",5),notify_enabled:GM_getValue("background_notify_enabled",!0)};function t(){GM_setValue("widescreen_enabled",e.enabled),GM_setValue("widescreen_loose",e.loose),GM_setValue("widescreen_notify_enabled",e.notify_enabled),GM_setValue("widescreen_ui_visible",e.ui_visible),GM_setValue("widescreen_panel_expanded",e.panel_expanded),GM_setValue("widescreen_panel_position",e.panel_position)}function o(){GM_setValue("background_enabled",n.enabled),GM_setValue("background_type",n.type),GM_setValue("background_url",n.url),GM_setValue("background_opacity",n.opacity),GM_setValue("background_content_transparency",n.content_transparency),GM_setValue("background_content_opacity",n.content_opacity),GM_setValue("background_content_blur",n.content_blur),GM_setValue("background_notify_enabled",n.notify_enabled)}let a=GM_getValue("userOverride",!1);function r(e,n=null){a=e,GM_setValue("userOverride",e),null!==n&&GM_setValue("userThemeMode",n)}const c="\n/* 新版微博宽屏样式 */\n@media screen and (min-width: 1340px) {\n    :root {\n        --inject-page-width: min(90vw, 1380px);\n    }\n    \n    .inject-widescreen-loose-js {\n        --inject-page-width: 90vw;\n    }\n    \n    /* 新版微博主要布局 */\n    [class*=Frame_content] {\n        --main-width: var(--inject-page-width);\n        width: var(--inject-page-width);\n    }\n    \n    [class*=Frame_content] > div:nth-of-type(2) {\n        flex: 1;\n    }\n    \n    [class*=Frame_main],\n    [class*=Main_full] {\n        flex-grow: 1;\n    }\n    \n    /* 微博内容区域优化 */\n    .woo-box-wrap[class*=picture_inlineNum3] {\n        max-width: 409px;\n    }\n    \n    .u-col-4.woo-box-wrap {\n        max-width: 546px;\n    }\n    \n    [class*=content_row] [class*=card-video_videoBox] {\n        max-width: 540px;\n    }\n    \n    [class*=content_row] [class*=card-article_pic] {\n        max-width: 540px;\n    }\n    \n    [class*=ProfileHeader_pic] {\n        overflow: hidden;\n    }\n    \n    /* 返回顶部按钮 */\n    [class*=Index_backTop] {\n        left: calc(50% + var(--inject-page-width)/2 + var(--frame-mod-gap-space));\n        margin-left: 0;\n        transform: translateX(0);\n    }\n}\n\n/* 视频详情页宽屏样式 */\n@media screen and (min-width: 1450px) {\n    [class*=Frame_content2] {\n        max-width: none;\n        width: var(--inject-page-width);\n    }\n    \n    [class*=Frame_main2] {\n        flex-grow: 1;\n        padding-right: 20px;\n    }\n}\n\n/* 旧版微博宽屏样式 - 兼容支持 */\n@media screen and (min-width: 1300px) {\n    :root {\n        --inject-page-width-legacy: min(75vw, 1330px);\n    }\n    \n    /* 旧版微博主页 */\n    .WB_frame {\n        display: flex;\n        width: var(--inject-page-width-legacy) !important;\n    }\n    \n    .WB_frame #plc_main {\n        display: flex !important;\n        flex: 1;\n        width: auto !important;\n    }\n    \n    .WB_main_c {\n        flex: 1;\n    }\n    \n    .WB_frame_c {\n        flex: 1;\n    }\n    \n    /* 微博类型标签 */\n    .tab_box {\n        display: flex;\n    }\n    \n    .tab_box::after {\n        content: none;\n    }\n    \n    .tab_box .fr_box {\n        flex: 1;\n    }\n    \n    /* 返回顶部按钮 */\n    .W_gotop {\n        left: calc(50% + (var(--inject-page-width-legacy) / 2));\n        margin-left: 0 !important;\n    }\n    \n    /* 微博时间线 */\n    .WB_timeline {\n        left: calc(50% + (var(--inject-page-width-legacy) / 2) + 10px);\n        margin-left: 0;\n    }\n}\n\n/* 微博文章页宽屏样式 */\n@media screen and (min-width: 1150px) {\n    #articleRoot .WB_frame {\n        width: var(--inject-page-width-legacy);\n    }\n    \n    #articleRoot #plc_main {\n        max-width: 100%;\n        width: auto;\n    }\n    \n    #articleRoot .WB_frame_a,\n    #articleRoot .WB_artical {\n        max-width: 100%;\n        width: auto;\n    }\n    \n    #articleRoot .main_toppic {\n        margin-left: auto;\n        margin-right: auto;\n    }\n    \n    #articleRoot .WB_editor_iframe_new {\n        width: auto;\n    }\n    \n    .B_artical [node-type=sidebar]>.W_gotop {\n        left: calc(50% + var(--inject-page-width-legacy)/2);\n        margin-left: 0;\n    }\n}",i="\n/* 用户自定义宽度设置 - 更宽模式 */\n@media screen and (min-width: 1340px) {\n  :root.inject-widescreen-loose-js {\n    --inject-page-width: 95vw !important;\n  }\n  \n  body.inject-widescreen-loose-js {\n    --inject-page-width: 95vw !important;\n  }\n  \n  /* 更宽模式下的特殊调整 */\n  .inject-widescreen-loose-js [class*=Frame_content],\n  .inject-widescreen-loose-js [class*=Frame_content2] {\n    width: var(--inject-page-width) !important;\n    max-width: var(--inject-page-width) !important;\n  }\n  \n  /* 确保返回顶部按钮位置正确 */\n  .inject-widescreen-loose-js [class*=Index_backTop] {\n    left: calc(50% + var(--inject-page-width)/2 + 10px);\n  }\n}\n\n/* 旧版微博更宽模式 */\n@media screen and (min-width: 1300px) {\n  :root.inject-widescreen-loose-js {\n    --inject-page-width-legacy: 95vw !important;\n  }\n  \n  body.inject-widescreen-loose-js {\n    --inject-page-width-legacy: 95vw !important;\n  }\n  \n  .inject-widescreen-loose-js .WB_frame {\n    width: var(--inject-page-width-legacy) !important;\n  }\n  \n  .inject-widescreen-loose-js .W_gotop {\n    left: calc(50% + var(--inject-page-width-legacy)/2 + 10px);\n  }\n  \n  .inject-widescreen-loose-js .WB_timeline {\n    left: calc(50% + var(--inject-page-width-legacy)/2 + 20px);\n  }\n}\n";function l(n){if(!e.notify_enabled)return;console.log(`%c[微博增强] ${n}`,"color: #1890ff; font-weight: bold;");const t=document.createElement("div");t.style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background-color: rgba(255, 255, 255, 0.95);\n    color: #333;\n    padding: 10px 15px;\n    border-radius: 8px;\n    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);\n    z-index: 9999;\n    font-size: 14px;\n    transition: all 0.3s ease;\n    opacity: 0;\n    transform: translateY(-20px);\n  ";(document.documentElement.classList.contains("woo-theme-dark")||document.body.classList.contains("woo-theme-dark"))&&(t.style.backgroundColor="rgba(40, 40, 40, 0.95)",t.style.color="#ddd"),t.textContent=n,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="1",t.style.transform="translateY(0)"},10),setTimeout(()=>{t.style.opacity="0",t.style.transform="translateY(-20px)",setTimeout(()=>{document.body.removeChild(t)},300)},3e3)}function s(){if(!e.enabled)return;const n=document.getElementById("weibo-widescreen-style");if(!n||!n.textContent.includes("--inject-page-width"))return console.log("[微博宽屏] 检测到样式缺失，重新应用样式"),void d(!0);const t=document.documentElement.classList.contains("inject-widescreen-loose-js");e.loose&&!t?(console.log("[微博宽屏] 检测到宽松模式类缺失，重新应用样式"),document.documentElement.classList.add("inject-widescreen-loose-js"),document.body.classList.add("inject-widescreen-loose-js")):!e.loose&&t&&(console.log("[微博宽屏] 检测到不需要宽松模式类，移除"),document.documentElement.classList.remove("inject-widescreen-loose-js"),document.body.classList.remove("inject-widescreen-loose-js"))}function d(n=!1){if(!e.enabled)return void console.log("[微博宽屏] 宽屏功能未启用");const t="weibo-widescreen-style";let o=document.getElementById(t);if(o||(o=document.createElement("style"),o.id=t,document.head.appendChild(o)),o.textContent=c,e.loose){document.documentElement.classList.add("inject-widescreen-loose-js"),document.body.classList.add("inject-widescreen-loose-js");const e="weibo-widescreen-loose-style";let n=document.getElementById(e);n||(n=document.createElement("style"),n.id=e,document.head.appendChild(n)),n.textContent=i}else{document.documentElement.classList.remove("inject-widescreen-loose-js"),document.body.classList.remove("inject-widescreen-loose-js");const e=document.getElementById("weibo-widescreen-loose-style");e&&e.remove()}if(null!==document.querySelector(".woo-box-flex")||null!==document.querySelector('[class*="Frame_wrap"]')||null!==document.querySelector('[class*="Home_wrap"]')){const e=u();e?g(e):setTimeout(()=>{const e=u();e&&g(e)},1e3)}else!function(){if(!e.enabled)return;console.log("[微博宽屏] 检测到旧版微博，正在配置宽屏样式");let n=null,t=null;const o="inject-ws-",a=e=>`${o}${e}`,r=()=>{const{$CONFIG:e}=window;if(!e||!e.location)return;t&&(t.remove(),t=null),[...document.body.classList.values()].forEach(e=>{e.startsWith(o)&&document.body.classList.remove(e)});const n={mainpage:{test:/^v6.*_content_home$/.test(e.location)||/v6_(fav|likes_outbox|content_friends)/.test(e.location),styles:p},profilepage:{test:/^page_.*_(home|photos|manage|myfollow|service|expert|topic)$/.test(e.location),styles:m},singleweibo:{test:/^page_.*_single_weibo$/.test(e.location),styles:b}},r=Object.entries(n).find(([,{test:e}])=>e);if(r){const[e,{styles:n}]=r,o=a(e);document.body.classList.add(o),t=document.createElement("style"),t.textContent=n(o),document.head.appendChild(t),console.log(`[微博宽屏] 应用旧版微博${e}页面宽屏样式`)}};window.$CONFIG&&!n&&(n=new Proxy(window.$CONFIG,{set(e,n,t,o){const a=e[n],c=Reflect.set(e,n,t,o);return"location"===n&&t!==a&&(console.log("[微博宽屏] 页面位置变化，重新应用样式"),setTimeout(r,100)),c}}),window.$CONFIG=n);r(),document.addEventListener("readystatechange",()=>{window.$CONFIG&&r()}),"loading"!==document.readyState&&window.$CONFIG&&r()}();e.loose&&(document.documentElement.classList.add("inject-widescreen-loose-js"),document.body.classList.add("inject-widescreen-loose-js")),document.addEventListener("load",function(n){if("IFRAME"===n.target.tagName)try{const t=n.target.contentDocument||n.target.contentWindow.document;if(t&&t.head){const n=t.createElement("style");if(n.id="widescreen-style",n.textContent=c,t.head.appendChild(n),e.loose){const e=t.createElement("style");e.id="weibo-widescreen-loose-style",e.textContent=i,t.head.appendChild(e),t.documentElement.classList.add("inject-widescreen-loose-js"),t.body&&t.body.classList.add("inject-widescreen-loose-js")}}}catch(e){console.log("无法访问iframe内容（可能是跨域）")}},!0),setInterval(()=>{document.querySelectorAll("iframe").forEach(n=>{try{const t=n.contentDocument||n.contentWindow.document;if(t&&t.head){if(!t.querySelector("#widescreen-style")){const e=t.createElement("style");e.id="widescreen-style",e.textContent=c,t.head.appendChild(e)}const n=!!t.querySelector("#weibo-widescreen-loose-style"),o=t.documentElement.classList.contains("inject-widescreen-loose-js");if(e.loose&&!n){const e=t.createElement("style");e.id="weibo-widescreen-loose-style",e.textContent=i,t.head.appendChild(e)}else if(!e.loose&&n){const e=t.querySelector("#weibo-widescreen-loose-style");e&&e.remove()}e.loose&&!o?(t.documentElement.classList.add("inject-widescreen-loose-js"),t.body&&t.body.classList.add("inject-widescreen-loose-js")):!e.loose&&o&&(t.documentElement.classList.remove("inject-widescreen-loose-js"),t.body&&t.body.classList.remove("inject-widescreen-loose-js"))}}catch(e){}})},2e3),console.log("[微博宽屏] 宽屏样式已"+(n?"更新":"应用")),setTimeout(s,2e3)}function u(){let e=null;return(e=>{const n=()=>{let t=null;const o=document.querySelectorAll("*");for(const e of o)if(e.__vue__&&e.__vue__.$router){t=e.__vue__;break}t?e(t):setTimeout(n,100)};n()})(n=>{e=n}),e}function p(e){return`\n    .${e} .WB_frame {\n      display: flex;\n      width: var(--inject-page-width-legacy) !important;\n    }\n    .${e} #plc_main {\n      display: flex !important;\n      flex: 1;\n      width: auto !important;\n    }\n    .${e} .WB_main_c {\n      flex: 1;\n    }\n    .${e} .tab_box {\n      display: flex;\n    }\n    .${e} .tab_box::after {\n      content: none;\n    }\n    .${e} .tab_box .fr_box {\n      flex: 1;\n    }\n    .${e} .W_gotop {\n      left: calc(50% + (var(--inject-page-width-legacy) / 2));\n      margin-left: 0 !important;\n    }\n  `}function m(e){return`\n    .${e} .WB_frame {\n      width: var(--inject-page-width-legacy) !important;\n    }\n    .${e} .WB_frame_a, \n    .${e} .WB_frame_a_fix {\n      width: 100%;\n    }\n    .${e} #plc_main {\n      width: 100% !important;\n      display: flex;\n    }\n    .${e} #plc_main > div:last-child {\n      margin-right: 0;\n    }\n    .${e} .WB_frame_c .input_simple_wrap .inputfunc_simple_wrap {\n      width: calc(100% - 80px);\n    }\n    .${e} .WB_frame_c {\n      flex: 1;\n    }\n    .${e} .WB_timeline {\n      left: calc(50% + (var(--inject-page-width-legacy) / 2) + 10px);\n      margin-left: 0;\n    }\n    .${e} .W_gotop {\n      left: calc(50% + (var(--inject-page-width-legacy) / 2));\n      margin-left: 0 !important;\n    }\n  `}function b(e){return`\n    .${e} .WB_frame {\n      width: var(--inject-page-width-legacy) !important;\n    }\n    .${e} #plc_main {\n      display: flex !important;\n      width: auto !important;\n    }\n    .${e} #plc_main .WB_frame_c {\n      flex: 1;\n    }    .${e} .W_gotop {\n      left: calc(50% + (var(--inject-page-width-legacy) / 2) - 19px);\n      margin-left: 0 !important;\n    }\n  `}function g(n){if(console.log("[微博宽屏] 设置新版微博宽屏样式"),!e.enabled||!n)return;const t=new Map([[["home","mygroups","profile","nameProfile","customProfile","bidDetail","atWeibo","cmtInbox","likeInbox","follow","myFollowTab","fav","like","weibo","list","topic","search","searchResult"],"home"],[["Playdetail"],"video"]]),o=n=>{if(!e.enabled)return;const t=document.getElementById("weibo-widescreen-style");if(!t||!t.textContent){const e=document.createElement("style");e.id="weibo-widescreen-style",e.textContent=c,document.head.appendChild(e)}if(e.loose){document.documentElement.classList.add("inject-widescreen-loose-js"),document.body.classList.add("inject-widescreen-loose-js");let e=document.getElementById("weibo-widescreen-loose-style");e||(e=document.createElement("style"),e.id="weibo-widescreen-loose-style",e.textContent=i,document.head.appendChild(e))}console.log(`[微博宽屏] 应用新版微博${n}页面宽屏样式`),e.notify_enabled&&l("微博宽屏模式已启用"),document.dispatchEvent(new CustomEvent("widescreenStyleApplied",{detail:{pageType:n,isLoose:e.loose}}))};if(n.$router){n.$router.afterEach(e=>{console.log("[微博宽屏] 路由变化:",e.name);for(const[n,a]of t.entries())if(n.includes(e.name)){o(a);break}});const e=n.$route;if(e){for(const[n,a]of t.entries())if(n.includes(e.name)){o(a);break}}else o("home")}else o("home")}let y=null,f=null,h=!1,w=!1;function v(){const e=window.matchMedia("(prefers-color-scheme: dark)").matches;GM_setValue("lastSystemMode",e);const n=GM_getValue("userThemeMode",null);setTimeout(()=>{if(a){const e=null!==n?n:x();console.log(`用户手动设置为${e?"深色":"浅色"}模式，保持不变`),_(e,!1),y=e}else{const e=window.matchMedia("(prefers-color-scheme: dark)").matches,n=x();console.log("[微博主题] 跟随系统模式: "+(e?"深色":"浅色")),n!==e&&_(e,!1),y=e}f=a},500),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",n=>{const t=n.matches;GM_getValue("lastSystemMode",e);GM_setValue("lastSystemMode",t),console.log("[微博主题] 系统模式变化: "+(t?"深色":"浅色")),a||(_(t,!1),y!==t&&(l(`已切换到${t?"深色":"浅色"}模式`),y=t))}),function(){const e=localStorage.setItem;localStorage.setItem=function(n,t){const o=e.apply(this,arguments);if(("darkModeHistory"===n||"weiboThemeMode"===n)&&!w)try{let e=!1;if("darkModeHistory"===n)try{const n=JSON.parse(t);n&&n.length>0&&n[0].length>1&&(e=1===n[0][1])}catch(e){console.error("[微博主题] 无法解析主题设置:",e)}else"weiboThemeMode"===n&&(e="dark"===t);x()!==e&&(console.log(`[微博主题] 检测到用户手动切换为${e?"深色":"浅色"}模式`),a=!0,r(!0,e),k(e),!0===f&&y===e&&h||(l(`已手动切换为${e?"深色":"浅色"}模式`),y=e,f=!0,h=!0))}catch(e){console.error(`[微博主题] 解析${n}时出错:`,e)}return o},window.addEventListener("storage",e=>{if(!w&&"darkModeHistory"===e.key)try{const n=e.newValue;if(n){const e=JSON.parse(n);if(e&&e.length>0&&e[0].length>1){const n=1===e[0][1];console.log("[微博主题] 检测到用户通过微博界面切换主题: "+(n?"深色":"浅色")),a=!0,r(!0,n),k(n),y===n&&!0===f||(l(`已切换为${n?"深色":"浅色"}模式`),y=n,f=!0)}}}catch(e){console.error("[微博主题] 处理localStorage事件时出错:",e)}})}()}function x(){try{const e=localStorage.getItem("darkModeHistory");if(e){const n=JSON.parse(e);if(n&&n.length>0&&n[0].length>1)return 1===n[0][1]}}catch(e){}return!!document.body&&document.body.classList.contains("woo-theme-dark")}function _(e,n=!1){try{w=!0;const t=function(){let e=null;try{const n=localStorage.getItem("darkModeHistory");if(n){const t=JSON.parse(n);t&&t.length>0&&t[0].length>0&&(e=t[0][0])}}catch(e){console.error("解析darkModeHistory失败:",e)}if(!e){const n=document.documentElement.outerHTML.match(/uid=(\d+)/);n&&n[1]&&(e=parseInt(n[1],10))}return e||0}(),o=e?1:0;localStorage.setItem("darkModeHistory",`[[${t},${o}]]`);const a=()=>{if(document.body){document.body.classList.remove("woo-theme-dark","woo-theme-light"),e?(document.body.classList.add("woo-theme-dark"),document.documentElement.setAttribute("data-theme","dark")):(document.body.classList.add("woo-theme-light"),document.documentElement.setAttribute("data-theme","light")),console.log(`[微博主题] 已设置为${e?"深色":"浅色"}模式`),k(e);try{const n=new CustomEvent("themechange",{detail:{theme:e?"dark":"light"}});window.dispatchEvent(n)}catch(e){}}else setTimeout(a,100)};return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",a):a(),n||(w=!1),!0}catch(e){return w=!1,console.error("[微博主题] 设置主题模式时出错:",e),!1}}function k(e){document.querySelectorAll(".comment-modal").forEach(n=>{n.setAttribute("data-theme",e?"dark":"light");const t=n.querySelector(".comment-modal-iframe");if(t)try{const n=t.contentDocument||t.contentWindow.document;n&&n.body&&(n.body.classList.remove("woo-theme-dark","woo-theme-light"),n.body.classList.add(e?"woo-theme-dark":"woo-theme-light"))}catch(e){console.log("[微博主题] 无法更新iframe主题（可能是跨域）:",e)}})}const E="\n.comment-modal-overlay {\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.5);\n    z-index: 10000;\n    display: flex;\n    justify-content: flex-start;\n    align-items: center;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n.comment-modal-overlay.show {\n    opacity: 1;\n}\n\n/* 右侧点击区域提示 */\n.comment-modal-overlay::after {\n    content: '';\n    position: absolute;\n    top: 0;\n    right: 0;\n    width: 100px;\n    height: 100%;\n    background: linear-gradient(to left, rgba(0, 0, 0, 0.1), transparent);\n    pointer-events: none;\n    transition: background 0.2s ease;\n}\n\n.comment-modal-overlay:hover::after {\n    background: linear-gradient(to left, rgba(0, 0, 0, 0.2), transparent);\n}\n\n.comment-modal {\n    background: var(--bg-color, #ffffff);\n    border-radius: 0 45px 45px 0;\n    box-shadow: 2px 0 40px rgba(0, 0, 0, 0.15);\n    max-width: calc(100% - 100px);\n    height: calc(100vh - 40px);\n    width: calc(100% - 100px);\n    margin: 20px 100px 20px 0;\n    position: relative;\n    overflow: hidden;\n    transform: translateX(-100%);\n    transition: transform 0.3s ease;\n}\n\n.comment-modal-overlay.show .comment-modal {\n    transform: translateX(0);\n}\n\n.comment-modal-header {\n    padding: 12px 20px;\n    border-bottom: 1px solid var(--border-color, #e1e8ed);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    background: var(--header-bg, #f7f9fa);\n    border-radius: 0 45px 0 0;\n    min-height: 40px;\n}\n\n.comment-modal-title {\n    font-size: 14px;\n    font-weight: bold;\n    color: var(--text-color, #14171a);\n}\n\n.comment-modal-close {\n    width: 28px;\n    height: 28px;\n    border: none;\n    background: none;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 50%;\n    transition: background-color 0.2s;\n}\n\n.comment-modal-close:hover {\n    background-color: var(--hover-bg, #f0f0f0);\n}\n\n.comment-modal-close::before {\n    content: '×';\n    font-size: 20px;\n    color: var(--text-color, #657786);\n}\n\n.comment-modal-content {\n    padding: 0;\n    height: calc(100vh - 100px);\n    overflow: hidden;\n    position: relative;\n}\n\n.comment-modal-iframe {\n    width: 100%;\n    height: 100%;\n    border: none;\n    background: var(--bg-color, #ffffff);\n}\n\n.comment-modal-loading {\n    padding: 40px;\n    text-align: center;\n    color: var(--text-color, #657786);\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: var(--bg-color, #ffffff);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 1;\n}\n\n/* 深色模式样式 */\nbody.woo-theme-dark .comment-modal,\n.comment-modal[data-theme=\"dark\"] {\n    --bg-color: #1d1f23;\n    --border-color: #38444d;\n    --header-bg: #15181c;\n    --text-color: #ffffff;\n    --hover-bg: #273340;\n}\n\n/* 浅色模式样式 */\nbody.woo-theme-light .comment-modal,\n.comment-modal[data-theme=\"light\"] {\n    --bg-color: #ffffff;\n    --border-color: #e1e8ed;\n    --header-bg: #f7f9fa;\n    --text-color: #14171a;\n    --hover-bg: #f0f0f0;\n}\n\n/* 滚动条样式 */\n.comment-modal-content::-webkit-scrollbar {\n    width: 6px;\n}\n\n.comment-modal-content::-webkit-scrollbar-track {\n    background: transparent;\n}\n\n.comment-modal-content::-webkit-scrollbar-thumb {\n    background: var(--border-color, #e1e8ed);\n    border-radius: 3px;\n}\n\n.comment-modal-content::-webkit-scrollbar-thumb:hover {\n    background: var(--text-color, #657786);\n}\n";function L(){!function(){const e=document.createElement("style");e.textContent=E,document.head.appendChild(e)}(),document.addEventListener("click",function(n){const t=n.target.closest("a[href]");if(!t)return;const o=t.textContent||t.innerText||"";let a=t.getAttribute("href");if(a&&"#"!==a&&!a.startsWith("javascript:")&&(console.log("检测到链接点击:",{target:t,linkText:o.trim(),href:a,className:t.className}),o.includes("查看全部")&&o.includes("评论")||/查看全部\s*\d+\s*条?评论/.test(o)||/^\s*\d+\s*条?评论?\s*$/.test(o)&&(a.includes("/status/")||a.includes("/detail/")))){if(console.log("拦截查看全部评论链接:",o.trim()),n.preventDefault(),n.stopPropagation(),!a){const e=t.closest("article");if(e){const n=e.querySelector('a[href*="/status/"], a[href*="/detail/"], a[href*="/u/"]');if(n&&(a=n.getAttribute("href")),!a){const n=e.querySelector("[data-mid], [mid]");if(n){const e=n.getAttribute("data-mid")||n.getAttribute("mid");e&&(a=`/detail/${e}`)}}if(!a){const n=e.querySelector("[data-itemid], [data-id]");if(n){const e=n.getAttribute("data-itemid")||n.getAttribute("data-id");e&&(a=`/detail/${e}`)}}}}if(!a){const e=document.querySelectorAll('a[href*="/status/"], a[href*="/detail/"]');if(e.length>0){const n=Array.from(e).find(e=>{const n=e.getBoundingClientRect(),o=t.getBoundingClientRect();return Math.abs(n.top-o.top)<200});n&&(a=n.getAttribute("href"))}}if(!a){const e=window.location.href;if(e.includes("/status/"))a=e;else if(e.includes("/detail/"))a=e;else if(e.includes("/u/")){const e=document.querySelector('a[href*="/status/"], a[href*="/detail/"]');e&&(a=e.getAttribute("href"))}}if(!a){const e=document.querySelectorAll("script");for(const n of e){const e=n.textContent||n.innerText,t=e.match(/"mid":\s*"([^"]+)"/);if(t&&t[1]){a=`/detail/${t[1]}`;break}const o=e.match(/\/status\/(\w+)/);if(o&&o[1]){a=`/status/${o[1]}`;break}}}if(!a)return console.log("无法确定评论页面URL，尝试的元素:",t),console.log("当前页面URL:",window.location.href),void(e.notify_enabled&&window.simpleNotify&&window.simpleNotify("未找到评论页面链接"));const r=o.match(/(\d+)/);r&&r[1],!function(n){const t=function(){const e=document.createElement("div");e.className="comment-modal-overlay";const n=x();e.innerHTML=`\n      <div class="comment-modal" data-theme="${n?"dark":"light"}">\n          <div class="comment-modal-header">\n              <div class="comment-modal-title">评论</div>\n              <button class="comment-modal-close" aria-label="关闭"></button>\n          </div>\n          <div class="comment-modal-content">\n              <div class="comment-modal-loading">加载中...</div>\n          </div>\n      </div>\n  `,document.body.appendChild(e),e.querySelector(".comment-modal-close").addEventListener("click",()=>{$(e)}),e.addEventListener("click",n=>{(n.clientX>window.innerWidth-100||n.target===e)&&$(e)});const t=n=>{"Escape"===n.key&&($(e),document.removeEventListener("keydown",t))};return document.addEventListener("keydown",t),e}();t.querySelector(".comment-modal-title").textContent="详情";const o=t.querySelector(".comment-modal"),a=x();o&&o.setAttribute("data-theme",a?"dark":"light"),setTimeout(()=>{t.classList.add("show")},10),function(n,t){const o=n.querySelector(".comment-modal-content"),a=o.querySelector(".comment-modal-loading");try{const n=document.createElement("iframe");n.className="comment-modal-iframe",n.src=t,n.onload=function(){a&&(a.style.display="none");try{const t=n.contentDocument||n.contentWindow.document;if(t&&t.head&&e.enabled){const e=x();e?(t.body.classList.add("woo-theme-dark"),t.body.classList.remove("woo-theme-light")):(t.body.classList.add("woo-theme-light"),t.body.classList.remove("woo-theme-dark"));const o=n.closest(".comment-modal");o&&o.setAttribute("data-theme",e?"dark":"light");const a=t.createElement("style");a.id="widescreen-style",a.textContent=c,t.head.appendChild(a),console.log("已向评论iframe注入宽屏样式")}}catch(e){console.log("无法向iframe注入样式（可能是跨域）:",e)}},n.onerror=function(){a&&(a.textContent="加载评论失败，请稍后重试")},o.appendChild(n)}catch(e){console.error("创建iframe失败:",e),a&&(a.textContent="加载评论失败，请稍后重试")}}(t,n)}(a.startsWith("http")?a:a.startsWith("//")?"https:"+a:a.startsWith("/")?window.location.origin+a:window.location.href.split("?")[0]+"/"+a),e.notify_enabled&&window.simpleNotify&&window.simpleNotify("正在加载评论内容...")}},!0),document.addEventListener("keydown",e=>{e.ctrlKey&&e.shiftKey&&"D"===e.key&&(e.preventDefault(),function(){console.log("=== 微博评论元素分析 ==="),['a[href*="comment"]','div[class*="comment"]','span[class*="comment"]','i[class*="comment"]','div[class*="toolbar"]',"footer",'[class*="Feed_func"]','a:contains("评论")','div:contains("条评论")'].forEach(e=>{try{const n=document.querySelectorAll(e);n.length>0&&(console.log(`找到 ${n.length} 个 "${e}" 元素:`),n.forEach((e,n)=>{n<5&&console.log(`  ${n+1}. 文本: "${e.textContent.trim()}", 类名: "${e.className}", 标签: ${e.tagName}`)}),n.length>5&&console.log(`  ... 还有 ${n.length-5} 个元素未显示`))}catch(e){}});const e=document.querySelectorAll("script");console.log("页面中的微博ID信息:");for(const n of e){const e=n.textContent||n.innerText;if(e.includes("mid")||e.includes("status")){const n=e.match(/"mid":\s*"([^"]+)"/g),t=e.match(/\/status\/(\w+)/g);n&&console.log("  找到MID:",n.slice(0,3)),t&&console.log("  找到Status:",t.slice(0,3));break}}console.log("当前页面URL:",window.location.href),console.log("=== 分析完成 ===")}())})}function $(e){e.classList.remove("show"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}const j="weibo_bing_background";
/**
 * 获取必应每日图片
 * @returns {Promise<string|null>} 图片URL，失败返回null
 */
async function C(){try{console.log("[微博背景] 尝试获取必应每日图片"),l("正在获取必应每日图片...");const e=GM_getValue(j,null),n=Date.now();if(e&&n-e.timestamp<864e5)return console.log("[微博背景] 使用缓存的必应图片"),e.url;let t=null;try{const e="https://cn.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1",n="https://cn.bing.com";console.log(`[微博背景] 尝试从官方API获取必应图片: ${e}`);const o=(await new Promise((n,t)=>{GM_xmlhttpRequest({method:"GET",url:e,responseType:"json",timeout:8e3,onload:e=>{e.status>=200&&e.status<300?n(e):t(new Error(`HTTP error! Status: ${e.status}`))},onerror:e=>t(e),ontimeout:()=>t(new Error("请求超时"))})})).response;if(!o||!o.images||!o.images.length)throw new Error("从官方API响应中未找到图片");if(!o.images[0].url)throw new Error("必应API返回的图片URL为空");t=n+o.images[0].url,console.log("[微博背景] 官方API获取成功:",t)}catch(e){console.error("[微博背景] 官方API获取失败:",e);try{const e="https://api.kdcc.cn";console.log(`[微博背景] 尝试从备用API获取必应图片: ${e}`);const n=await new Promise((n,t)=>{GM_xmlhttpRequest({method:"GET",url:e,timeout:8e3,onload:e=>{e.status>=200&&e.status<300?n(e):t(new Error(`HTTP error! Status: ${e.status}`))},onerror:e=>t(e),ontimeout:()=>t(new Error("请求超时"))})});if(t=n.responseText.trim(),!t||t.length<10)throw new Error("备用API返回的URL无效");if(!(t&&(t.startsWith("http://")||t.startsWith("https://"))&&(t.includes(".jpg")||t.includes(".jpeg")||t.includes(".png")||t.includes(".webp"))))throw console.error("[微博背景] 备用API返回的URL格式无效:",t),new Error("备用API返回的URL格式无效");if(!await new Promise(e=>{const n=new Image;n.onload=()=>{const o=n.width>=800&&n.height>=800;o||console.error(`[微博背景] 备用API图片尺寸过小: ${n.width}x${n.height}`,t),e(o)},n.onerror=()=>{console.error("[微博背景] 检查备用API图片尺寸时加载失败"),e(!1)},n.src=t,setTimeout(()=>{n.complete||(console.error("[微博背景] 检查备用API图片尺寸超时"),e(!1))},3e3)}))throw new Error("备用API返回的图片尺寸过小或无法加载");console.log("[微博背景] 备用API获取成功:",t)}catch(e){throw console.error("[微博背景] 备用API获取也失败:",e),new Error("官方和备用API都获取失败")}}const o=t+(t.includes("?")?"&":"?")+"_t="+n;if(!(o&&(o.startsWith("http://")||o.startsWith("https://"))&&(o.includes(".jpg")||o.includes(".jpeg")||o.includes(".png")||o.includes(".webp"))))throw console.error("[微博背景] 获取到的URL可能无效:",o),new Error("获取到的必应图片URL格式可能无效");if(!await new Promise(e=>{const n=new Image;n.onload=()=>{const t=n.width>=800&&n.height>=800;t||console.error(`[微博背景] 图片尺寸过小: ${n.width}x${n.height}`,o),e(t)},n.onerror=()=>{console.error("[微博背景] 检查图片尺寸时加载失败"),e(!1)},n.src=o,setTimeout(()=>{n.complete||(console.error("[微博背景] 检查图片尺寸超时"),e(!1))},3e3)}))throw new Error("获取到的必应图片尺寸过小或无法加载");return GM_setValue(j,{url:o,timestamp:n}),console.log("[微博背景] 成功获取必应图片：",o),o}catch(e){console.error("[微博背景] 获取必应图片出错:",e);let n="获取必应每日图片失败";e.message&&e.message.includes("尺寸过小")&&(n="获取到的图片尺寸过小，不适合作为背景",console.warn("[微博背景] 图片尺寸不满足要求，需要至少800x800像素")),l(`${n}，将使用淡蓝色背景`);const t=GM_getValue(j,null);if(t&&t.url){console.log("[微博背景] 使用上一个缓存的必应图片");return(new Image).src=t.url,t.url}return console.log("[微博背景] 无有效缓存，将使用淡蓝色背景"),null}}
/**
 * 将File对象转换为Base64 URL
 * @param {File} file 用户上传的文件
 * @returns {Promise<string>} base64编码的URL
 */
/**
 * 创建文件选择器用于用户上传图片
 * @returns {Promise<string|null>} 返回Base64格式的图片数据URL
 */
function M(){return new Promise(e=>{try{console.log("[微博背景] 创建文件选择器");const n=document.createElement("div");n.setAttribute("id","weibo-image-selector-overlay"),n.style.cssText="\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(0,0,0,0.7);\n                z-index: 10000;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            ";const t=document.createElement("div");t.setAttribute("id","weibo-image-uploader"),t.style.cssText="\n                width: 350px;\n                padding: 20px;\n                background: white;\n                border-radius: 8px;\n                box-shadow: 0 4px 16px rgba(0,0,0,0.2);\n                text-align: center;\n            ",t.innerHTML='\n                <h3 style="margin-top:0;color:#333;font-size:16px;">选择背景图片</h3>\n                <p style="color:#666;margin-bottom:15px;font-size:14px;">选择本地图片或输入图片URL</p>\n                <div style="margin:20px 0;display:flex;flex-direction:column;gap:10px;">\n                    <button id="weibo-upload-file-btn" style="width:100%;padding:10px;background:#1890ff;color:white;border:none;border-radius:4px;cursor:pointer;font-size:14px;">选择本地图片</button>\n                    <button id="weibo-url-input-btn" style="width:100%;padding:10px;background:#f0f0f0;color:#333;border:1px solid #d9d9d9;border-radius:4px;cursor:pointer;font-size:14px;">输入图片URL</button>\n                    <button id="weibo-cancel-upload-btn" style="width:100%;padding:10px;background:#fff;color:#999;border:1px solid #d9d9d9;border-radius:4px;cursor:pointer;font-size:14px;margin-top:5px;">取消</button>\n                </div>\n                <div id="weibo-upload-status" style="margin-top:15px;padding:10px;font-size:13px;color:#ff8800;display:none;background:#fffbe6;border-radius:4px;"></div>\n            ',n.appendChild(t),document.body.appendChild(n);const o=document.createElement("input");o.setAttribute("id","weibo-file-input"),o.type="file",o.accept="image/*",o.style.cssText="position:absolute;top:-9999px;left:-9999px;",document.body.appendChild(o);const a=t.querySelector("#weibo-upload-status"),r=(e,n=!1)=>{a.textContent=e,a.style.display="block",a.style.color=n?"#ff4d4f":"#ff8800",a.style.background=n?"#fff2f0":"#fffbe6",a.style.border=n?"1px solid #ffccc7":"1px solid #ffe58f"};t.querySelector("#weibo-cancel-upload-btn").addEventListener("click",()=>{n.remove(),o.remove(),e(null)}),t.querySelector("#weibo-upload-file-btn").addEventListener("click",()=>{try{o.click()}catch(t){console.error("[微博背景] 点击文件输入失败:",t),r("无法打开文件选择器，请尝试输入URL",!0),setTimeout(async()=>{n.remove(),o.remove();const t=await I();e(t)},2e3)}}),t.querySelector("#weibo-url-input-btn").addEventListener("click",async()=>{n.remove(),o.remove();const t=await I();e(t)}),o.addEventListener("change",async()=>{try{const t=o.files&&o.files[0];if(!t)return void r("未选择文件",!0);if(t.size>10485760)return void r("文件太大，请选择小于10MB的图片",!0);if(!t.type.match("image.*"))return void r("请选择图片文件",!0);console.log("[微博背景] 文件已选择:",t.name,t.type,Math.round(t.size/1024),"KB"),r("正在处理图片，请稍候...");try{const a=await function(e){return new Promise((n,t)=>{const o=new FileReader;o.onload=()=>n(o.result),o.onerror=t,o.readAsDataURL(e)})}(t);if(!a||!a.startsWith("data:image/"))return void r("图片处理失败，请重试",!0);n.remove(),o.remove(),e(a)}catch(e){console.error("[微博背景] 读取文件失败:",e),r("读取图片失败，请重试或选择其他图片",!0)}}catch(e){console.error("[微博背景] 处理文件选择时出错:",e),r("处理文件失败",!0)}});const c=t=>{"Escape"===t.key&&(n.remove(),o.remove(),document.removeEventListener("keydown",c),e(null))};document.addEventListener("keydown",c),setTimeout(()=>{document.body.contains(n)&&(console.log("[微博背景] 文件选择器超时，自动关闭"),n.remove(),o.remove(),e(null))},12e4)}catch(n){console.error("[微博背景] 创建文件选择器失败:",n),l("无法打开文件选择对话框，将使用URL输入方式"),setTimeout(async()=>{const n=await I();e(n)},500)}})}
/**
 * 根据当前设置获取背景图片URL
 * @returns {Promise<string|null>} 背景图片URL或null
 */
/**
 * 设置背景类型
 * @param {'bing'|'custom'} type 背景类型
 */
function S(e){console.log("[微博背景] 设置背景类型为:",e),"bing"!==e&&"custom"!==e&&(console.error("[微博背景] 无效的背景类型:",e),l("无效的背景类型，使用默认值"),e="bing"),"custom"!==e||n.url&&""!==n.url.trim()||(console.log("[微博背景] 切换到自定义模式但缺少URL，将触发上传流程"),setTimeout(()=>{q().then(e=>{e||(console.log("[微博背景] 用户取消上传，回退到必应图片"),n.type="bing",o(),B())})},100)),l(`正在切换到${"bing"===e?"必应每日图片":"自定义图片"}...`),n.type=e,o(),n.enabled||(console.log("[微博背景] 背景功能未启用，自动启用"),n.enabled=!0,o());let t=document.getElementById("weibo-background-loading");t||(t=document.createElement("div"),t.id="weibo-background-loading",t.textContent="加载中...",t.style.position="fixed",t.style.top="10px",t.style.right="10px",t.style.padding="5px 10px",t.style.backgroundColor="rgba(0,0,0,0.5)",t.style.color="white",t.style.borderRadius="4px",t.style.zIndex="9999",t.style.fontSize="12px",document.body.appendChild(t));const a=document.getElementById("weibo-blur-background");a&&a.remove(),setTimeout(()=>{B().then(()=>{t&&t.parentNode&&t.remove()})},50)}
/**
 * 设置背景不透明度
 * @param {number} opacity 不透明度 (0-1)
 */
/**
 * 切换背景启用状态
 * @returns {boolean} 新的启用状态
 */
function T(){return n.enabled=!n.enabled,o(),B(),n.enabled}
/**
 * 清除必应图片缓存
 * 用于强制刷新背景图片，解决图片过期或加载问题
 * @returns {boolean} 是否成功清除缓存
 */
/**
 * 获取用户输入的图片URL
 * @returns {Promise<string|null>} 用户输入的URL或null
 */
function I(){return new Promise(async e=>{let n="";try{const e=GM_getValue(j,null);if(e&&e.url)n=e.url;else{const e=await C();e&&(n=e)}}catch(e){console.error("[微博背景] 获取示例URL失败:",e)}const t=prompt("请输入图片URL或粘贴图片链接:",n);if(!t||""===t.trim())return void e(null);if(!/\.(jpg|jpeg|png|gif|bmp|webp)(\?.*)?$/i.test(t)){if(!confirm("输入的URL可能不是有效的图片链接，是否仍然使用？"))return void e(null)}e(t.trim())})}
/**
 * 上传自定义背景图片
 * @returns {Promise<boolean>}
 */async function q(){try{l("正在打开图片选择器...");const e=await new Promise(async e=>{const n=await M();if(n)return console.log("[微博背景] 已获取图片数据，应用为背景"),void e({type:"dataUrl",url:n});console.log("[微博背景] 文件选择器未返回图片，尝试URL输入");const t=await I();e(t?{type:"url",url:t}:null)});return e?(l("图片已选择，正在应用..."),n.url=e.url,n.type="custom",o(),new Promise(t=>{const a=new Image;a.onload=()=>{console.log("[微博背景] 图片加载成功，尺寸:",a.width,"x",a.height),B(),l("自定义背景图片应用成功"),t(!0)},a.onerror=()=>{console.error("[微博背景] 自定义图片加载失败:",e.url.substring(0,50)+"..."),l("图片加载失败，请尝试其他图片"),n.type="bing",o(),B(),t(!1)};const r=setTimeout(()=>{a.complete||(console.error("[微博背景] 图片加载超时"),a.src="",l("图片加载超时，请尝试其他图片"),n.type="bing",o(),B(),t(!1))},1e4);a.onload=()=>{clearTimeout(r),console.log("[微博背景] 图片加载成功"),B(),l("自定义背景图片应用成功"),t(!0)},a.src=e.url})):(console.log("[微博背景] 用户取消了图片选择"),!1)}catch(e){console.error("[微博背景] 上传图片失败:",e),l("上传图片失败，请尝试直接输入图片URL");const t=await I();if(t){n.url=t,n.type="custom",o();const e=new Image;return e.onload=()=>B(),e.onerror=()=>{n.type="bing",o(),B(),l("图片URL无法访问，已切换到必应每日图片")},e.src=t,!0}return!1}}async function B(){console.log("[微博背景] 开始应用背景图片...");try{let e=document.getElementById("weibo-blur-background");if(e&&(e.remove(),console.log("[微博背景] 已移除旧背景元素")),G(),!n.enabled)return void console.log("[微博背景] 背景功能未启用，不应用背景");"custom"!==n.type||n.url&&""!==n.url.trim()||(console.log("[微博背景] 自定义背景URL为空，自动切换到必应背景"),n.type="bing",o()),console.log("[微博背景] 当前背景设置:",{enabled:n.enabled,type:n.type,opacity:n.opacity,hasCustomUrl:!!n.url}),e=document.createElement("div"),e.id="weibo-blur-background";const t=`\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            width: 100vw;\n            height: 100vh;\n            background-size: cover;\n            background-position: center;\n            background-repeat: no-repeat;\n            opacity: ${n.opacity}; /* 使用配置的透明度 */\n            z-index: -1; /* 改为-1，确保在最底层但仍然可见 */\n            pointer-events: none;\n            will-change: opacity; /* 优化性能 */\n            transition: opacity 0.5s ease;\n            background-color: rgba(173, 216, 230, 0.5); /* 提高初始背景色透明度便于调试 */\n        `;e.style.cssText=t,document.body.firstChild?document.body.insertBefore(e,document.body.firstChild):document.body.appendChild(e),A(),G();const a=await async function(){return n.enabled?"bing"===n.type?await C():"custom"===n.type?n.url&&""!==n.url.trim()?(console.log("[微博背景] 使用自定义背景图片"),n.url):(console.log("[微博背景] 自定义背景URL无效，尝试切换到必应图片"),n.type="bing",o(),await C()):null:null}();if(!a)return console.error("[微博背景] 无法应用背景，URL为空"),void l("无法加载背景图片，请尝试切换背景类型或刷新页面");console.log("[微博背景] 获取到背景URL:",a.substring(0,100)+"...");const r=new Image;let c=!1;r.onload=()=>{c=!0,clearTimeout(i),console.log("[微博背景] 背景图片加载成功"),e.style.backgroundImage=`url("${a}")`,setTimeout(()=>{const e=document.getElementById("weibo-blur-background");e&&(e.style.backgroundColor="transparent",l("背景图片应用成功"))},300)},r.onerror=()=>{c=!1,console.error("[微博背景] 背景图片加载失败:",a),l("背景图片加载失败，使用纯色背景"),e.style.backgroundImage="none",e.style.backgroundColor="rgba(173, 216, 230, 0.3)",GM_setValue(j,null),console.log("[微博背景] 使用淡蓝色背景作为回退")};const i=setTimeout(()=>{c||(console.error("[微博背景] 背景图片加载超时:",a),r.onerror())},8e3);r.src=a,console.log("[微博背景] 已将背景元素添加到页面，正在加载图片"),function(){window.__weiboBackgroundObserver=null,window.__weiboBackgroundObserver&&window.__weiboBackgroundObserver.disconnect();const e=setInterval(()=>{if(n.enabled){const e=document.getElementById("weibo-blur-background");if(e){const t=window.getComputedStyle(e);"none"!==t.display&&0!==parseFloat(t.opacity)&&"hidden"!==t.visibility||(console.log("[微博背景] 定期检查: 背景元素不可见，重置样式"),e.style.display="block",e.style.opacity=n.opacity,e.style.visibility="visible")}else console.log("[微博背景] 定期检查: 背景元素丢失，重新应用背景"),B()}},5e3);window.__weiboBackgroundCheckInterval=e;const t=new MutationObserver(e=>{window.__weiboBackgroundDebounce&&clearTimeout(window.__weiboBackgroundDebounce),window.__weiboBackgroundDebounce=setTimeout(()=>{if(!n.enabled){const e=document.getElementById("weibo-blur-background");return void(e&&(console.log("[微博背景] 检测到背景功能已关闭，移除背景元素"),e.remove()))}if(n.enabled){if(!document.getElementById("weibo-blur-background"))return console.log("[微博背景] 检测到背景元素丢失，重新应用背景"),void B()}const e=document.getElementById("weibo-blur-background");if(e){const t=window.getComputedStyle(e);(parseInt(t.zIndex)<-1||0===parseFloat(t.opacity))&&(console.log("[微博背景] 检测到背景元素样式异常，正在修复 z-index:",t.zIndex,"opacity:",t.opacity),e.style.zIndex="-1",e.style.opacity=n.opacity,e.style.display="block",e.style.visibility="visible"),A()}},300)});t.observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class","id"]}),window.__weiboBackgroundObserver=t,console.log("[微博背景] 已设置背景持久性监视")}()}catch(e){console.error("[微博背景] 应用背景时出错:",e),l("应用背景图片时出错，请查看控制台获取详细信息")}}function A(){const e=[document.querySelector("#app > div.woo-box-flex.woo-box-column.Frame_wrap_3g67Q"),document.querySelector("#app"),document.querySelector("#homeWrap"),document.querySelector("#react-root"),document.querySelector(".Frame_content_3XrxZ"),document.querySelector(".Frame_side_2mgLd"),document.querySelector(".wbpro-side-main")];if(n.enabled&&n.content_transparency){const e=["article","#scroller > div.vue-recycle-scroller__item-wrapper > div > div > article","#scroller > div.vue-recycle-scroller__item-wrapper > div:nth-child(n) > div > article"].join(", "),t=document.querySelectorAll(e);console.log(`[微博背景] 找到 ${t.length} 个微博文章容器`),t.forEach(e=>{if(e){const t=n.content_blur||5,o=document.documentElement.classList.contains("woo-theme-dark"),a=void 0!==n.content_bg_opacity?n.content_bg_opacity:.3,r=o?`rgba(0, 0, 0, ${a})`:`rgba(255, 255, 255, ${a})`;e.style.backgroundColor=r,e.style.backdropFilter=`blur(${t}px)`,e.style.borderRadius="8px",e.style.margin="5px 0",e.style.padding="10px",e.style.transition="backdrop-filter 0.3s ease, background-color 0.3s ease",e.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)";e.querySelectorAll('.wbpro-feed-content, [class*="feed-content"], [class*="Feed_body"] > div').forEach(e=>{e.style.backgroundColor="transparent",e.style.boxShadow="none",e.style.borderRadius="0"})}});const o=[".content:not(article .content)",".card-feed:not(article .card-feed)",".wb-item .content",".card-wrap .card-feed"].join(", "),a=document.querySelectorAll(o);console.log(`[微博背景] 找到 ${a.length} 个其他微博内容容器`),a.forEach(e=>{if(e){const t=n.content_blur||5,o=document.documentElement.classList.contains("woo-theme-dark"),a=void 0!==n.content_bg_opacity?n.content_bg_opacity:.3,r=o?`rgba(0, 0, 0, ${a})`:`rgba(255, 255, 255, ${a})`;e.style.backgroundColor=r,e.style.backdropFilter=`blur(${t}px)`,e.style.borderRadius="8px",e.style.margin="5px",e.style.padding="10px",e.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",e.style.transition="backdrop-filter 0.3s ease, background-color 0.3s ease"}}),(t.length>0||a.length>0)&&console.log("[微博背景] 已应用半透明效果到微博容器")}e.forEach(e=>{if(e){const n=window.getComputedStyle(e);e.dataset.origPosition||(e.dataset.origPosition=n.position),e.dataset.origZIndex||(e.dataset.origZIndex=n.zIndex),e.dataset.origBgColor||(e.dataset.origBgColor=n.backgroundColor),e.style.position="relative",e.style.zIndex="1";const t=n.backgroundColor;if(t&&"transparent"!==t&&!t.includes("rgba")){const n=t.match(/\d+/g);n&&n.length>=3&&(e.style.backgroundColor=`rgba(${n[0]}, ${n[1]}, ${n[2]}, 0.5)`,console.log(`[微博背景] 调整了容器背景色: ${t} -> rgba(${n[0]}, ${n[1]}, ${n[2]}, 0.5)`))}console.log("[微博背景] 已应用样式到容器:",e)}});document.querySelectorAll("body > div").forEach(e=>{if("weibo-blur-background"!==e.id){const n=window.getComputedStyle(e);"fixed"===n.position&&("auto"===n.zIndex||parseInt(n.zIndex)<0)&&(console.log("[微博背景] 发现可能阻止背景显示的元素:",e),e.style.backgroundColor="transparent")}}),document.body.style.position="relative",document.body.style.minHeight="100vh",document.documentElement.style.minHeight="100vh";const t=window.getComputedStyle(document.body).backgroundColor;"transparent"===t||t.includes("rgba")||(document.body.style.backgroundColor="transparent",console.log("[微博背景] 已将body背景设置为透明"))}function G(){const e="weibo-content-transparency-style";if(!n.enabled||!n.content_transparency){const n=document.getElementById(e);return void(n&&(n.remove(),console.log("[微博背景] 已移除微博内容模糊样式")))}let t=document.getElementById(e);t||(t=document.createElement("style"),t.id=e,document.head.appendChild(t));const o=n.content_blur||5,a=void 0!==n.content_bg_opacity?n.content_bg_opacity:.3;t.textContent=`\n        /* 默认浅色模式 - 微博Feed容器 - 整体article元素背景模糊 */\n        #scroller > div.vue-recycle-scroller__item-wrapper > div > div > article,\n        #scroller > div.vue-recycle-scroller__item-wrapper > div:nth-child(n) > div > article {\n            background-color: rgba(255, 255, 255, ${a}) !important;\n            backdrop-filter: blur(${o}px) !important;\n            border-radius: 8px !important;\n            margin: 5px 0 !important;\n            padding: 10px !important;\n            transition: backdrop-filter 0.3s ease, background-color 0.3s ease !important;\n            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05) !important;\n        }\n        \n        /* 微博Feed内容 - 内部容器保持透明 */\n        .wbpro-feed-content {\n            background-color: transparent !important;\n            border-radius: 0 !important;\n            padding: 8px !important;\n            box-shadow: none !important;\n        }\n        \n        /* 具体的长选择器 - 完全匹配原始选择器内容 */\n        #scroller > div.vue-recycle-scroller__item-wrapper > div > div > article > div.Feed_body_3R0rO > div.wbpro-feed-content {\n            background-color: transparent !important;\n            border-radius: 0 !important;\n        }\n        \n        /* Feed容器的通用选择器 - 内部容器保持透明 */\n        article div[class*="feed-content"],\n        article div[class*="Feed_body"] > div {\n            background-color: transparent !important;\n            box-shadow: none !important;\n        }\n        \n        /* 默认浅色模式 - 其他微博样式 */\n        .wb-item .content,\n        .card-wrap .card-feed {\n            background-color: rgba(255, 255, 255, ${a}) !important;\n            backdrop-filter: blur(${o}px) !important;\n            border-radius: 8px !important;\n            margin: 5px !important;\n            padding: 10px !important;\n            transition: backdrop-filter 0.3s ease, background-color 0.3s ease !important;\n        }\n          \n        /* 深色模式适配 - 整体容器 */\n        html.woo-theme-dark #scroller > div.vue-recycle-scroller__item-wrapper > div > div > article,\n        html.woo-theme-dark #scroller > div.vue-recycle-scroller__item-wrapper > div:nth-child(n) > div > article {\n            background-color: rgba(0, 0, 0, ${a}) !important;\n            backdrop-filter: blur(${o}px) !important;\n            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;\n        }\n        \n        /* 深色模式适配 - 内部容器 */\n        html.woo-theme-dark .wbpro-feed-content,\n        html.woo-theme-dark article div[class*="feed-content"],\n        html.woo-theme-dark article div[class*="Feed_body"] > div {\n            background-color: transparent !important;\n            box-shadow: none !important;\n        }\n          \n        /* 深色模式适配 - 其他容器 */\n        html.woo-theme-dark .wb-item .content,\n        html.woo-theme-dark .card-wrap .card-feed {\n            background-color: rgba(0, 0, 0, ${a}) !important;\n            backdrop-filter: blur(${o}px) !important;\n            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2) !important;\n        }\n    `,console.log("[微博背景] 已添加微博内容半透明样式 - 模糊度:",o,"px, 不透明度:",a),function(){window.__weiboContentObserver&&(window.__weiboContentObserver.disconnect(),window.__weiboContentObserver=null);if(!n.enabled||!n.content_transparency)return;const e=new MutationObserver(e=>{let t=!1;for(const o of e)if(o.addedNodes&&o.addedNodes.length>0)for(const e of o.addedNodes)if(e.nodeType===Node.ELEMENT_NODE){const o=e.querySelectorAll("article, #scroller > div.vue-recycle-scroller__item-wrapper > div > div > article");o.length>0&&(t=!0,o.forEach(e=>{const t=n.content_blur||5,o=document.documentElement.classList.contains("woo-theme-dark"),a=void 0!==n.content_bg_opacity?n.content_bg_opacity:.3,r=o?`rgba(0, 0, 0, ${a})`:`rgba(255, 255, 255, ${a})`,c=e.dataset.appliedBlur,i=e.dataset.appliedOpacity;if(!c||parseInt(c)!==t||!i||parseFloat(i)!==a){console.log("[微博背景] 更新文章容器样式 - 模糊度:",t,"不透明度:",a),e.style.backgroundColor=r,e.style.backdropFilter=`blur(${t}px)`,e.style.borderRadius="8px",e.style.margin="5px 0",e.style.padding="10px",e.style.transition="backdrop-filter 0.3s ease, background-color 0.3s ease",e.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)";e.querySelectorAll('.wbpro-feed-content, [class*="feed-content"], [class*="Feed_body"] > div').forEach(e=>{e.style.backgroundColor="transparent",e.style.boxShadow="none",e.style.borderRadius="0"}),e.dataset.appliedBlur=t.toString(),e.dataset.appliedOpacity=a.toString()}}));const a=e.querySelectorAll(".wb-item .content, .card-wrap .card-feed");a.length>0&&(t=!0,a.forEach(e=>{const t=n.content_blur||5,o=document.documentElement.classList.contains("woo-theme-dark"),a=void 0!==n.content_bg_opacity?n.content_bg_opacity:.3,r=o?`rgba(0, 0, 0, ${a})`:`rgba(255, 255, 255, ${a})`,c=e.dataset.appliedBlur,i=e.dataset.appliedOpacity;c&&parseInt(c)===t&&i&&parseFloat(i)===a||(e.style.backgroundColor=r,e.style.backdropFilter=`blur(${t}px)`,e.style.borderRadius="8px",e.style.margin="5px",e.style.padding="10px",e.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",e.style.transition="backdrop-filter 0.3s ease, background-color 0.3s ease",e.dataset.appliedBlur=t.toString(),e.dataset.appliedOpacity=a.toString())}))}t&&(console.log("[微博背景] 检测到新内容，重新应用容器样式"),A())}),t={childList:!0,subtree:!0,attributes:!1};e.observe(document.body,t),window.__weiboContentObserver=e,console.log("[微博背景] 已设置内容观察器")}()}function N(e){
/**
 * 设置内容的模糊程度
 * @param {number} blurValue 模糊值，0-1之间，将被转换为0-20px的模糊度
 * @returns {boolean} 是否设置成功
 */
return function(e){if("number"!=typeof e||e<0||e>1)return console.error("[微博背景] 无效的模糊度值:",e),!1;const t=Math.round(20*e);if(n.content_blur=t,n.content_opacity=e,o(),console.log(`[微博背景] 内容模糊度已设置为: ${t}px (透明度值: ${e})`),G(),n.enabled&&n.content_transparency)try{const e=document.querySelectorAll("article, #scroller > div.vue-recycle-scroller__item-wrapper > div > div > article"),o=(document.documentElement.classList.contains("woo-theme-dark"),void 0!==n.content_bg_opacity&&n.content_bg_opacity,`blur(${t}px)`);e.forEach(e=>{e&&(e.style.backdropFilter=o,e.dataset.appliedBlur=t.toString())});const a=document.querySelectorAll(".wb-item .content, .card-wrap .card-feed");a.forEach(e=>{e&&(e.style.backdropFilter=o,e.dataset.appliedBlur=t.toString())}),console.log(`[微博背景] 已更新 ${e.length+a.length} 个元素的模糊度`)}catch(e){console.error("[微博背景] 更新DOM元素模糊度时出错:",e)}return t%2==0&&l(`博文模糊度: ${t}px`),!0}(e)}
/**
 * 设置内容背景的不透明度
 * @param {number} opacityValue 不透明度值，0-1之间
 * @returns {boolean} 是否设置成功
 */function R(){const a=document.querySelector(".weibo-enhance-panel");if(a)return a.style.display=e.ui_visible?"":"none",a;if(!document.querySelector("#weibo-enhance-panel-style")){const e=document.createElement("style");e.id="weibo-enhance-panel-style",e.textContent='\n.weibo-enhance-panel {\n    position: fixed;\n    top: 50%;\n    right: 20px;\n    transform: translateY(-50%);\n    background: var(--panel-bg, #ffffff);\n    border: 1px solid var(--panel-border, #e1e8ed);\n    border-radius: 12px;\n    box-shadow: 0 4px 20px rgba(0,0,0,0.1);\n    padding: 16px;\n    min-width: 240px; /* 增加宽度以确保所有控件有足够空间显示 */\n    /* 添加过渡效果，使方向变化平滑 */\n    transition: transform 0.3s ease, left 0.3s ease, right 0.3s ease;\n    opacity: 0.9;\n    transition: opacity 0.3s ease, transform 0.3s ease, background 0.3s ease;\n    z-index: 999;\n    font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n    cursor: move; /* 表明面板可拖动 */\n    user-select: none; /* 防止拖动时选中文字 */\n}\n\n.weibo-enhance-panel:hover {\n    opacity: 1;\n}\n\n/* 缩小的齿轮图标状态 */\n.weibo-enhance-panel.collapsed {\n    min-width: unset;\n    width: 42px;\n    height: 42px;\n    border-radius: 50%;\n    padding: 0;\n    background: #1890ff;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    box-shadow: 0 4px 10px rgba(0,0,0,0.2);\n    opacity: 0.8;\n    border: none;\n    transform: translateY(-50%) scale(1);\n    transition: all 0.3s ease;\n}\n\n.weibo-enhance-panel.collapsed:hover {\n    transform: translateY(-50%) scale(1.1);\n    opacity: 1;\n}\n\n/* 面板内容容器 */\n.panel-content {\n    width: 100%;\n    opacity: 1;\n    transition: opacity 0.3s ease;\n}\n\n.weibo-enhance-panel.collapsed .panel-content {\n    display: none;\n}\n\n/* 齿轮图标 */\n.panel-gear-icon {\n    display: none; /* 默认隐藏 */\n    color: white;\n    font-size: 22px;\n    animation: spin 10s linear infinite;\n}\n\n@keyframes spin {\n    0% { transform: rotate(0deg); }\n    100% { transform: rotate(360deg); }\n}\n\n.weibo-enhance-panel.collapsed .panel-gear-icon {\n    display: block;\n}\n\n/* 关闭按钮 */\n.panel-close-btn {\n    background: none;\n    border: none;\n    color: var(--panel-text-secondary, #666);\n    cursor: pointer;\n    font-size: 14px;\n    line-height: 1;\n    padding: 8px 12px;\n    opacity: 0.8;\n    transition: opacity 0.2s ease, transform 0.2s ease;\n    border-radius: 6px;\n}\n\n.panel-close-btn:hover {\n    opacity: 1;\n    background: var(--button-hover-bg, #f5f5f5);\n    color: var(--button-text, #333);\n}\n\n/* 折叠/展开按钮 */\n.panel-toggle-btn {\n    background: var(--button-bg, #fff);\n    border: 1px solid var(--button-border, #ddd);\n    border-radius: 6px;\n    color: var(--button-text, #333);\n    cursor: pointer;\n    font-size: 12px;\n    padding: 8px 12px;\n    opacity: 0.8;\n    transition: opacity 0.2s ease;\n}\n\n.panel-toggle-btn:hover {\n    opacity: 1;\n    background: var(--button-hover-bg, #f5f5f5);\n}\n\n.weibo-enhance-panel h3 {\n    margin: 0 0 12px 0;\n    font-size: 14px;\n    font-weight: 600;\n    color: var(--panel-text, #333);\n    text-align: center;\n    border-bottom: 1px solid var(--panel-border, #e1e8ed);\n    padding-bottom: 8px;\n}\n\n.weibo-enhance-panel .control-group {\n    margin-bottom: 16px;\n    width: 100%;\n    overflow: visible; /* 确保子元素溢出不会被裁剪 */\n    display: block; /* 保证显示为块级元素 */\n}\n\n.weibo-enhance-panel .control-group:last-child {\n    margin-bottom: 0;\n}\n\n.weibo-enhance-panel .control-title {\n    font-size: 12px;\n    color: var(--panel-text-secondary, #666);\n    margin-bottom: 6px;\n    font-weight: 500;\n}\n\n.weibo-enhance-panel button {\n    width: 100%;\n    padding: 8px 12px;\n    border: 1px solid var(--button-border, #ddd);\n    border-radius: 6px;\n    background: var(--button-bg, #fff);\n    color: var(--button-text, #333);\n    cursor: pointer;\n    font-size: 12px;\n    transition: all 0.2s ease;\n    margin-bottom: 4px;\n}\n\n.weibo-enhance-panel button:hover {\n    background: var(--button-hover-bg, #f5f5f5);\n    border-color: var(--button-hover-border, #bbb);\n}\n\n.weibo-enhance-panel button.active {\n    background: var(--button-active-bg, #1890ff);\n    color: white;\n    border-color: var(--button-active-bg, #1890ff);\n}\n\n.weibo-enhance-panel .checkbox-control {\n    display: flex;\n    align-items: center;\n    padding: 6px;\n    margin-bottom: 4px;\n    border-radius: 4px;\n    cursor: pointer;\n    transition: background 0.2s ease;\n}\n\n.weibo-enhance-panel .checkbox-control:hover {\n    background: var(--checkbox-hover-bg, #f5f5f5);\n}\n\n.weibo-enhance-panel .checkbox-control input {\n    margin-right: 8px;\n}\n\n.weibo-enhance-panel .checkbox-control label {\n    font-size: 12px;\n    color: var(--panel-text, #333);\n    cursor: pointer;\n    margin: 0;\n}\n\n/* 滑块控件样式 */\n.weibo-enhance-panel .range-control {\n    margin-top: 8px;\n    width: 100%;\n}\n\n.weibo-enhance-panel .range-control label {\n    display: block;\n    font-size: 12px;\n    color: var(--panel-text, #333);\n    margin-bottom: 6px;\n}\n\n.weibo-enhance-panel .range-control input[type="range"] {\n    width: 100%;\n    height: 5px;\n    border-radius: 5px;\n    background: var(--panel-border, #e1e8ed);\n    outline: none;\n    opacity: 0.7;\n    -webkit-transition: opacity .2s;\n    transition: opacity .2s;\n}\n\n.weibo-enhance-panel .range-control input[type="range"]:hover {\n    opacity: 1;\n}\n\n.weibo-enhance-panel .range-control input[type="range"]::-webkit-slider-thumb {\n    -webkit-appearance: none;\n    appearance: none;\n    width: 15px;\n    height: 15px;\n    border-radius: 50%;\n    background: var(--button-active-bg, #1890ff);\n    cursor: pointer;\n}\n\n.weibo-enhance-panel .range-control input[type="range"]::-moz-range-thumb {\n    width: 15px;\n    height: 15px;\n    border-radius: 50%;\n    background: var(--button-active-bg, #1890ff);\n    cursor: pointer;\n}\n\n/* 深色模式样式 */\nbody.woo-theme-dark .weibo-enhance-panel {\n    --panel-bg: #2f3349;\n    --panel-border: #484b6a;\n    --panel-text: #ffffff;\n    --panel-text-secondary: #b3b3b3;\n    --button-bg: #404466;\n    --button-text: #ffffff;\n    --button-border: #484b6a;\n    --button-hover-bg: #4a4f73;\n    --button-hover-border: #5a5f83;\n    --button-active-bg: #1890ff;\n    --checkbox-hover-bg: #404466;\n}\n\n/* 浅色模式样式 */\nbody.woo-theme-light .weibo-enhance-panel {\n    --panel-bg: #ffffff;\n    --panel-border: #e1e8ed;\n    --panel-text: #333333;\n    --panel-text-secondary: #666666;\n    --button-bg: #ffffff;\n    --button-text: #333333;\n    --button-border: #dddddd;\n    --button-hover-bg: #f5f5f5;\n    --button-hover-border: #bbbbbb;\n    --button-active-bg: #1890ff;\n    --checkbox-hover-bg: #f5f5f5;\n}\n\n.weibo-enhance-panel .status-indicator {\n    display: inline-block;\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n    margin-right: 6px;\n}\n\n.weibo-enhance-panel .status-indicator.on {\n    background: #52c41a;\n}\n\n.weibo-enhance-panel .status-indicator.off {\n    background: #f5222d;\n}\n\n/* 拖动结束后暂时禁用点击 */\n.weibo-enhance-panel.dragging-ended {\n    pointer-events: none;\n}\n\n/* 边缘展开方向控制 */\n.weibo-enhance-panel.expand-left {\n    right: auto;\n    left: 20px;\n}\n\n.weibo-enhance-panel.expand-right {\n    left: auto;\n    right: 20px;\n}\n\n/* 确保模糊控制组正确显示 */\n#blur-control-group {\n    display: block !important;\n    visibility: visible !important;\n    opacity: 1 !important;\n    height: auto !important;\n}\n\n/* 子控制组样式 */\n.weibo-enhance-panel .sub-control-group {\n    margin-top: 12px;\n    padding: 8px;\n    border: 1px solid var(--panel-border, #e1e8ed);\n    border-radius: 6px;\n    background-color: var(--panel-secondary-bg, rgba(245, 245, 245, 0.5));\n}\n\n.weibo-enhance-panel .sub-control-title {\n    font-size: 11px;\n    color: var(--panel-text-secondary, #666);\n    margin-bottom: 8px;\n    font-weight: 500;\n}\n\n/* 单选框样式 */\n.weibo-enhance-panel .radio-control {\n    display: flex;\n    flex-wrap: wrap;\n    margin-bottom: 8px;\n}\n\n.weibo-enhance-panel .radio-control input[type="radio"] {\n    margin-right: 5px;\n}\n\n.weibo-enhance-panel .radio-control label {\n    margin-right: 12px;\n    font-size: 12px;\n    color: var(--panel-text, #333);\n    cursor: pointer;\n    flex: 0 0 auto;\n}\n\n/* 小按钮样式 */\n.weibo-enhance-panel .small-button {\n    font-size: 12px;\n    padding: 5px 10px;\n    margin: 5px 0;\n    background: var(--button-secondary-bg, #f0f7ff);\n    border: 1px solid var(--button-secondary-border, #95bfff);\n    color: var(--button-secondary-text, #1890ff);\n    border-radius: 4px;\n    cursor: pointer;\n    transition: all 0.2s;\n}\n\n.weibo-enhance-panel .small-button:hover {\n    background: var(--button-secondary-hover-bg, #e6f2ff);\n    border-color: var(--button-secondary-hover-border, #69a2ff);\n}\n',document.head.appendChild(e)}if(!e.ui_visible)return null;const c=document.createElement("div");c.className="weibo-enhance-panel"+(e.panel_expanded?"":" collapsed"),e.panel_position&&(c.style.top=e.panel_position.top,c.style.right=e.panel_position.right,c.style.transform="none");let i=`\n    <div class="panel-content">\n      <h3>微博增强</h3>\n      \n      <div class="control-group">\n        <div class="control-title">宽屏功能</div>\n        <button id="widescreen-toggle" class="${e.enabled?"active":""}">\n          <span class="status-indicator ${e.enabled?"on":"off"}"></span>\n          ${e.enabled?"已开启":"已关闭"}\n        </button>\n        ${e.enabled?`\n          <div class="checkbox-control">\n            <input type="checkbox" id="loose-mode" ${e.loose?"checked":""}>\n            <label for="loose-mode">更宽模式</label>\n          </div>\n        `:""}\n      </div>\n        <div class="control-group">\n        <div class="control-title">主题切换</div>\n        <button id="theme-toggle">\n          <span class="status-indicator ${x()?"on":"off"}"></span>\n          切换主题\n        </button>\n        <button id="theme-reset">重置跟随</button>      </div>\n        <div class="control-group" id="background-control-group">\n        <div class="control-title">背景设置</div>\n        <button id="background-toggle" class="${n.enabled?"active":""}">\n          <span class="status-indicator ${n.enabled?"on":"off"}"></span>\n          ${n.enabled?"已开启":"已关闭"}\n        </button>\n        ${n.enabled?`\n          <div class="radio-control">\n            <input type="radio" id="bing-background" name="background-type" ${"bing"===n.type?"checked":""}>\n            <label for="bing-background">必应每日图片</label>\n            \n            <input type="radio" id="custom-background" name="background-type" ${"custom"===n.type?"checked":""}>\n            <label for="custom-background">自定义图片</label>\n          </div>\n          \n          ${"custom"===n.type?'\n            <button id="upload-background" class="small-button">上传图片</button>\n          ':""}\n            <div class="range-control">\n            <label for="background-opacity">背景不透明度: ${Math.round(100*n.opacity)}%</label>\n            <input type="range" id="background-opacity" min="1" max="100" value="${Math.round(100*n.opacity)}">          </div>\n            <div class="checkbox-control" id="content-transparency-container">\n            <input type="checkbox" id="content-transparency-toggle" ${n.content_transparency?"checked":""}>\n            <label for="content-transparency-toggle">微博内容半透明</label>\n          </div>\n          \n          ${n.content_transparency?`\n          <div class="range-control" id="content-opacity-container">\n            <label for="content-opacity">内容不透明度: ${Math.round(100*n.content_opacity)}%</label>\n            <input type="range" id="content-opacity" min="20" max="95" value="${Math.round(100*n.content_opacity)}">\n          </div>\n          `:""}\n        `:""}\n      </div>\n      \n      <div class="control-group">\n        <div class="control-title">其他功能</div>\n        <div class="checkbox-control">\n          <input type="checkbox" id="notification-toggle" ${e.notify_enabled?"checked":""}>\n          <label for="notification-toggle">启用通知</label>\n        </div>\n      </div>\n      \n      <div class="control-group">\n        <div class="control-title">面板控制</div>\n        <button class="panel-toggle-btn">收起面板</button>\n        <button class="panel-close-btn">关闭面板</button>\n      </div>\n    </div>\n  `;return c.innerHTML='<div class="panel-gear-icon">⚙️</div>'+i,function(a){const c=a.querySelector("#widescreen-toggle");c&&c.addEventListener("click",()=>{e.enabled=!e.enabled,t(),c.className=e.enabled?"active":"";const n=c.querySelector(".status-indicator");n&&(n.className="status-indicator "+(e.enabled?"on":"off"));const o=document.createTextNode(e.enabled?"已开启":"已关闭");c.innerHTML="",n&&c.appendChild(n.cloneNode(!0)),c.appendChild(o),l(e.enabled?"宽屏模式已启用，即将刷新页面":"宽屏模式已关闭，即将刷新页面"),setTimeout(()=>{window.location.reload()},500)});const i=a.querySelector("#background-toggle");i&&i.addEventListener("click",()=>{const e=T();console.log("[微博增强] 背景状态切换为:",e?"开启":"关闭"),i.className=e?"active":"";const t=i.querySelector(".status-indicator");t&&(t.className="status-indicator "+(e?"on":"off"));const a=document.createTextNode(e?"已开启":"已关闭");i.innerHTML="",t&&i.appendChild(t.cloneNode(!0)),i.appendChild(a);const r=i.closest(".control-group");if(r){if(r.querySelectorAll(".radio-control, .range-control, button.small-button, .checkbox-control").forEach(e=>e.remove()),e){const e=document.createElement("div");if(e.className="radio-control",e.innerHTML=`\n            <input type="radio" id="bing-background" name="background-type" ${"bing"===n.type?"checked":""}>\n            <label for="bing-background">必应每日图片</label>\n            \n            <input type="radio" id="custom-background" name="background-type" ${"custom"===n.type?"checked":""}>\n            <label for="custom-background">自定义图片</label>\n          `,r.appendChild(e),"custom"===n.type){const e=document.createElement("button");e.id="upload-background",e.className="small-button",e.textContent="上传图片",r.appendChild(e)}const t=document.createElement("div");t.className="range-control",t.innerHTML=`\n            <label for="background-opacity">背景不透明度: ${Math.round(100*n.opacity)}%</label>\n            <input type="range" id="background-opacity" min="1" max="100" value="${Math.round(100*n.opacity)}">\n          `,r.appendChild(t);const a=document.createElement("div");if(a.className="checkbox-control",a.id="content-transparency-container",a.innerHTML=`\n            <input type="checkbox" id="content-transparency-toggle" ${n.content_transparency?"checked":""}>\n            <label for="content-transparency-toggle">微博内容半透明</label>\n          `,r.appendChild(a),n.content_transparency){const e=document.createElement("div");e.className="range-control",e.id="content-opacity-container",e.innerHTML=`\n                <label for="content-opacity">内容不透明度: ${Math.round(100*n.content_opacity)}%</label>\n                <input type="range" id="content-opacity" min="20" max="95" value="${Math.round(100*n.content_opacity)}">\n              `,r.appendChild(e)}!function(e){const t=e.querySelector("#bing-background"),a=e.querySelector("#custom-background");t&&t.addEventListener("change",e=>{if(e.target.checked)try{S("bing"),B(),l("已切换到必应每日图片背景")}catch(e){console.error("[微博增强] 切换背景类型出错:",e),l("切换背景类型出错，请重试")}});a&&a.addEventListener("change",e=>{if(e.target.checked)try{S("custom"),B(),l("已切换到自定义图片背景")}catch(e){console.error("[微博增强] 切换背景类型出错:",e),l("切换背景类型出错，请重试")}});const r=e.querySelector("#upload-background");r&&r.addEventListener("click",async()=>{r.disabled=!0,r.textContent="上传中...";try{await q()?(r.textContent="上传成功",S("custom"),B(),setTimeout(()=>{r.disabled=!1,r.textContent="重新上传"},1500)):(r.textContent="上传取消",setTimeout(()=>{r.disabled=!1,r.textContent="上传图片"},1e3))}catch(e){r.textContent="上传失败",setTimeout(()=>{r.disabled=!1,r.textContent="重试上传"},1e3)}});const c=e.querySelector("#background-opacity");c&&c.addEventListener("input",e=>{const t=parseInt(e.target.value,10)/100;!function(e){try{const t=Math.max(0,Math.min(1,e)),a=n.opacity;n.opacity=t,o(),console.log(`[微博背景] 设置透明度: ${a} -> ${t}`);const r=document.getElementById("weibo-blur-background");if(!r)return console.warn("[微博背景] 找不到背景元素，无法设置透明度，尝试重新应用背景"),void setTimeout(()=>{try{B()}catch(e){console.error("[微博背景] 重新应用背景失败:",e)}},100);console.log("[微博背景] 直接更新背景不透明度:",t);try{r.style.setProperty("opacity",String(t),"important");const e="weibo-bg-opacity-styles";let n=document.getElementById(e);n||(n=document.createElement("style"),n.id=e,document.head.appendChild(n));const o=`weibo-bg-opacity-${Date.now()}`;r.classList.add(o),r.className.split(" ").forEach(e=>{e!==o&&e.startsWith("weibo-bg-opacity-")&&r.classList.remove(e)}),n.textContent=`\n                #weibo-blur-background.${o} {\n                    opacity: ${t} !important;\n                    filter: opacity(${100*t}%) !important;\n                }\n            `,requestAnimationFrame(()=>{r.style.opacity=String(t),r.style.filter=`opacity(${100*t}%)`,r.offsetHeight}),setTimeout(()=>{const e=window.getComputedStyle(r).opacity;console.log(`[微博背景] 透明度设置后的计算样式: ${e}`),Math.abs(parseFloat(e)-t)>.01&&(console.log("[微博背景] 检测到透明度未正确应用，尝试强制重绘"),r.style.display="none",r.offsetHeight,r.style.display="block",r.style.setProperty("opacity",String(t),"important"))},50),Math.round(100*t)%10==0&&l(`背景不透明度: ${Math.round(100*t)}%`)}catch(e){console.error("[微博背景] 设置透明度详细步骤失败:",e);try{r.style.opacity=String(t)}catch(e){console.error("[微博背景] 简单设置透明度也失败:",e),setTimeout(()=>B(),100)}}}catch(e){console.error("[微博背景] 设置透明度整体操作失败:",e),setTimeout(()=>{try{B()}catch(e){console.error("[微博背景] 错误处理中重新应用背景失败:",e)}},100)}}(t);const a=c.parentElement.querySelector("label");a&&(a.textContent=`背景不透明度: ${Math.round(100*t)}%`)});const i=e.querySelector("#clear-bing-cache");i&&i.addEventListener("click",()=>{try{(function(){try{return console.log("[微博背景] 正在清除必应图片缓存"),GM_setValue(j,null),l("已清除背景图片缓存，将重新获取最新图片"),setTimeout(()=>{"bing"===n.type&&B()},500),!0}catch(e){return console.error("[微博背景] 清除缓存失败:",e),l("清除缓存失败，请尝试刷新页面"),!1}})()?(i.textContent="缓存已清除",i.disabled=!0,setTimeout(()=>{i.disabled=!1,i.textContent="清除图片缓存"},1500)):l("清除缓存失败，请重试")}catch(e){l("清除缓存时发生错误")}});const s=e.querySelector("#content-transparency-toggle");s&&(s.removeEventListener("change",W),s.addEventListener("change",W));const d=e.querySelector("#content-opacity");d&&(d.removeEventListener("input",F),d.addEventListener("input",F))}(r)}}l(e?"背景功能已启用":"背景功能已关闭")});const s=a.querySelector("#loose-mode");s&&s.addEventListener("change",n=>{e.loose=n.target.checked,t(),document.documentElement.classList.toggle("inject-widescreen-loose-js",e.loose),document.body.classList.toggle("inject-widescreen-loose-js",e.loose);let o=document.getElementById("weibo-widescreen-loose-style");e.loose?o||(o=document.createElement("style"),o.id="weibo-widescreen-loose-style",document.head.appendChild(o),o.textContent="\n/* 用户自定义宽度设置 - 更宽模式 */\n:root.inject-widescreen-loose-js {\n  --inject-page-width: 95vw !important;\n  --inject-page-width-legacy: 95vw !important;\n}\n\nbody.inject-widescreen-loose-js {\n  --inject-page-width: 95vw !important;\n  --inject-page-width-legacy: 95vw !important;\n}\n\n/* 更宽模式下的特殊调整 */\n.inject-widescreen-loose-js [class*=Frame_content],\n.inject-widescreen-loose-js [class*=Frame_content2] {\n  width: var(--inject-page-width) !important;\n  max-width: var(--inject-page-width) !important;\n}\n\n.inject-widescreen-loose-js .WB_frame {\n  width: var(--inject-page-width-legacy) !important;\n}\n\n/* 确保返回顶部按钮位置正确 */\n.inject-widescreen-loose-js [class*=Index_backTop] {\n  left: calc(50% + var(--inject-page-width)/2 + 10px);\n}\n\n.inject-widescreen-loose-js .W_gotop {\n  left: calc(50% + var(--inject-page-width-legacy)/2 + 10px);\n}"):o&&o.remove(),document.querySelectorAll("iframe").forEach(n=>{try{const t=n.contentDocument||n.contentWindow.document;if(t){t.documentElement.classList.toggle("inject-widescreen-loose-js",e.loose),t.body&&t.body.classList.toggle("inject-widescreen-loose-js",e.loose);let n=t.getElementById("weibo-widescreen-loose-style");e.loose?(n||(n=t.createElement("style"),n.id="weibo-widescreen-loose-style",t.head.appendChild(n)),n.textContent=o?o.textContent:""):n&&n.remove()}}catch(e){}});const a=new CustomEvent("widescreenChange",{detail:{enabled:!0,loose:e.loose}});document.dispatchEvent(a),l(`已切换为${e.loose?"更宽":"标准"}宽屏模式`)});const d=a.querySelector("#theme-toggle");d&&d.addEventListener("click",()=>{const e=!x();r(!0,e),_(e,!0),l(e?"已切换到深色模式":"已切换到浅色模式");const n=d.querySelector(".status-indicator");n&&setTimeout(()=>{const e=x();n.className="status-indicator "+(e?"on":"off")},300)});const u=a.querySelector("#theme-reset");u&&u.addEventListener("click",()=>{r(!1,null);_(window.matchMedia("(prefers-color-scheme: dark)").matches,!0),l("已恢复跟随系统主题");const e=a.querySelector("#theme-toggle");e&&setTimeout(()=>{const n=x(),t=e.querySelector(".status-indicator");t&&(t.className="status-indicator "+(n?"on":"off"))},300)});const p=a.querySelector("#notification-toggle");p&&p.addEventListener("change",n=>{e.notify_enabled=n.target.checked,t(),e.notify_enabled?l("通知已启用"):console.log("[微博增强] 通知已禁用")});a.addEventListener("click",e=>{a.classList.contains("collapsed")&&V(a,!1)});const m=a.querySelector(".panel-toggle-btn");m&&m.addEventListener("click",e=>{e.stopPropagation(),V(a,!0),l("面板已收起，点击齿轮图标可重新展开")});const b=a.querySelector(".panel-close-btn");b&&b.addEventListener("click",()=>{e.ui_visible=!1,t(),a.style.display="none",l("控制面板已关闭，可通过Tampermonkey菜单重新打开")})}(c),function(n){let o=0,a=0,r=!1,c=!1,i=0,l=0;n.addEventListener("mousedown",function(e){"BUTTON"!==e.target.tagName&&"INPUT"!==e.target.tagName&&"LABEL"!==e.target.tagName&&(r=!0,i=e.clientX,l=e.clientY,c=!1,o=e.clientX-n.getBoundingClientRect().left,a=e.clientY-n.getBoundingClientRect().top,n.style.transition="none",n.style.cursor="grabbing")}),document.addEventListener("mousemove",function(e){if(!r)return;const t=Math.abs(e.clientX-i),s=Math.abs(e.clientY-l);(t>3||s>3)&&(c=!0);const d=e.clientX-o,u=e.clientY-a,p=window.innerWidth-n.offsetWidth,m=window.innerHeight-n.offsetHeight,b=Math.min(Math.max(0,d),p),g=Math.min(Math.max(0,u),m);n.style.left=b+"px",n.style.top=g+"px",n.style.right="auto",n.style.transform="none",e.preventDefault()}),document.addEventListener("mouseup",function(o){if(!r)return;r=!1,n.style.cursor="move",n.style.transition="opacity 0.3s ease, transform 0.3s ease, background 0.3s ease";const a=Math.abs(o.clientX-i),s=Math.abs(o.clientY-l);c=a>5||s>5;const d=n.getBoundingClientRect();e.panel_position={top:d.top+"px",right:window.innerWidth-d.right+"px"},t(),c&&(n.classList.add("dragging-ended"),setTimeout(()=>{n.classList.remove("dragging-ended")},100))}),n.addEventListener("mouseleave",function(){r&&(r=!1)})}(c),function(e){let n;e.addEventListener("mouseenter",()=>{clearTimeout(n)}),e.addEventListener("mouseleave",()=>{e.classList.contains("collapsed")||(n=setTimeout(()=>{V(e,!0)},5e3))})}(c),document.body.appendChild(c),c}function W(e){const t=e.target.checked;try{n.content_transparency=t,o(),B();const a=e.target.closest(".control-group");if(a){let o=a.querySelector("#content-opacity-container");if(t)if(o)o.style.display="";else{o=document.createElement("div"),o.className="range-control",o.id="content-opacity-container",o.innerHTML=`\n            <label for="content-opacity">内容不透明度: ${Math.round(100*n.content_opacity)}%</label>\n            <input type="range" id="content-opacity" min="20" max="95" value="${Math.round(100*n.content_opacity)}">\n          `;const t=e.target.closest("#content-transparency-container");if(t&&!a.querySelector("#content-opacity-container")){t.nextSibling?a.insertBefore(o,t.nextSibling):a.appendChild(o);const e=o.querySelector("#content-opacity");e&&e.addEventListener("input",F)}}else!t&&o&&(o.style.display="none")}l(t?"微博内容半透明已启用":"微博内容半透明已关闭"),console.log("[微博增强] 微博内容半透明: "+(t?"开启":"关闭"))}catch(e){console.error("[微博增强] 切换内容半透明设置失败:",e),l("设置内容半透明失败")}}function F(e){const n=parseInt(e.target.value,10)/100;try{N(n);const t=e.target.parentElement.querySelector("label");t&&(t.textContent=`内容不透明度: ${Math.round(100*n)}%`)}catch(e){console.error("[微博增强] 设置内容透明度失败:",e)}}function V(n,o){if(console.log("切换面板状态: "+(o?"收起":"展开")),o)n.classList.add("collapsed"),e.panel_expanded=!1,console.log("面板已收起");else{const t=n.getBoundingClientRect(),o=window.innerWidth;window.innerHeight,n.offsetWidth,n.offsetHeight;n.classList.remove("expand-left","expand-right"),t.right>o-100?n.classList.add("expand-left"):n.classList.add("expand-right"),n.classList.remove("collapsed"),e.panel_expanded=!0,console.log("面板已展开")}t()}function z(){v(),B(),console.log("[微博增强] 背景功能初始化完成"),L(),function(){d(),document.addEventListener("widescreenChange",e=>{e.detail&&(console.log("[微博宽屏] 宽屏模式变化:",e.detail),d(!0))});const n=new MutationObserver(t=>{e.enabled&&t.some(n=>"childList"===n.type||"attributes"===n.type&&"class"===n.attributeName&&n.target.classList.contains("inject-widescreen-loose-js")!==e.loose)&&(n.reapplyDebounceTimer||(n.reapplyDebounceTimer=setTimeout(()=>{s(),n.reapplyDebounceTimer=null},1e3)))});n.observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}),setInterval(s,3e4),console.log("[微博宽屏] 宽屏功能初始化完成")}(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(R,300)}):setTimeout(R,500),window.addEventListener("load",()=>{setTimeout(()=>{B()},1e3),e.notify_enabled&&l("微博增强功能已激活")}),console.log("%c[微博增强] 功能已激活","color: #28a745; font-weight: bold;"),window.weiboApplyBackground=B,console.log("%c[微博增强] 如果背景出现问题，请在控制台执行: weiboApplyBackground()","color: #17a2b8; font-style: italic;")}!function(){G(),"loading"===document.readyState&&document.addEventListener("DOMContentLoaded",()=>{G()}),window.addEventListener("load",()=>{setTimeout(()=>{G()},1e3)});const e=window.history.pushState;window.history.pushState=function(){e.apply(this,arguments),setTimeout(()=>{G()},500)}}(),z(),GM_registerMenuCommand("显示/隐藏控制面板",function(){e.ui_visible=!e.ui_visible,t();const n=document.querySelector(".weibo-enhance-panel");n?n.style.display=e.ui_visible?"":"none":e.ui_visible&&R(),l(e.ui_visible?"控制面板已显示":"控制面板已隐藏")}),GM_registerMenuCommand("背景设置",function(){T();const e=document.querySelector(".weibo-enhance-panel");e&&(e.remove(),R()),l(n.enabled?"背景功能已启用":"背景功能已关闭")}),GM_registerMenuCommand("重置所有设置",function(){if(confirm("确定要重置所有设置吗？页面将会刷新。"))try{if(["widescreen_enabled","widescreen_loose","widescreen_notify_enabled","widescreen_ui_visible","widescreen_panel_expanded","widescreen_panel_position","background_enabled","background_type","background_url","background_opacity","background_notify_enabled","userOverride","userThemeMode","weibo_bing_background"].forEach(e=>{console.log(`[微博增强] 正在删除配置项: ${e}`),GM_deleteValue(e)}),"function"==typeof GM_listValues)try{GM_listValues().forEach(e=>{(e.includes("weibo")||e.includes("widescreen")||e.includes("blur"))&&(console.log(`[微博增强] 删除其他相关配置: ${e}`),GM_deleteValue(e))})}catch(e){console.warn("[微博增强] GM_listValues不可用，跳过未知键清理",e)}l("所有设置已完全重置，配置已删除"),setTimeout(()=>{window.location.reload()},1e3)}catch(e){console.error("[微博增强] 重置设置失败:",e),l("重置设置时发生错误，请查看控制台")}})})();